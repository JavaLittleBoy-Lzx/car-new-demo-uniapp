# 访客邀请二维码地址锁定修复说明

## 问题描述

用户反馈：扫描访客邀请二维码后，访问地址应该是**固定的、不可修改的**，但实际情况是地址可以被访客修改。

## 问题原因

通过代码分析发现，访问地址是否锁定的判断条件是：

```javascript
// form.vue #7757
if (this.currentUserRole === 'visitor' && visitorType === 'invited' && hasDetailedAddress) {
    // 受邀访客：有管家邀请码和完整地址 → 锁定地址
    this.isAddressAutoFilled = true;
    this.autoFilledAddressInfo = addressText;
    // ... 地址锁定逻辑
}
```

**关键问题**：二维码生成时缺少 `visitorType=invited` 参数，导致前端无法判断这是受邀访客，从而地址未被锁定。

## 修复方案

### 1. 在二维码URL中添加 `visitorType` 参数

**文件**: `pagesB/butler/qrcode-generator.vue`

**修改位置 1**: 二维码生成函数 (行号 ~2105)

```javascript
// 构建包含详细地址信息和业主信息的URL参数
const shortParams = [];
shortParams.push(`qrId=${encodeURIComponent(qrId)}`);
// ... 其他参数 ...

// 🔒 关键：添加访客类型参数，确保地址被锁定为不可修改
shortParams.push(`visitorType=invited`); // 标记为受邀访客，地址固定不可修改
shortParams.push('t=bi'); // butler_invitation 缩写
shortParams.push(`ts=${Date.now().toString().slice(-8)}`);
```

**修改位置 2**: URL优化简化函数 (行号 ~2641, ~2657)

```javascript
// 🎯 关键修复：保留详细地址信息
const building = urlParams.building || '';
const units = urlParams.units || '';
const floor = urlParams.floor || '';
const room = urlParams.room || '';
const qrId = urlParams.qrId || '';
const visitorType = urlParams.visitorType || ''; // 🔒 保留访客类型参数

// 构建包含详细地址信息的简化参数
const shortParams = [];
// ... 其他参数 ...

// 🔒 关键：保留访客类型参数，确保地址锁定状态不丢失
if (visitorType) shortParams.push(`visitorType=${encodeURIComponent(visitorType)}`);
shortParams.push('t=bi');
shortParams.push(`ts=${Date.now().toString().slice(-8)}`);
```

## 修复效果

### 修复前

访客扫描邀请二维码后：
- ❌ 访问地址可以随意修改
- ❌ 无法区分受邀访客和外来访客
- ❌ 业主预设的地址信息可能被篡改

### 修复后

访客扫描邀请二维码后：
- ✅ 访问地址**固定不可修改**（显示"🔒 此地址通过二维码自动获取，无法修改"）
- ✅ 自动识别为受邀访客（`visitorType=invited`）
- ✅ 确保访客只能预约到管家指定的地址
- ✅ 提升安全性，防止地址信息被篡改

## 技术说明

### 访客类型区分

系统支持两种访客类型：

1. **受邀访客** (`visitorType=invited`)
   - 通过管家生成的邀请二维码扫码进入
   - 访问地址**固定不可修改**
   - 包含完整的地址信息（楼栋、单元、楼层、房间）
   - 可直接查询业主信息

2. **外来访客** (`visitorType=external`)
   - 通过外来访客二维码扫码进入
   - 访问地址**可以选择**
   - 不包含预设地址信息
   - 需要手动选择访问地址

### URL参数结构

完整的访客邀请二维码URL参数：

```
https://xxx.com/pages/auth/phone-auth?
  qrId=xxxx                    # 二维码唯一标识
  &building=2                  # 楼栋
  &unit=1                      # 单元
  &floor=3                     # 楼层
  &room=301                    # 房间号
  &bn=管家姓名                  # 管家姓名
  &bp=13800000000              # 管家电话
  &c=小区名称                   # 小区名称
  &visitorType=invited         # 🔒 访客类型（关键参数）
  &t=bi                        # 类型标识
  &ts=12345678                 # 时间戳
```

## 测试建议

### 测试步骤

1. **管家生成邀请二维码**
   - 登录管家账号
   - 进入二维码生成页面
   - 选择完整地址（楼栋、单元、楼层、房间）
   - 生成访客邀请二维码

2. **访客扫描二维码**
   - 使用访客账号扫描二维码
   - 进入预约表单页面

3. **验证地址锁定状态**
   - ✅ 检查访问地址栏是否显示"🔒 此地址通过二维码自动获取，无法修改"
   - ✅ 确认地址显示为灰色背景的锁定状态
   - ✅ 尝试点击地址选择器，应该无法打开选择器
   - ✅ 验证业主信息自动显示

4. **检查URL参数**
   - 在浏览器控制台查看 URL
   - 确认包含 `visitorType=invited` 参数

### 预期结果

- 访问地址应该是**固定的、不可修改的**
- 页面应显示地址锁定提示
- 业主信息应自动填充并显示

## 修改文件清单

- ✅ `pagesB/butler/qrcode-generator.vue` - 二维码生成页面
  - 在二维码URL中添加 `visitorType=invited` 参数
  - 在URL优化函数中保留 `visitorType` 参数

## 注意事项

1. **向后兼容性**：旧版本生成的二维码（没有 `visitorType` 参数）会被视为外来访客，地址可选
2. **参数验证**：前端会验证 `visitorType` 参数的值，只有 `invited` 才会锁定地址
3. **安全性**：虽然参数可以在URL中看到，但后端会验证二维码的有效性，防止伪造

## 相关文档

- 访客预约表单逻辑：`pagesA/reservation/form.vue` #7757-7790
- 二维码验证逻辑：`pagesA/reservation/form.vue` #7467-7916
- 访客类型定义：`pagesA/reservation/form.vue` #7752

---

**修复日期**: 2025-12-03  
**修复人员**: Cascade AI  
**问题来源**: 用户反馈
