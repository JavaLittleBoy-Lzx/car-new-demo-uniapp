# 车牌数量限制功能说明（管家预约 & 业主预约）

## 功能概述

**管家代人预约**和**业主自助预约**时，系统会根据业主拥有的车牌数量来限制待入场预约的数量，防止超额预约。**限制按车场（小区）分别计算**，同一业主在不同车场的预约限额互不影响。

## 业务逻辑

### 规则说明

1. **查询业主车牌数量**：系统自动查询业主在系统中登记的车牌数量
2. **统计待入场预约**：统计该业主在**当前车场**有多少个状态为"待入场"的预约
3. **车场限制**：⭐ 业主在不同车场的预约限额分别计算，互不影响
4. **限额判断**：
   - 如果业主有3个车牌 → 在该车场最多允许3个待入场预约
   - 如果业主有1个车牌 → 在该车场最多允许1个待入场预约
   - 如果待入场预约数量 >= 车牌数量 → 在该车场不允许再次预约

### 示例场景

#### 场景1：业主有3个车牌
```
业主车牌数量：3个
当前待入场预约：0个
✅ 允许预约（还可预约3个）

当前待入场预约：2个
✅ 允许预约（还可预约1个）

当前待入场预约：3个
❌ 不允许预约（已达上限）
```

#### 场景2：业主有1个车牌
```
业主车牌数量：1个
当前待入场预约：0个
✅ 允许预约（还可预约1个）

当前待入场预约：1个
❌ 不允许预约（已达上限）
```

#### 场景3：业主在不同车场预约（⭐ 新增）
```
业主车牌数量：3个

在【万象上东】车场：
  当前待入场预约：3个
  ❌ 在万象上东不允许预约（已达上限）

在【绿地中央广场】车场：
  当前待入场预约：0个
  ✅ 在绿地中央广场允许预约（还可预约3个）

说明：同一业主在不同车场的预约限额分别计算
```

## 技术实现

### 1. 修改提交流程

**文件**：`pagesA/reservation/form.vue`

**位置**：`submit()` 方法

```javascript
// 检查手机号历史记录
if (this.currentUserRole === 'manager' || this.currentUserRole === 'owner') {
    // 🆕 管家预约/业主预约：根据业主车牌数量限制待入场预约数量（按车场计算）
    const vehicleCheck = await this.checkManagerAppointmentLimit();
    if (!vehicleCheck.canSubmit) {
        return; // 如果不能提交，方法内部已经显示了相应提示
    }
} else {
    // 访客：原有的历史记录检查
    const historyCheck = await this.checkPhoneHistory();
    if (!historyCheck.canSubmit) {
        return; // 如果不能提交，方法内部已经显示了相应提示
    }
}
```

### 2. 新增检查方法

**方法名**：`checkManagerAppointmentLimit()`

**功能**：检查管家预约/业主预约的车牌限制（通用方法）

**实现步骤**：
1. 获取业主手机号
2. **获取当前预约的车场信息**（`this.selectedOwnerInfo?.community` 或 `this.form.addressInfo.community`）
3. 获取业主的车牌数量（`this.ownerVehicleCount`）
4. 查询业主的预约历史记录
5. **筛选状态为"待入场"且"车场相同"的预约数量**
6. 比较待入场数量和车牌数量
7. 如果达到上限，显示详细的提示信息（包含车场信息）

**返回值**：
```javascript
{
    canSubmit: true/false,  // 是否允许提交
    message: string          // 提示信息
}
```

### 3. 辅助方法

**方法名**：`formatSimpleTime(dateTimeStr)`

**功能**：简单格式化时间显示

**示例**：
- 输入：`2025-12-03 14:30:00`
- 输出：`12月3日 14:30`

## 用户交互

### 预约成功场景
- 系统静默检查，不打扰用户
- 直接进入预约提交流程

### 预约被限制场景

**提示标题**：⛔ 预约数量已达上限

**提示内容**：
```
该业主在【万象上东】共有 3 个车牌号码，目前已有 3 个待入场的预约，已达到预约上限。

【万象上东】待入场的预约：
1. 京A12345 (12月3日 10:30)
2. 京B67890 (12月3日 14:00)
3. 京C11111 (12月4日 08:00)

请等待车辆入场后再进行新的预约。

提示：业主在不同车场的预约限额分别计算。
```

**按钮**：我知道了

## 数据来源

### 车牌数量查询
- **API接口**：`/parking/violations/owners/${ownerId}/vehicles`
- **存储位置**：`this.ownerVehicleCount`
- **查询时机**：业主信息选择/查询时自动获取

### 预约记录查询
- **API接口**：`appointmentAPI.getListByPhone(ownerPhone)`
- **筛选条件**：`venuestatus === '待入场'`

## 异常处理

### 车牌数量为0
- **处理方式**：默认允许预约1个
- **原因**：业主可能尚未在系统中登记车牌

### 查询失败
- **处理方式**：默认允许预约
- **原因**：网络异常或接口错误，不应阻止正常业务

### 业主手机号为空
- **处理方式**：允许提交
- **原因**：表单验证会在更早阶段拦截

## 影响范围

### 修改的角色
- ✅ **管家（manager）**：使用车牌数量限制，按车场检查待入场预约数量
- ✅ **业主（owner）**：使用车牌数量限制，按车场检查待入场预约数量（⭐ v1.2新增）
- ⏸️ **访客（visitor）**：保持原有历史记录检查逻辑不变

### 修改的功能
- ✅ 管家代人预约提交流程
- ✅ 业主自己预约提交流程（⭐ v1.2新增）
- ⏸️ 访客自助预约流程（不受影响）

## 测试场景

### 测试用例1：业主有多个车牌，无待入场预约
1. 管家选择业主（业主有3个车牌）
2. 系统查询到车牌数量：3个
3. 查询待入场预约数量：0个
4. ✅ 允许提交预约

### 测试用例2：业主有1个车牌，已有1个待入场预约
1. 管家选择业主（业主有1个车牌）
2. 系统查询到车牌数量：1个
3. 查询待入场预约数量：1个
4. ❌ 显示提示："预约数量已达上限"
5. 显示待入场预约详情

### 测试用例3：业主有3个车牌，已有2个待入场预约
1. 管家选择业主（业主有3个车牌）
2. 系统查询到车牌数量：3个
3. 查询待入场预约数量：2个
4. ✅ 允许提交预约（还可预约1个）

### 测试用例4：查询车牌数量失败
1. 管家选择业主
2. 车牌查询接口返回错误
3. ✅ 默认允许预约（不影响正常流程）

### 测试用例5：跨车场预约（⭐ 车场限制）
1. 管家在【万象上东】为业主预约（业主有3个车牌）
2. 该业主在【万象上东】已有3个待入场预约
3. ❌ 在【万象上东】显示："预约数量已达上限"
4. 管家切换到【绿地中央广场】为同一业主预约
5. 该业主在【绿地中央广场】有0个待入场预约
6. ✅ 在【绿地中央广场】允许预约（还可预约3个）

**验证重点**：确认不同车场的预约限额独立计算

### 测试用例6：业主自己预约（⭐ v1.2新增）
1. 业主登录后进入预约页面（业主有2个车牌）
2. 系统查询到车牌数量：2个
3. 查询该业主在当前车场的待入场预约：1个
4. ✅ 允许提交预约（还可预约1个）
5. 再次提交预约
6. ❌ 显示："预约数量已达上限"

**验证重点**：业主自己预约也受车牌数量限制

## 后续优化建议

1. **实时更新**：业主入场后，自动更新待入场数量
2. **批量预约**：如果业主有多个车位空余，允许一次预约多个车牌
3. **预约队列**：显示业主的所有待入场预约，方便管家查看
4. **智能提示**：在选择业主时，显示当前可预约数量

## 文档版本

- **版本号**：v1.2
- **创建日期**：2025-12-03
- **更新日期**：2025-12-03
- **更新内容**：
  - v1.0：实现管家预约的车牌数量限制
  - v1.1：添加车场（小区）限制，不同车场的预约限额分别计算
  - v1.2：业主自助预约也采用车牌数量限制方案
- **修改人**：System
- **文件位置**：`pagesA/reservation/form.vue`
