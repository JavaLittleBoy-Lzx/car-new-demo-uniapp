# ç®¡å®¶é¢„çº¦åœ°å€å†²çªæ£€æŸ¥åŠŸèƒ½è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

ä¸ºç®¡å®¶é¢„çº¦ç³»ç»Ÿæ·»åŠ äº†åœ°å€å†²çªæ£€æŸ¥åŠŸèƒ½ï¼Œç¡®ä¿ç›¸åŒåœ°å€çš„ä¸åŒä¸šä¸»ä¸èƒ½åŒæ—¶è¿›è¡Œé¢„çº¦ï¼Œä½†å…è®¸ç®¡å®¶ä¸ºä¸åŒä¸šä¸»è¿›è¡Œé¢„çº¦æ“ä½œã€‚

## ğŸ¯ ä¸šåŠ¡è§„åˆ™

### æ ¸å¿ƒè§„åˆ™
- **ç®¡å®¶é¢„çº¦æ—¶åªè¦é€‰æ‹©ä¸åŒçš„ä¸šä¸»å°±å¯ä»¥è¿›è¡Œé¢„çº¦æ“ä½œ**
- **å¯¹äºç›¸åŒåœ°å€çš„ä¸åŒä¸šä¸»ä¸å¯ä»¥è¿›è¡Œé¢„çº¦**

### å…·ä½“é€»è¾‘
1. ç®¡å®¶é€‰æ‹©ä¸šä¸»Aè¿›è¡Œé¢„çº¦ â†’ âœ… å…è®¸
2. ç®¡å®¶é€‰æ‹©ä¸šä¸»Bè¿›è¡Œé¢„çº¦ï¼ˆä¸åŒåœ°å€ï¼‰â†’ âœ… å…è®¸  
3. ç®¡å®¶é€‰æ‹©ä¸šä¸»Cè¿›è¡Œé¢„çº¦ï¼ˆä¸ä¸šä¸»Aç›¸åŒåœ°å€ï¼‰â†’ âŒ ç¦æ­¢

## ğŸ”§ æŠ€æœ¯å®ç°

### åç«¯å®ç°

#### 1. Controllerå±‚
**æ–‡ä»¶**: `src/main/java/com/parkingmanage/controller/AppointmentController.java`

```java
@ApiOperation("æŒ‰åœ°å€æŸ¥è¯¢é¢„çº¦è®°å½•")
@GetMapping("/listByAddress")
@ResponseBody
public Result listByAddress(
        @RequestParam(required = false) String community,
        @RequestParam(required = false) String building,
        @RequestParam(required = false) String units,
        @RequestParam(required = false) String floor,
        @RequestParam(required = false) String room) {
    // å®ç°åœ°å€æŸ¥è¯¢é€»è¾‘
}
```

#### 2. Serviceå±‚
**æ–‡ä»¶**: `src/main/java/com/parkingmanage/service/AppointmentService.java`

```java
List<Appointment> listByAddress(String community, String building, String units, String floor, String room);
```

#### 3. Mapperå±‚
**æ–‡ä»¶**: `src/main/java/com/parkingmanage/mapper/AppointmentMapper.java`

```java
List<Appointment> listByAddress(String community, String building, String units, String floor, String room);
```

#### 4. SQLå®ç°
**æ–‡ä»¶**: `src/main/java/com/parkingmanage/mapper/xml/AppointmentMapper.xml`

```xml
<select id="listByAddress" resultType="com.parkingmanage.entity.Appointment">
    SELECT a.* FROM appointment a 
    WHERE 1=1
    <if test="community != null and community != ''">
        AND a.community = #{community}
    </if>
    <if test="building != null and building != ''">
        AND a.building = #{building}
    </if>
    <if test="units != null and units != ''">
        AND a.units = #{units}
    </if>
    <if test="floor != null and floor != ''">
        AND a.floor = #{floor}
    </if>
    <if test="room != null and room != ''">
        AND a.room = #{room}
    </if>
    ORDER BY a.recorddate DESC
</select>
```

### å‰ç«¯å®ç°

#### 1. APIé…ç½®
**æ–‡ä»¶**: `config/api.js`

```javascript
// æ–°å¢APIç«¯ç‚¹
listByAddress: '/parking/appointment/listByAddress'

// æ–°å¢APIæ–¹æ³•
getListByAddress(params) {
  return request({
    url: apiUrls.appointment.listByAddress,
    method: 'GET',
    data: params
  });
}
```

#### 2. é¢„çº¦è¡¨å•é€»è¾‘
**æ–‡ä»¶**: `pages/reservation/form.vue`

```javascript
async submit() {
  // è¡¨å•éªŒè¯
  if (!this.validateForm()) {
    return;
  }

  // æ£€æŸ¥æ‰‹æœºå·å†å²è®°å½•
  const historyCheck = await this.checkPhoneHistory();
  if (!historyCheck.canSubmit) {
    return;
  }

  // ç®¡å®¶é¢„çº¦æ—¶æ£€æŸ¥åœ°å€å†²çª â­ æ–°å¢
  if (this.currentUserRole === 'manager') {
    const addressCheck = await this.checkAddressConflict();
    if (!addressCheck.canSubmit) {
      return;
    }
  }

  // æ„å»ºé¢„çº¦æ•°æ®
  const appointmentData = await this.buildAppointmentData();

  // è°ƒç”¨é¢„çº¦æ¥å£
  this.submitAppointment(appointmentData);
}
```

#### 3. åœ°å€å†²çªæ£€æŸ¥æ–¹æ³•
```javascript
async checkAddressConflict() {
  try {
    // è·å–å½“å‰è¦é¢„çº¦çš„åœ°å€ä¿¡æ¯
    const currentAddress = this.getCurrentAddressInfo();
    
    // æŸ¥è¯¢è¯¥åœ°å€çš„æ‰€æœ‰é¢„çº¦è®°å½•
    const addressRecords = await appointmentAPI.getListByAddress(currentAddress);
    
    // ç­›é€‰è¿‘æœŸæœ‰æ•ˆè®°å½•
    const recentRecords = this.filterRecentAndValidRecords(recordList);
    
    // æ£€æŸ¥æ˜¯å¦æœ‰ä¸åŒä¸šä¸»çš„æœ‰æ•ˆé¢„çº¦
    const currentOwnerPhone = this.selectedOwnerInfo ? this.selectedOwnerInfo.ownerphone : '';
    
    for (let record of recentRecords) {
      const recordOwnerPhone = record.ownerphone || '';
      const actualStatus = this.getRecordStatus(record);
      
      // å¦‚æœæ˜¯ä¸åŒä¸šä¸»ä¸”æœ‰æœ‰æ•ˆé¢„çº¦ï¼Œåˆ™ä¸å…è®¸é¢„çº¦
      if (recordOwnerPhone && recordOwnerPhone !== currentOwnerPhone) {
        if (['æœ‰æ•ˆ', 'å¾…å®¡æ ¸', 'å·²é€šè¿‡', 'å·²å…¥åœº', 'åœ¨åœº'].includes(actualStatus)) {
          // æ˜¾ç¤ºå†²çªæç¤º
          return { canSubmit: false, message: 'å­˜åœ¨åœ°å€å†²çªçš„é¢„çº¦è®°å½•' };
        }
      }
    }
    
    return { canSubmit: true, message: 'åœ°å€å†²çªæ£€æŸ¥é€šè¿‡' };
  } catch (error) {
    // é”™è¯¯å¤„ç†
    return { canSubmit: true, message: 'åœ°å€å†²çªæ£€æŸ¥å¤±è´¥ï¼Œä½†å…è®¸æäº¤' };
  }
}
```

## ğŸ” æ£€æŸ¥æµç¨‹

### 1. è§¦å‘æ¡ä»¶
- ç”¨æˆ·è§’è‰²ä¸ºç®¡å®¶ (`currentUserRole === 'manager'`)
- åœ¨é¢„çº¦æäº¤å‰è¿›è¡Œæ£€æŸ¥

### 2. æ£€æŸ¥æ­¥éª¤
1. **è·å–åœ°å€ä¿¡æ¯**: ä»é€‰ä¸­çš„ä¸šä¸»ä¿¡æ¯æˆ–è¡¨å•ä¸­è·å–å®Œæ•´åœ°å€
2. **æŸ¥è¯¢å†å²è®°å½•**: æŸ¥è¯¢è¯¥åœ°å€çš„æ‰€æœ‰é¢„çº¦è®°å½•
3. **ç­›é€‰æœ‰æ•ˆè®°å½•**: è¿‡æ»¤30å¤©å†…çš„æœ‰æ•ˆè®°å½•
4. **ä¸šä¸»å¯¹æ¯”**: æ£€æŸ¥æ˜¯å¦æœ‰ä¸åŒä¸šä¸»çš„æœ‰æ•ˆé¢„çº¦
5. **çŠ¶æ€åˆ¤æ–­**: æ£€æŸ¥é¢„çº¦çŠ¶æ€æ˜¯å¦ä¸ºæœ‰æ•ˆçŠ¶æ€

### 3. å†²çªåˆ¤æ–­
å¦‚æœå‘ç°ä»¥ä¸‹æƒ…å†µï¼Œåˆ™è®¤ä¸ºå­˜åœ¨å†²çªï¼š
- ç›¸åŒåœ°å€
- ä¸åŒä¸šä¸»ç”µè¯
- é¢„çº¦çŠ¶æ€ä¸ºæœ‰æ•ˆçŠ¶æ€ï¼š
  - `æœ‰æ•ˆ`ã€`å¾…å®¡æ ¸`ã€`å®¡æ ¸ä¸­`ã€`å¾…å®¡æ‰¹`ã€`å®¡æ‰¹ä¸­`
  - `å·²é€šè¿‡`ã€`å®¡æ ¸é€šè¿‡`ã€`é€šè¿‡`ã€`å®¡æ‰¹é€šè¿‡`
  - `å·²å…¥åœº`ã€`å…¥åœº`ã€`åœ¨åœº`

## ğŸ“± ç”¨æˆ·ä½“éªŒ

### æˆåŠŸåœºæ™¯
- æ— å†²çªæ—¶ï¼šæ­£å¸¸æäº¤é¢„çº¦
- æ£€æŸ¥å¤±è´¥æ—¶ï¼šå…è®¸æäº¤ä½†è®°å½•é”™è¯¯

### å†²çªåœºæ™¯
- æ˜¾ç¤ºå‹å¥½çš„æç¤ºä¿¡æ¯
- æ˜ç¡®è¯´æ˜å†²çªåŸå› 
- æä¾›è§£å†³å»ºè®®

### æç¤ºä¿¡æ¯ç¤ºä¾‹
```
åœ°å€å†²çªæé†’

è¯¥åœ°å€å·²æœ‰å…¶ä»–ä¸šä¸»çš„æœ‰æ•ˆé¢„çº¦ï¼š
ä¸šä¸»ï¼šå¼ ä¸‰ (138****1234)
é¢„çº¦æ—¶é—´ï¼š2024-01-15 14:00-16:00
çŠ¶æ€ï¼šå·²é€šè¿‡

ç›¸åŒåœ°å€çš„ä¸åŒä¸šä¸»ä¸èƒ½åŒæ—¶é¢„çº¦ï¼Œè¯·é€‰æ‹©å…¶ä»–æ—¶é—´æˆ–è”ç³»ç®¡ç†å‘˜å¤„ç†ã€‚
```

## âœ… æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯
1. **æ­£å¸¸é¢„çº¦**: ç®¡å®¶ä¸ºä¸šä¸»Aé¢„çº¦ï¼Œåœ°å€æ— å†²çª
2. **å†²çªé¢„çº¦**: ç®¡å®¶ä¸ºä¸šä¸»Bé¢„çº¦ï¼Œä¸ä¸šä¸»Aç›¸åŒåœ°å€ä¸”æœ‰æœ‰æ•ˆé¢„çº¦
3. **ä¸åŒåœ°å€**: ç®¡å®¶ä¸ºä¸šä¸»Cé¢„çº¦ï¼Œåœ°å€ä¸Aã€Bä¸åŒ
4. **ç›¸åŒä¸šä¸»**: ç®¡å®¶ä¸ºä¸šä¸»Aå†æ¬¡é¢„çº¦ï¼ˆåº”è¯¥å…è®¸ï¼‰

### éªŒè¯è¦ç‚¹
- [ ] åœ°å€æŸ¥è¯¢APIæ­£å¸¸å·¥ä½œ
- [ ] å†²çªæ£€æµ‹é€»è¾‘æ­£ç¡®
- [ ] ç”¨æˆ·æç¤ºä¿¡æ¯å‹å¥½
- [ ] ä¸å½±å“å…¶ä»–é¢„çº¦ç±»å‹
- [ ] é”™è¯¯å¤„ç†æœºåˆ¶å®Œå–„

## ğŸ”„ åç»­ä¼˜åŒ–

1. **æ€§èƒ½ä¼˜åŒ–**: è€ƒè™‘æ·»åŠ ç¼“å­˜æœºåˆ¶
2. **è§„åˆ™æ‰©å±•**: æ”¯æŒæ›´å¤æ‚çš„å†²çªè§„åˆ™
3. **ç®¡ç†åŠŸèƒ½**: ä¸ºç®¡ç†å‘˜æä¾›å†²çªè§£å†³å·¥å…·
4. **æ—¥å¿—è®°å½•**: è¯¦ç»†è®°å½•å†²çªæ£€æŸ¥è¿‡ç¨‹
