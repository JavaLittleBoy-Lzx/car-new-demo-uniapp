# 管家二维码生成问题排查指南

## 🔍 问题描述
在使用管家二维码生成功能时，可能会遇到"管家信息不存在"的错误。

## 📋 常见错误信息
```
生成二维码失败: Error: 管家信息不存在
```

## 🛠️ 解决方案

### 1. 检查用户登录状态
- 点击页面底部的"检查用户信息"按钮
- 确认以下信息：
  - ✅ 角色：manager (管家)
  - ✅ 授权状态：已授权
  - ✅ 手机号：已设置且正确
  - ✅ OpenID：已设置

### 2. 数据库检查
确保数据库中存在对应的管家记录：

```sql
-- 查询管家记录
SELECT * FROM butler WHERE phone = '您的手机号';

-- 如果没有记录，插入测试数据
INSERT INTO butler (
    usercode, 
    username, 
    phone, 
    province, 
    city, 
    district, 
    community, 
    createdate, 
    status, 
    openid
) VALUES (
    'BUTLER001',
    '张管家',
    '13593527970',  -- 替换为实际手机号
    '黑龙江省',
    '哈尔滨市',
    '道里区',
    '欧洲新城',
    NOW(),
    '已确认',
    'manager_13593527970_test'  -- 替换为实际openid
);
```

### 3. 后端服务重启
修改后端代码后需要重启服务：
```bash
# 停止服务
./mvnw spring-boot:stop

# 重新编译并启动
./mvnw clean package spring-boot:run
```

### 4. 前端调试
查看浏览器控制台日志：
- 确认API请求参数包含正确的手机号
- 检查后端响应数据结构
- 验证管家信息查询逻辑

## 🔧 技术改进点

### 后端接口优化
- `generateQrCodeData` 接口现在支持三种查询方式：
  1. 通过手机号查询（推荐）
  2. 通过openid查询
  3. 从生成的openid中提取手机号查询

### 前端逻辑优化
- 优先使用登录时保存的用户信息构建管家信息
- 添加手机号参数到API调用
- 改进错误处理和用户提示

## ⚠️ 注意事项

1. **手机号格式**：确保手机号为11位数字
2. **管家状态**：数据库中管家状态应为"已确认"
3. **角色权限**：确保用户角色为"manager"
4. **网络连接**：确保前后端网络连接正常

## 📱 测试步骤

1. 重启后端服务
2. 使用管家账号重新登录
3. 点击"检查用户信息"确认状态
4. 选择地址信息
5. 点击"生成二维码"

## 🆘 如果问题仍然存在

1. 检查数据库连接
2. 查看后端服务日志
3. 确认管家表结构是否正确
4. 联系技术支持提供详细错误日志

---

*最后更新时间：2025年1月* 