# 邀请车牌数量功能修改说明

## 修改概述

将访客二维码邀请功能中的车牌数量限制从"查询业主车牌数量"改为"手动输入邀请车牌数量"。

## 修改时间

2024-12-05

## 修改内容

### 1. qrcode-generator.vue（管家生成二维码页面）

#### 移除的功能
- ❌ 移除了查询业主车牌信息的方法 `queryOwnerVehicles()`
- ❌ 移除了业主车牌数量相关的数据变量：
  - `ownerVehicleCount`
  - `ownerVehicleList`
  - `vehicleLoading`

#### 新增的功能
- ✅ 添加了邀请车牌数量输入框
- ✅ 新增数据变量 `invitedCarCount`（默认值为1）
- ✅ 添加了输入验证方法 `onCarCountInput()`
  - 自动限制最小值为1
  - 自动限制最大值为10
  - 确保输入的是正整数

#### UI变化
**修改前：**
```
选中业主后自动显示：
- 该业主共有 X 个车牌号码
- 访客可填写最多 X 个车牌进行预约
```

**修改后：**
```
选中业主后显示输入框：
┌─────────────────────────────┐
│ 🚗 邀请车牌数量             │
│ ┌─────────────────────────┐ │
│ │ [输入框: 允许预约的车牌数] │ │
│ └─────────────────────────┘ │
│ ℹ️ 建议范围：1-5个车牌      │
│ 访客扫码后最多可预约该数量  │
└─────────────────────────────┘
```

### 2. form.vue（访客预约表单页面）

#### 新增的功能
- ✅ 添加了从二维码参数接收邀请车牌数量的逻辑
- ✅ 支持两种参数名：
  - `maxVehicleCount`（兼容旧版本）
  - `invitedCarCount`（新版本推荐）

#### 接收逻辑
```javascript
// 从二维码URL参数中解析车牌数量限制
if (options.maxVehicleCount || options.invitedCarCount) {
    const carCount = parseInt(options.maxVehicleCount || options.invitedCarCount);
    if (!isNaN(carCount) && carCount > 0) {
        this.maxCarCount = carCount;
        console.log('🚗 从二维码获取到邀请车牌数量限制:', this.maxCarCount);
    }
}
```

#### 限制效果
访客在预约页面：
- 车牌输入框会根据 `maxCarCount` 限制可添加的车牌数量
- 达到上限后"添加车牌"按钮自动禁用
- 显示提示信息："还可添加 X 个车牌"或"已达到车牌数量上限"

## 数据流转

```
┌──────────────────────────────────────────────────────────────┐
│ 管家生成二维码                                                │
│                                                              │
│ 1. 选择业主                                                  │
│ 2. 手动输入邀请车牌数量（例如：3）                           │
│ 3. 点击"生成访客邀请码"                                      │
│                                                              │
│ ↓ 生成二维码URL，包含参数：                                  │
│   - ownerName: 业主姓名                                      │
│   - ownerPhone: 业主电话                                     │
│   - invitedCarCount: 3                                       │
│   - maxVehicleCount: 3（兼容参数）                           │
└──────────────────────────────────────────────────────────────┘
                            ↓
┌──────────────────────────────────────────────────────────────┐
│ 访客扫描二维码                                                │
│                                                              │
│ 1. 微信扫码跳转到预约页面                                     │
│ 2. 页面自动解析URL参数                                        │
│ 3. 提取 invitedCarCount 或 maxVehicleCount                   │
│ 4. 设置 this.maxCarCount = 3                                 │
│                                                              │
│ ↓ 访客填写预约信息：                                          │
│   - 最多可添加3个车牌                                         │
│   - 添加第3个后，"添加车牌"按钮禁用                           │
│   - 显示："已达到车牌数量上限"                                │
└──────────────────────────────────────────────────────────────┘
```

## 二维码参数示例

生成的二维码URL包含以下参数：
```
https://www.xuerparking.cn:8543/verify/butler/?
    qrId=QR_1733377200000_1234_abc123def&
    ownerName=%E5%BC%A0%E4%B8%89&
    ownerPhone=13800138000&
    community=%E6%98%9F%E6%B2%B3%E5%B0%8F%E5%8C%BA&
    building=1%E5%8F%B7%E6%A5%BC&
    units=2%E5%8D%95%E5%85%83&
    floor=3&
    room=301&
    invitedCarCount=3&
    maxVehicleCount=3&
    visitorType=invited&
    timestamp=1733377200000
```

## 使用建议

### 车牌数量设置建议
- **1个车牌**：适用于单车访客
- **2个车牌**：适用于家庭访客（可能有2辆车）
- **3-5个车牌**：适用于团体访客或多人聚会
- **5个以上**：特殊情况，需谨慎设置

### 安全考虑
- 输入框自动限制最大值为10个车牌
- 建议日常使用不超过5个车牌
- 过多的车牌数量可能导致管理混乱

## 向后兼容性

### 兼容性保证
✅ 完全兼容旧版本二维码
- 同时支持 `maxVehicleCount` 和 `invitedCarCount` 参数
- 如果两个参数都存在，优先使用 `maxVehicleCount`
- 如果参数缺失，默认使用 `maxCarCount = 1`

### 升级路径
- 无需修改现有二维码
- 新生成的二维码会包含两种参数
- 访客页面自动识别并处理

## 调试信息

### 管家端（qrcode-generator.vue）

生成二维码时会输出以下调试信息：

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🚗 [调试] 生成二维码 - 邀请车牌数量信息:
   输入框值 this.invitedCarCount: 3
   类型: number
   最终使用的值: 3
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🎯 [调试] visitorParams中的车牌参数:
   invitedCarCount: 3
   maxVehicleCount: 3
🔗 [调试] 生成的完整二维码URL:
https://www.xuerparking.cn:8543/verify/butler/?qrId=...&invitedCarCount=3&maxVehicleCount=3...
✅ [调试] URL中包含 invitedCarCount 参数: 3
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

输入框变化时会输出：
```
🔍 [调试] 输入框变化 - 原始输入值: "3" 类型: string
🔍 [调试] parseInt后的值: 3
✅ [调试] 输入值有效，已设置为: 3
🚗 [调试] 最终邀请车牌数量: 3 类型: number
```

### 访客端（form.vue）

扫码进入预约页面时会输出以下调试信息：

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🚗 [调试] 访客端 - 解析邀请车牌数量参数:
   options.invitedCarCount: 3 类型: string
   options.maxVehicleCount: 3 类型: string
   使用的原始值: 3
   parseInt后的值: 3 类型: number
✅ [调试] 成功设置邀请车牌数量限制: 3
   访客最多可添加 3 个车牌
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 如何查看调试信息

1. **微信开发者工具**
   - 打开微信开发者工具
   - 在 Console 面板查看日志输出

2. **真机调试**
   - 开启微信开发者模式
   - 使用 vConsole 查看日志

3. **关键日志标识**
   - 🚗 = 车牌数量相关
   - 🔍 = 输入验证
   - ✅ = 操作成功
   - ⚠️ = 警告信息
   - 🔗 = URL相关

## 测试建议

### 测试场景1：正常流程
1. 管家登录进入二维码生成页面
2. 选择业主
3. 输入邀请车牌数量：3
4. **查看控制台输出**，确认输入值被正确处理
5. 生成二维码
6. **查看URL日志**，确认URL中包含 `invitedCarCount=3`
7. 访客扫码进入预约页面
8. **查看访客端日志**，确认参数被正确接收
9. 验证最多可添加3个车牌

### 测试场景2：边界值测试
1. 输入0或负数 → 查看日志，应显示"已重置为1"
2. 输入10.5 → 查看日志，应显示"已限制为10"
3. 输入100 → 查看日志和提示，应限制为10

### 测试场景3：兼容性测试
1. 使用旧版二维码（只有maxVehicleCount参数）
2. 查看访客端日志，确认能识别 maxVehicleCount
3. 验证访客页面能正确限制车牌数量

### 调试检查清单
- [ ] 输入框变化时能看到调试日志
- [ ] 生成二维码时能看到完整的参数信息
- [ ] URL中包含 invitedCarCount 和 maxVehicleCount
- [ ] 访客端能正确解析参数
- [ ] 车牌数量限制功能正常工作

## 文件清单

### 修改的文件
- `pagesB/butler/qrcode-generator.vue`（管家生成二维码页面）
- `pagesA/reservation/form.vue`（访客预约表单页面）

### 修改的代码行数
- qrcode-generator.vue：约150行（移除60行，新增90行）
- form.vue：新增8行

## 注意事项

⚠️ **重要提示**
1. 修改后需要清除小程序缓存重新测试
2. 建议先在测试环境验证功能
3. 确保访客页面的车牌限制逻辑正常工作
4. 检查二维码生成后URL参数是否完整

## 重要修复记录

### 修复1：前端降级方案缺少车牌数量参数（2024-12-05）

**问题描述：**
- 当后端二维码接口失败时，会自动降级到前端直接生成二维码
- 前端降级方案 `generateMiniProgramCode()` 中没有包含 `invitedCarCount` 和 `maxVehicleCount` 参数
- 导致访客扫码后无法获取车牌数量限制

**问题表现：**
```
第一次尝试的URL（包含参数）：
...&invitedCarCount=8&maxVehicleCount=8&...

最终生成的URL（缺少参数）：
...&building=A&unit=1&floor=1&room=10&...
❌ 缺少 invitedCarCount 和 maxVehicleCount
```

**修复方案：**
在 `generateMiniProgramCode()` 方法的第2073-2075行添加：
```javascript
// 🆕 添加邀请车牌数量参数
shortParams.push(`invitedCarCount=${this.invitedCarCount || 1}`);
shortParams.push(`maxVehicleCount=${this.invitedCarCount || 1}`);
```

**验证方法：**
1. 生成二维码后查看控制台日志
2. 应该看到：
```
🚗 [调试] 邀请车牌数量参数:
  - invitedCarCount: 8
  - maxVehicleCount: 8
  - URL中包含invitedCarCount: ✅ 是
  - URL中包含maxVehicleCount: ✅ 是
```

**影响范围：**
- 仅影响后端接口失败时的降级方案
- 修复后确保所有生成方式都包含车牌数量参数

### 修复2：访客端车牌数量被业主车牌覆盖（2024-12-05）

**问题描述：**
- 访客扫码进入预约页面后，虽然二维码传递了邀请车牌数量（如8个）
- 但在查询业主车牌信息后，`maxCarCount` 被业主的实际车牌数量（如2个）覆盖
- 导致访客无法按邀请数量添加车牌

**问题表现：**
```
访客扫码日志：
✅ [调试] 成功设置邀请车牌数量限制: 8

查询业主车牌后：
✅ [查询车牌] 查询成功，业主共有 2 个车牌号码
🎯 [车牌限制] maxCarCount已更新为 2  ❌ 覆盖了二维码的8
```

**根本原因：**
- 有两个地方会查询并覆盖 `maxCarCount`：
  1. `queryOwnerVehicleCount()` 方法（查询业主车牌）
  2. 月票数据统计部分（从月票获取车牌）
- 这些方法没有考虑二维码已经设置的邀请车牌数量

**修复方案：**

1. **添加来源标记**（第7631行）：
```javascript
if (!isNaN(carCount) && carCount > 0) {
    this.maxCarCount = carCount;
    // 🔥 关键：标记车牌数量来自二维码，优先级最高
    this.maxCarCountSource = 'qrcode';
}
```

2. **查询车牌时检查来源**（第8407-8418行）：
```javascript
// 🔥 关键修复：检查车牌数量来源，如果来自二维码则不覆盖
if (this.maxCarCountSource === 'qrcode') {
    console.log(`⭐ [车牌限制] 二维码已设置邀请车牌数量为 ${this.maxCarCount}，不使用业主车牌数量`);
    console.log(`ℹ️ [车牌限制] 业主车牌数量仅供参考: ${this.ownerVehicleCount} 个`);
} else {
    this.maxCarCount = vehicleList.length || 1;
}
```

3. **月票统计时也检查来源**（第6497-6504行）：
```javascript
if (this.maxCarCountSource === 'qrcode') {
    console.log(`⭐ [车牌限制] 二维码已设置邀请车牌数量为 ${this.maxCarCount}，不使用月票车牌数量`);
} else {
    this.maxCarCount = vehicleCount;
}
```

**优先级规则：**
```
二维码邀请车牌数量 > 业主实际车牌数量 > 月票车牌数量 > 默认值(1)
```

**验证方法：**
1. 管家设置邀请车牌数量为8
2. 访客扫码进入
3. 查看日志应显示：
```
⭐ [车牌限制] 二维码已设置邀请车牌数量为 8，不使用业主车牌数量
ℹ️ [车牌限制] 业主车牌数量仅供参考: 2 个
```
4. 验证访客最多可添加8个车牌（而不是2个）

**影响范围：**
- 访客通过二维码邀请的所有预约场景
- 确保邀请车牌数量不会被业主实际车牌数量覆盖
- 提升了二维码邀请功能的可控性

### 修复3：phone-auth.vue未传递邀请车牌数量参数（2024-12-05）

**问题描述：**
- 访客扫码后，先跳转到 `phone-auth.vue` 进行授权
- `phone-auth.vue` 在跳转到 `form.vue` 时，没有传递邀请车牌数量参数
- 导致即使二维码包含邀请车牌数量，访客也无法获取

**问题表现：**
```
管家生成的二维码URL：
...&invitedCarCount=8&maxVehicleCount=8&...

phone-auth.vue 跳转 form.vue时：
/pagesA/reservation/form?qrId=xxx&community=xxx&building=xxx
❌ 缺少 invitedCarCount 和 maxVehicleCount
```

**根本原因：**
1. `phone-auth.vue` 在初始化 `scannedParams` 时没有包含邀请车牌数量字段
2. 构建跳转URL时没有传递这两个参数

**修复方案：**

1. **添加字段定义**（第411-412行）：
```javascript
this.scannedParams = {
    // ... 其他字段
    invitedCarCount: '', // 🚗 邀请车牌数量
    maxVehicleCount: '', // 🚗 最大车牌数量（兼容参数）
};
```

2. **传递参数**（第2507-2508行）：
```javascript
// 🚗 关键：传递邀请车牌数量参数
if (this.scannedParams.invitedCarCount) {
    params.push(`invitedCarCount=${encodeURIComponent(this.scannedParams.invitedCarCount)}`);
}
if (this.scannedParams.maxVehicleCount) {
    params.push(`maxVehicleCount=${encodeURIComponent(this.scannedParams.maxVehicleCount)}`);
}
```

**验证方法：**
1. 管家生成包含邀请车牌数量的二维码
2. 访客扫码，查看 phone-auth.vue 日志：
```
🚗 [调试] phone-auth.vue 传递的邀请车牌数量参数:
   invitedCarCount: 8
   maxVehicleCount: 8
```
3. 跳转的URL应包含这两个参数
4. form.vue 能正确接收并使用

**影响范围：**
- 所有通过二维码邀请的访客
- 确保参数在整个流程中正确传递
- 修复了参数传递链中的断点

### 修复4：URL参数提取时丢失邀请车牌数量（2024-12-05）

**问题描述：**
- `phone-auth.vue` 在从URL提取参数时，重新构建 `scannedParams` 对象
- 但第460-487行的参数映射中没有包含 `invitedCarCount` 和 `maxVehicleCount`
- 导致即使URL包含这些参数，解析后也会丢失

**问题表现：**
```
二维码URL：
...&invitedCarCount=8&maxVehicleCount=8&...

extractUrlParams 解析后：
urlParams = { invitedCarCount: '8', maxVehicleCount: '8', ... }

但重新赋值 scannedParams 时：
this.scannedParams = {
    qrId: ...,
    community: ...,
    // ❌ 缺少 invitedCarCount 和 maxVehicleCount
}
```

**根本原因：**
在 `phone-auth.vue` 第460行处理 `options.q` 参数时，从 `urlParams` 映射到 `this.scannedParams` 的过程中遗漏了邀请车牌数量字段。

**修复方案：**

在第485-486行添加字段映射：
```javascript
this.scannedParams = {
    // ... 其他字段
    // 🚗 关键：从URL参数中提取邀请车牌数量
    invitedCarCount: urlParams.invitedCarCount || urlParams.invited_car_count || '',
    maxVehicleCount: urlParams.maxVehicleCount || urlParams.max_vehicle_count || '',
};
```

并在调试信息中添加输出（第514-515行）：
```javascript
console.log('🚗 - invitedCarCount:', this.scannedParams.invitedCarCount || '未设置');
console.log('🚗 - maxVehicleCount:', this.scannedParams.maxVehicleCount || '未设置');
```

**验证方法：**
查看 phone-auth.vue 日志应显示：
```
 [参数解析完成] 关键参数汇总:
  - qrId: QR_xxx
  - community: 万象上东
  🚗 - invitedCarCount: 8
  🚗 - maxVehicleCount: 8
```

**影响范围：**
- 这是最关键的修复，解决了URL参数解析阶段的丢失问题
- 确保从二维码URL到scannedParams的完整传递链

### 修复5：scannedAddressInfo保存时丢失参数（2024-12-05）

**问题描述：**
- `phone-auth.vue` 在保存扫码信息到本地存储时，构建 `scannedAddressInfo` 对象
- 第530-547行构建该对象时，没有包含 `invitedCarCount` 和 `maxVehicleCount`
- 导致参数无法通过本地存储传递到 `form.vue`

**问题表现：**
```
this.scannedParams 有值：
{ invitedCarCount: '8', maxVehicleCount: '8', ... }

但 scannedAddressInfo 丢失：
{
    qrId: '...',
    community: '...',
    // ❌ 缺少 invitedCarCount 和 maxVehicleCount
}

导致 form.vue 中：
options.invitedCarCount: undefined
```

**根本原因：**
有三个地方构建 `scannedParams` 对象，但之前只修复了第460行的URL解析场景，还有两个降级场景（第562行和第578行）以及本地存储保存（第530行）都遗漏了这些字段。

**修复方案：**

1. **本地存储保存**（第634-635行）：
```javascript
const scannedAddressInfo = {
    // ... 其他字段
    // 🚗 关键：保存邀请车牌数量到本地存储
    invitedCarCount: this.scannedParams.invitedCarCount || '',
    maxVehicleCount: this.scannedParams.maxVehicleCount || '',
};
```

2. **解析失败降级**（第575-576行）：
```javascript
this.scannedParams = {
    // ... 其他字段
    // 🚗 邀请车牌数量（解析失败降级）
    invitedCarCount: options.invitedCarCount || options.invited_car_count || '',
    maxVehicleCount: options.maxVehicleCount || options.max_vehicle_count || ''
};
```

3. **非扫码场景**（第601-602行）：
```javascript
this.scannedParams = {
    // ... 其他字段
    // 🚗 邀请车牌数量（非扫码场景）
    invitedCarCount: options.invitedCarCount || options.invited_car_count || '',
    maxVehicleCount: options.maxVehicleCount || options.max_vehicle_count || ''
};
```

**影响范围：**
- 这是最后一个遗漏点，确保参数在所有代码路径中都能正确传递
- 修复后参数传递链完全打通

### 修复6：form.vue从本地存储合并参数时丢失（2024-12-05）

**问题描述：**
- `form.vue` 在 `processAllQrCodeParams()` 方法中从本地存储读取参数
- 第1483-1493行合并参数时，没有合并 `invitedCarCount` 和 `maxVehicleCount`
- 导致即使本地存储有这些参数，也无法传递到 `options`

**问题表现：**
```
本地存储 scannedAddressInfo：
{ invitedCarCount: '8', maxVehicleCount: '8', ... }

但 finalParams 合并后：
{
    qrId: '...',
    visitorType: 'invited',
    // ❌ 缺少 invitedCarCount 和 maxVehicleCount
}

导致后续：
options.invitedCarCount: undefined
options.maxVehicleCount: undefined
```

**根本原因：**
`form.vue` 第1473行从本地存储 `getStorageSync('scannedAddressInfo')` 读取参数，并在第1483-1493行合并到 `finalParams`，但合并逻辑中遗漏了邀请车牌数量字段。

**修复方案：**

在第1494-1495行添加字段合并：
```javascript
// 🚗 关键：从本地存储合并邀请车牌数量
finalParams.invitedCarCount = finalParams.invitedCarCount || storageParams.invitedCarCount;
finalParams.maxVehicleCount = finalParams.maxVehicleCount || storageParams.maxVehicleCount;
```

添加调试信息（第1496-1500行）：
```javascript
console.log('🚗 [调试] 从本地存储合并邀请车牌数量:');
console.log('   storageParams.invitedCarCount:', storageParams.invitedCarCount);
console.log('   finalParams.invitedCarCount:', finalParams.invitedCarCount);
```

**验证方法：**
查看 form.vue 日志应显示：
```
🚗 [调试] 从本地存储合并邀请车牌数量:
   storageParams.invitedCarCount: 8
   storageParams.maxVehicleCount: 8
   finalParams.invitedCarCount: 8
   finalParams.maxVehicleCount: 8

🚗 [调试] 访客端 - 解析邀请车牌数量参数:
   options.invitedCarCount: 8 类型: string
```

**影响范围：**
- 这是最关键的修复，打通了从本地存储到options的最后一环
- 确保参数能正确传递到解析逻辑

## UI优化

### 车牌数量提示文案修改

**修改位置：** form.vue 第204行、231行、260行

**修改前：**
```
业主角色：您名下共有 X 个车牌，可预约最多 X 辆车
访客角色：该业主共有 X 个车牌，您最多可预约 X 辆车
管家角色：该业主共有 X 个车牌，可代约最多 X 辆车
```

**修改后：**
```
所有角色（来自邀请链接时）：
🎉 您可预约最多 X 辆车（来自邀请链接）
```

**显示逻辑：**
- 只有当 `maxCarCountSource === 'qrcode'` 且 `maxCarCount > 0` 时才显示
- 不再显示业主实际车牌数量，避免混淆
- 突出显示邀请限制，用户体验更清晰

**代码示例：**
```vue
<view class="owner-vehicle-info-tip" v-if="maxCarCountSource === 'qrcode' && maxCarCount > 0">
    <u-icon name="car" color="#1890ff" size="16"></u-icon>
    <text class="vehicle-tip-text">🎉 您可预约最多 {{ maxCarCount }} 辆车（来自邀请链接）</text>
</view>
```

### 车牌限制说明卡片优化

**修改位置：** form.vue 第293-300行

**修改内容：**
根据 `maxCarCountSource` 显示不同标题和内容：

```vue
<text class="notice-title">{{ maxCarCountSource === 'qrcode' ? '邀请车牌数量' : '车牌数量限制' }}</text>
<text class="notice-desc" v-if="maxCarCountSource === 'qrcode'">
    🎉 您最多可预约 <text class="highlight-num">{{ maxCarCount }}</text> 个车牌（来自邀请链接）
</text>
<text class="notice-desc" v-else>
    业主名下有 <text class="highlight-num">{{ maxCarCount }}</text> 辆车，
    您最多可预约 <text class="highlight-num">{{ maxCarCount }}</text> 个车牌
</text>
```

**显示效果：**
- 来自邀请链接：标题"邀请车牌数量"，内容强调邀请链接
- 非邀请场景：标题"车牌数量限制"，内容显示业主车牌数

### 车牌数量未满弹窗优化

**修改位置：** form.vue 第9704-9706行

**修改内容：**
根据车牌数量来源显示不同的弹窗文案：

```javascript
const contentText = this.maxCarCountSource === 'qrcode' 
    ? `您已添加 ${addedCount} 个车牌，邀请链接允许最多 ${maxCount} 个车牌，还可以再添加 ${remaining} 个车牌。\n\n是否继续提交预约？`
    : `您已添加 ${addedCount} 个车牌，业主名下有 ${maxCount} 辆车，还可以再添加 ${remaining} 个车牌。\n\n是否继续提交预约？`;
```

**显示效果：**
- 来自邀请链接：提示"邀请链接允许最多 X 个车牌"
- 非邀请场景：提示"业主名下有 X 辆车"

## 回滚方案

如需回滚到旧版本（查询业主车牌）：
1. 恢复 `queryOwnerVehicles()` 方法
2. 恢复 `ownerVehicleCount` 相关变量
3. 移除 `invitedCarCount` 输入框
4. 恢复选择业主后自动查询车牌的逻辑

## 联系方式

如有问题，请联系开发团队。

---
**文档版本**：v1.0  
**最后更新**：2024-12-05
