# 三层角色体系实现总结

## 🎯 实现目标

将原来的二层角色体系（业主、管家）升级为三层角色体系（业主、管家、访客），增加待审核和未注册状态处理。

## 🔄 改进后的角色判断逻辑

### 后端角色查询优先级

```java
private Map<String, Object> determineUserRole(String phoneNumber, String openid) {
    // 第一层：查询管家表 (最高优先级)
    Butler butler = butlerService.list().stream()
        .filter(b -> phoneNumber.equals(b.getPhone()))
        .findFirst().orElse(null);
    if (butler != null) return createManagerRole(butler);
    
    // 第二层：查询业主表
    List<Ownerinfo> ownerList = ownerinfoService.phoneNumberOwnerInfo(phoneNumber);
    if (!ownerList.isEmpty()) return createOwnerRole(ownerList.get(0));
    
    // 第三层：查询Member表 (访客)
    Member member = memberService.getMemberByOpenId(openid);
    if (member != null && "已通过".equals(member.getAuditstatus())) {
        return createVisitorRole(member);
    }
    
    // 第四层：待审核状态
    if (member != null && "待审批".equals(member.getAuditstatus())) {
        return createPendingRole(member);
    }
    
    // 第五层：完全未注册
    return createUnregisteredRole();
}
```

## 📱 小程序端实现

### 1. 动态TabBar配置

**文件**: `utils/dynamicTabBar.js`

新增访客TabBar配置：
```javascript
visitor: [
  {
    index: 0,
    pagePath: "pages/reservation/form",
    text: "访客预约",
    show: true
  },
  {
    index: 1,
    pagePath: "pages/reservation/searchResult/searchResult", 
    text: "预约查询",
    show: true
  },
  // 违规和审核功能对访客隐藏
  {
    index: 2,
    pagePath: "pages/violation/owner-new-violation",
    text: "违规车辆",
    show: false
  },
  {
    index: 3,
    pagePath: "pages/site/facility",
    text: "审核",
    show: false
  }
]
```

### 2. 权限系统扩展

**文件**: `utils/permission.js`

新增访客权限：
```javascript
// 访客专用权限
VISITOR_APPOINTMENT: 'visitor.appointment',     // 访客预约
VISITOR_QUERY: 'visitor.query',                 // 访客查询

// 角色权限映射
visitor: [
  PERMISSIONS.VISITOR_APPOINTMENT,
  PERMISSIONS.VISITOR_QUERY,
  PERMISSIONS.APPOINTMENT_CREATE,
  PERMISSIONS.APPOINTMENT_QUERY_OWN
],
pending: [],        // 待审核用户无权限
unregistered: []    // 未注册用户无权限
```

### 3. 认证流程优化

**文件**: `utils/auth.js`

新增角色状态检查：
```javascript
// 新增的角色检查方法
static isVisitor() { return this.getCurrentRole() === 'visitor'; }
static isPending() { return this.getCurrentRole() === 'pending'; }
static isUnregistered() { return this.getCurrentRole() === 'unregistered'; }

// 处理特殊状态
if (role === 'pending') {
  uni.showModal({
    title: '账号待审核',
    content: '您的申请正在审核中，请耐心等待管理员审核',
    showCancel: false
  });
  return { success: false, data: userData, message: '账号待审核' };
}

if (role === 'unregistered') {
  setTimeout(() => {
    this.showRegistrationOptions();
  }, 500);
  return { success: false, data: userData, message: '需要注册' };
}
```

### 4. 登录页面更新

**文件**: `pages/auth/phone-auth.vue`

新增角色选择：
```javascript
// 模拟授权时的角色选择
uni.showActionSheet({
  title: `手机号：${mockPhone}\n请选择您的身份角色`,
  itemList: ['业主', '管家', '访客', '测试待审核', '测试未注册'],
  success: (res) => {
    // 根据选择返回对应的角色数据
    switch(res.tapIndex) {
      case 0: return createOwnerData();
      case 1: return createManagerData();
      case 2: return createVisitorData();
      case 3: return createPendingData();
      case 4: return createUnregisteredData();
    }
  }
});
```

### 5. 访客申请页面

**文件**: `pages/auth/visitor-apply.vue`

完整的访客申请表单：
- 姓名、手机号、性别、身份证号
- 申请原因、联系地址
- 用户协议确认
- 表单验证和提交处理

### 6. 测试页面扩展

**文件**: `pages/test-role.vue`

新增访客角色测试：
```javascript
// 访客角色切换
async switchToVisitor() {
  const AuthUtils = await import('@/utils/auth.js');
  await AuthUtils.default.switchRole('visitor');
  this.loadUserInfo();
}
```

## 🎨 用户体验设计

### 角色主题色彩

- **业主**: #007AFF (蓝色)
- **管家**: #FF6B35 (橙色)  
- **访客**: #52c41a (绿色)

### TabBar显示逻辑

| 角色 | Tab1 | Tab2 | Tab3 | Tab4 |
|------|------|------|------|------|
| 业主 | 预约 | 预约查询 | 违规车辆 | ❌ |
| 管家 | 预约 | 预约查询 | 违规管理 | 审核 |
| 访客 | 访客预约 | 预约查询 | ❌ | ❌ |

### 用户引导流程

1. **微信授权** → 获取手机号和openid
2. **三层查询** → Butler表 → Ownerinfo表 → Member表
3. **状态处理**:
   - 找到角色 → 登录成功，显示对应TabBar
   - 待审核 → 显示等待提示，不进入主界面
   - 未注册 → 显示注册选项（申请访客/联系管理员）

## 🚀 实现效果

### ✅ 已完成功能

1. **完整的三层角色体系**
   - 管家（Butler表）- 4个Tab，完整管理权限
   - 业主（Ownerinfo表）- 3个Tab，个人业务权限
   - 访客（Member表）- 2个Tab，基础预约权限

2. **状态处理机制**
   - 待审核状态：显示等待提示
   - 未注册状态：引导申请注册

3. **权限控制系统**
   - 基于角色的权限映射
   - 页面访问权限检查
   - 功能模块权限验证

4. **用户体验优化**
   - 角色切换动画效果
   - 主题色彩区分
   - 友好的提示信息

### 🔧 待完善功能

1. **后端API集成**
   - 需要修改`WeChatAuthController.phoneAuth()`方法实现三层查询
   - 实现访客申请提交接口
   - 完善Member表的审核机制

2. **管理后台支持**
   - 访客申请审核界面
   - 角色转换管理
   - 权限配置管理

3. **消息通知**
   - 审核结果通知
   - 角色变更通知
   - 权限变化提醒

## 📝 部署建议

1. **数据库准备**
   - 确保Member表有完整的审核字段
   - 检查Butler表和Ownerinfo表的数据完整性

2. **后端修改**
   - 更新身份验证逻辑为三层查询
   - 添加访客申请相关接口
   - 完善审核流程API

3. **前端测试**
   - 测试各角色TabBar切换
   - 验证权限控制逻辑
   - 确认访客申请流程

4. **用户培训**
   - 管理员如何审核访客申请
   - 各角色功能权限说明
   - 新用户注册指引

## 🎉 总结

通过这次升级，系统实现了：

1. **更完整的用户覆盖**: 从二元（业主/管家）升级为完整的用户生态
2. **更灵活的权限控制**: 基于角色的精细化权限管理
3. **更友好的用户体验**: 智能的状态处理和引导流程
4. **更强的扩展性**: 易于添加新角色和权限的架构设计

这个三层角色体系为停车管理系统提供了更完整、更灵活的用户管理解决方案。 