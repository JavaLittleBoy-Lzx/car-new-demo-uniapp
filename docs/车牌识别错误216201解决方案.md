# ğŸ”§ è½¦ç‰Œè¯†åˆ«é”™è¯¯216201è§£å†³æ–¹æ¡ˆ

## ğŸ“‹ é—®é¢˜æè¿°

åœ¨ä½¿ç”¨ç™¾åº¦AIè½¦ç‰Œè¯†åˆ«APIæ—¶ï¼Œé‡åˆ°é”™è¯¯ç 216201ï¼š"image format error"ï¼Œè¡¨ç¤ºå›¾ç‰‡æ ¼å¼é”™è¯¯ã€‚

### é”™è¯¯æ—¥å¿—
```
ç™¾åº¦AIè®¿é—®ä»¤ç‰Œè·å–æˆåŠŸï¼Œæœ‰æ•ˆæœŸ: 2592000 ç§’
ERROR 26636 --- [nio-8543-exec-3] c.p.s.impl.PlateRecognitionServiceImpl   : ç™¾åº¦è½¦ç‰Œè¯†åˆ«APIé”™è¯¯ - é”™è¯¯ç : 216201, é”™è¯¯ä¿¡æ¯: image format error
WARN 26636 --- [nio-8543-exec-3] c.p.c.PlateRecognitionController         : è½¦ç‰Œè¯†åˆ«å¤±è´¥: æœªæ£€æµ‹åˆ°è½¦ç‰Œ
```

## ğŸ” é—®é¢˜åŸå› åˆ†æ

1. **URLç¼–ç é—®é¢˜**ï¼šHttpClientUtilså¯¹base64å›¾ç‰‡æ•°æ®è¿›è¡Œäº†URLç¼–ç ï¼Œç ´åäº†å›¾ç‰‡æ ¼å¼
2. **æ•°æ®å¤´é—®é¢˜**ï¼šå‰ç«¯å¯èƒ½å‘é€äº†åŒ…å«`data:image/jpeg;base64,`ç­‰æ•°æ®å¤´çš„base64å­—ç¬¦ä¸²
3. **ç©ºç™½å­—ç¬¦é—®é¢˜**ï¼šbase64æ•°æ®ä¸­å¯èƒ½åŒ…å«æ¢è¡Œç¬¦ã€ç©ºæ ¼ç­‰å­—ç¬¦

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. åç«¯ä¿®æ”¹

#### 1.1 åˆ›å»ºä¸“ç”¨çš„å›¾ç‰‡è¯·æ±‚æ–¹æ³•
åœ¨`PlateRecognitionServiceImpl.java`ä¸­æ·»åŠ ï¼š

```java
/**
 * å‘é€è½¦ç‰Œè¯†åˆ«è¯·æ±‚
 * ä¸“é—¨å¤„ç†å›¾ç‰‡base64æ•°æ®ï¼Œé¿å…ä¸å¿…è¦çš„ç¼–ç 
 */
private String sendPlateRecognitionRequest(String urlString, String base64Image) throws Exception {
    // ç›´æ¥æ„å»ºå‚æ•°å­—ç¬¦ä¸²ï¼Œä¸å¯¹base64è¿›è¡ŒURLç¼–ç 
    StringBuilder paramBuilder = new StringBuilder();
    paramBuilder.append("image=").append(base64Image);
    paramBuilder.append("&multi_detect=false");
    
    // ... HTTPè¯·æ±‚å¤„ç†é€»è¾‘
}
```

#### 1.2 æ·»åŠ base64æ•°æ®æ¸…ç†æ–¹æ³•
```java
/**
 * æ¸…ç†base64å›¾ç‰‡æ•°æ®
 * ç§»é™¤å¯èƒ½çš„æ•°æ®å¤´å’Œå¤šä½™å­—ç¬¦
 */
private String cleanBase64Image(String base64Image) {
    String cleaned = base64Image.trim();
    
    // ç§»é™¤æ•°æ®å¤´ï¼Œå¦‚: data:image/jpeg;base64,
    if (cleaned.contains(",")) {
        int commaIndex = cleaned.indexOf(",");
        if (commaIndex > 0 && commaIndex < 50) {
            String header = cleaned.substring(0, commaIndex + 1);
            if (header.toLowerCase().startsWith("data:image") && header.contains("base64")) {
                cleaned = cleaned.substring(commaIndex + 1);
            }
        }
    }
    
    // ç§»é™¤æ¢è¡Œç¬¦å’Œç©ºæ ¼
    cleaned = cleaned.replaceAll("\\s", "");
    
    return cleaned;
}
```

#### 1.3 æ›´æ–°å‹å¥½é”™è¯¯ä¿¡æ¯
```java
case "216201":
    return "å›¾ç‰‡æ ¼å¼é”™è¯¯ï¼šè¯·ä½¿ç”¨JPEGã€PNGã€BMPæ ¼å¼çš„å›¾ç‰‡";
```

### 2. å‰ç«¯ä¿®æ”¹

#### 2.1 ä¼˜åŒ–base64å¤„ç†
åœ¨`plate-scanner.vue`ä¸­ï¼š

```javascript
// å›¾ç‰‡è½¬base64
imageToBase64(imagePath) {
  return new Promise((resolve, reject) => {
    uni.getFileSystemManager().readFile({
      filePath: imagePath,
      encoding: 'base64',
      success: (res) => {
        // ç¡®ä¿base64æ•°æ®æ ¼å¼æ­£ç¡®
        let base64Data = res.data;
        if (base64Data) {
          base64Data = base64Data.replace(/\s/g, ''); // ç§»é™¤æ‰€æœ‰ç©ºç™½å­—ç¬¦
        }
        resolve(base64Data);
      },
      fail: reject
    })
  })
}
```

#### 2.2 å¢å¼ºé”™è¯¯å¤„ç†
```javascript
if (result && result.success) {
  // è¯†åˆ«æˆåŠŸå¤„ç†
} else {
  console.error('è¯†åˆ«å¤±è´¥ï¼ŒAPIå“åº”:', result);
  const errorMsg = result && result.errorMessage ? result.errorMessage : 'è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•';
  uni.showToast({
    title: errorMsg,
    icon: 'none',
    duration: 3000
  })
}
```

### 3. è°ƒè¯•å·¥å…·

#### 3.1 æ–°å¢è°ƒè¯•APIç«¯ç‚¹
åœ¨`PlateRecognitionTestController.java`ä¸­æ·»åŠ ï¼š

```java
@ApiOperation("è°ƒè¯•base64å›¾ç‰‡æ ¼å¼")
@PostMapping("/debug-image")
public ResponseEntity<Result<Map<String, Object>>> debugImage(@RequestBody Map<String, String> request) {
    // åˆ†æbase64å›¾ç‰‡æ•°æ®
    // æ£€æŸ¥æ ¼å¼ã€é•¿åº¦ã€ç¼–ç ç­‰
}
```

#### 3.2 è°ƒè¯•ç”¨æ³•
```bash
POST http://localhost:8543/api/plate/test/debug-image
Content-Type: application/json

{
  "image": "ä½ çš„base64å›¾ç‰‡æ•°æ®"
}
```

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. é‡å¯åç«¯æœåŠ¡
```bash
cd parking-demo
mvn spring-boot:run
```

### 2. æµ‹è¯•é…ç½®
```bash
# æ£€æŸ¥ç™¾åº¦AIé…ç½®
GET http://localhost:8543/api/plate/test/config

# æµ‹è¯•è¿æ¥
POST http://localhost:8543/api/plate/test/connection
```

### 3. è°ƒè¯•å›¾ç‰‡æ ¼å¼
ä½¿ç”¨æ–°çš„è°ƒè¯•ç«¯ç‚¹åˆ†æå›¾ç‰‡æ•°æ®ï¼š
```bash
POST http://localhost:8543/api/plate/test/debug-image
```

### 4. æµ‹è¯•è½¦ç‰Œè¯†åˆ«
```bash
POST http://localhost:8543/api/plate/recognize
Content-Type: application/json

{
  "image": "æ¸…ç†åçš„base64å›¾ç‰‡æ•°æ®",
  "detectDirection": true,
  "multiDetect": false,
  "engine": "baidu"
}
```

## ğŸ“Š éªŒè¯ç»“æœ

æˆåŠŸè§£å†³åï¼Œæ—¥å¿—åº”è¯¥æ˜¾ç¤ºï¼š
```
ç™¾åº¦AIè®¿é—®ä»¤ç‰Œè·å–æˆåŠŸï¼Œæœ‰æ•ˆæœŸ: 2592000 ç§’
è°ƒç”¨ç™¾åº¦è½¦ç‰Œè¯†åˆ«API: https://aip.baidubce.com/rest/2.0/ocr/v1/license_plate?access_token=xxx, å›¾ç‰‡å¤§å°: xxxxx
è½¦ç‰Œè¯†åˆ«æˆåŠŸ: è½¦ç‰Œå·=é»‘A12345, é¢œè‰²=è“ç‰Œ, ç½®ä¿¡åº¦=95.6%
```

## ğŸ”§ å…³é”®ä¿®æ”¹ç‚¹æ€»ç»“

1. âœ… **é¿å…URLç¼–ç **ï¼šä¸“ç”¨æ–¹æ³•ç›´æ¥å‘é€base64æ•°æ®
2. âœ… **æ¸…ç†æ•°æ®å¤´**ï¼šè‡ªåŠ¨ç§»é™¤`data:image/xxx;base64,`å‰ç¼€
3. âœ… **ç§»é™¤ç©ºç™½å­—ç¬¦**ï¼šæ¸…ç†æ¢è¡Œç¬¦ã€ç©ºæ ¼ç­‰
4. âœ… **å¢å¼ºé”™è¯¯å¤„ç†**ï¼šæä¾›è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
5. âœ… **æ·»åŠ è°ƒè¯•å·¥å…·**ï¼šåˆ†æå›¾ç‰‡æ ¼å¼é—®é¢˜

## ğŸ¯ é¢„é˜²æªæ–½

1. **å‰ç«¯**: ç¡®ä¿å›¾ç‰‡è¯»å–åç«‹å³æ¸…ç†æ ¼å¼
2. **åç«¯**: ç»Ÿä¸€ä½¿ç”¨ä¸“ç”¨æ–¹æ³•å¤„ç†å›¾ç‰‡æ•°æ®
3. **æµ‹è¯•**: ä½¿ç”¨è°ƒè¯•ç«¯ç‚¹éªŒè¯å›¾ç‰‡æ ¼å¼
4. **ç›‘æ§**: è§‚å¯Ÿé”™è¯¯æ—¥å¿—ï¼ŒåŠæ—¶å‘ç°æ ¼å¼é—®é¢˜

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç™¾åº¦AIè½¦ç‰Œè¯†åˆ«APIæ–‡æ¡£](https://ai.baidu.com/ai-doc/OCR/7k3h7y3db)
- [è½¦ç‰Œè¯†åˆ«æµ‹è¯•æŒ‡å—](./è½¦ç‰Œè¯†åˆ«æµ‹è¯•æŒ‡å—.md)
- [Base64å›¾ç‰‡æ ¼å¼è§„èŒƒ](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/Data_URIs) 