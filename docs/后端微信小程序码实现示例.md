# åç«¯å¾®ä¿¡å°ç¨‹åºç å®ç°ç¤ºä¾‹

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›å®Œæ•´çš„åç«¯å®ç°ä»£ç ï¼Œç”¨äºç”ŸæˆçœŸæ­£çš„å¾®ä¿¡å°ç¨‹åºç ï¼Œå®ç°æ‰«ç ç›´æ¥è·³è½¬åˆ°å°ç¨‹åºåŠŸèƒ½ã€‚

## ğŸ”§ å®ç°æ­¥éª¤

### 1. æ·»åŠ ä¾èµ–ï¼ˆpom.xmlï¼‰

```xml
<!-- å¾®ä¿¡å°ç¨‹åºå¼€å‘åŒ… -->
<dependency>
    <groupId>com.github.binarywang</groupId>
    <artifactId>weixin-java-miniapp</artifactId>
    <version>4.6.0</version>
</dependency>

<!-- HTTPå®¢æˆ·ç«¯ -->
<dependency>
    <groupId>org.apache.httpcomponents</groupId>
    <artifactId>httpclient</artifactId>
    <version>4.5.14</version>
</dependency>

<!-- JSONå¤„ç† -->
<dependency>
    <groupId>com.fasterxml.jackson.core</groupId>
    <artifactId>jackson-databind</artifactId>
</dependency>
```

### 2. é…ç½®æ–‡ä»¶ï¼ˆapplication.ymlï¼‰

```yaml
# å¾®ä¿¡å°ç¨‹åºé…ç½®
wechat:
  miniapp:
    appid: wx1234567890abcdef  # æ›¿æ¢ä¸ºæ‚¨çš„å°ç¨‹åºAppID
    secret: your_secret_here   # æ›¿æ¢ä¸ºæ‚¨çš„å°ç¨‹åºAppSecret
    # access_tokenç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼‰
    token-cache-time: 7000
```

### 3. å¾®ä¿¡é…ç½®ç±»

```java
package com.parkingmanage.config;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import cn.binarywang.wx.miniapp.api.WxMaService;
import cn.binarywang.wx.miniapp.api.impl.WxMaServiceImpl;
import cn.binarywang.wx.miniapp.config.impl.WxMaDefaultConfigImpl;

@Configuration
public class WechatMiniAppConfig {
    
    @Value("${wechat.miniapp.appid}")
    private String appId;
    
    @Value("${wechat.miniapp.secret}")
    private String secret;
    
    @Bean
    public WxMaService wxMaService() {
        WxMaService service = new WxMaServiceImpl();
        WxMaDefaultConfigImpl config = new WxMaDefaultConfigImpl();
        config.setAppid(appId);
        config.setSecret(secret);
        service.setWxMaConfig(config);
        return service;
    }
}
```

### 4. å°ç¨‹åºç ç”ŸæˆæœåŠ¡

```java
package com.parkingmanage.service;

import cn.binarywang.wx.miniapp.api.WxMaService;
import cn.binarywang.wx.miniapp.bean.WxMaCodeLineColor;
import cn.binarywang.wx.miniapp.bean.WxMaQrcodeGenRequest;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.io.File;
import java.nio.file.Files;
import java.util.Base64;

@Slf4j
@Service
public class WechatMiniProgramService {
    
    @Autowired
    private WxMaService wxMaService;
    
    /**
     * ç”Ÿæˆè®¿å®¢é‚€è¯·å°ç¨‹åºç 
     * @param butlerPhone ç®¡å®¶æ‰‹æœºå·
     * @param community å°åŒºåç§°
     * @param addressInfo åœ°å€ä¿¡æ¯
     * @return Base64ç¼–ç çš„å°ç¨‹åºç å›¾ç‰‡
     */
    public String generateVisitorInviteCode(String butlerPhone, String community, 
                                           String province, String city, String district) {
        try {
            log.info("å¼€å§‹ç”Ÿæˆå°ç¨‹åºç : ç®¡å®¶={}, å°åŒº={}", butlerPhone, community);
            
            // æ„å»ºåœºæ™¯å€¼ï¼ˆæœ€å¤š32ä½å­—ç¬¦ï¼‰
            String scene = buildSceneValue(butlerPhone, community, province, city, district);
            log.info("æ„å»ºçš„åœºæ™¯å€¼: {}", scene);
            
            // åˆ›å»ºå°ç¨‹åºç è¯·æ±‚
            WxMaQrcodeGenRequest request = new WxMaQrcodeGenRequest();
            request.setPage("pages/auth/visitor-apply"); // ç›®æ ‡é¡µé¢
            request.setScene(scene); // åœºæ™¯å€¼
            request.setWidth(430); // äºŒç»´ç å®½åº¦
            request.setAutoColor(false); // ä¸ä½¿ç”¨è‡ªåŠ¨é…è‰²
            request.setLineColor(new WxMaCodeLineColor("0", "0", "0")); // é»‘è‰²
            request.setIsHyaline(false); // ä¸é€æ˜
            
            log.info("å°ç¨‹åºç è¯·æ±‚å‚æ•°: page={}, scene={}, width={}", 
                    request.getPage(), request.getScene(), request.getWidth());
            
            // è°ƒç”¨å¾®ä¿¡APIç”Ÿæˆå°ç¨‹åºç 
            File qrCodeFile = wxMaService.getQrcodeService().createWxaCodeUnlimitBytes(request);
            
            // è¯»å–æ–‡ä»¶å¹¶è½¬æ¢ä¸ºBase64
            byte[] qrCodeBytes = Files.readAllBytes(qrCodeFile.toPath());
            String base64Image = "data:image/png;base64," + Base64.getEncoder().encodeToString(qrCodeBytes);
            
            // åˆ é™¤ä¸´æ—¶æ–‡ä»¶
            qrCodeFile.delete();
            
            log.info("å°ç¨‹åºç ç”ŸæˆæˆåŠŸï¼Œå¤§å°: {} bytes", qrCodeBytes.length);
            return base64Image;
            
        } catch (Exception e) {
            log.error("ç”Ÿæˆå°ç¨‹åºç å¤±è´¥", e);
            throw new RuntimeException("ç”Ÿæˆå°ç¨‹åºç å¤±è´¥: " + e.getMessage());
        }
    }
    
    /**
     * æ„å»ºåœºæ™¯å€¼ï¼ˆæœ€å¤š32ä¸ªå­—ç¬¦ï¼‰
     */
    private String buildSceneValue(String butlerPhone, String community, 
                                 String province, String city, String district) {
        try {
            // æå–æ‰‹æœºå·å8ä½
            String phoneShort = butlerPhone.length() >= 8 ? 
                              butlerPhone.substring(butlerPhone.length() - 8) : butlerPhone;
            
            // ç®€åŒ–åœ°åŒºåç§°
            String location = "";
            if (community != null && community.length() > 0) {
                location = community.length() > 6 ? community.substring(0, 6) : community;
            } else if (district != null && district.length() > 0) {
                location = district.length() > 6 ? district.substring(0, 6) : district;
            }
            
            // æ„å»ºåœºæ™¯å€¼: bp=æ‰‹æœºå·&c=åœ°åŒº&t=æ—¶é—´æˆ³
            String timestamp = String.valueOf(System.currentTimeMillis()).substring(8); // å5ä½
            String scene = String.format("bp=%s&c=%s&t=%s", phoneShort, location, timestamp);
            
            // ç¡®ä¿ä¸è¶…è¿‡32ä¸ªå­—ç¬¦
            if (scene.length() > 32) {
                scene = String.format("bp=%s&t=%s", phoneShort, timestamp);
            }
            
            log.info("åœºæ™¯å€¼æ„å»º: åŸå§‹é•¿åº¦={}, æœ€ç»ˆåœºæ™¯å€¼={}", scene.length(), scene);
            return scene;
            
        } catch (Exception e) {
            log.error("æ„å»ºåœºæ™¯å€¼å¤±è´¥", e);
            // é™çº§æ–¹æ¡ˆï¼šåªä½¿ç”¨æ‰‹æœºå·
            String phoneShort = butlerPhone.length() >= 8 ? 
                              butlerPhone.substring(butlerPhone.length() - 8) : butlerPhone;
            return "bp=" + phoneShort;
        }
    }
}
```

### 5. æ›´æ–°ButlerController

```java
package com.parkingmanage.controller;

import com.parkingmanage.service.WechatMiniProgramService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.HashMap;
import java.util.Map;

@Slf4j
@RestController
@RequestMapping("/parking/butler")
public class ButlerController {
    
    @Autowired
    private WechatMiniProgramService wechatMiniProgramService;
    
    /**
     * ç”Ÿæˆå¾®ä¿¡å®˜æ–¹å°ç¨‹åºç 
     */
    @GetMapping("/generateMiniProgramCode")
    public ApiResponse<Map<String, Object>> generateMiniProgramCode(
            @RequestParam String phone,
            @RequestParam(required = false) String pagePath,
            @RequestParam(required = false) String province,
            @RequestParam(required = false) String city,
            @RequestParam(required = false) String district,
            @RequestParam(required = false) String community,
            @RequestParam(required = false) String building,
            @RequestParam(required = false) String units,
            @RequestParam(required = false) String floor,
            @RequestParam(required = false) String room,
            @RequestParam(required = false, defaultValue = "false") Boolean test) {
        
        try {
            log.info("æ”¶åˆ°å°ç¨‹åºç ç”Ÿæˆè¯·æ±‚: phone={}, community={}, test={}", phone, community, test);
            
            // å¦‚æœæ˜¯æµ‹è¯•è¯·æ±‚ï¼Œè¿”å›æµ‹è¯•ä¿¡æ¯
            if (test) {
                Map<String, Object> testResponse = new HashMap<>();
                testResponse.put("type", "wechat_mini_program");
                testResponse.put("status", "backend_ready");
                testResponse.put("message", "åç«¯å·²å‡†å¤‡å¥½ç”Ÿæˆå°ç¨‹åºç ");
                testResponse.put("needConfig", "è¯·é…ç½®å¾®ä¿¡å°ç¨‹åºAppIDå’ŒAppSecret");
                return ApiResponse.success(testResponse);
            }
            
            // ç”Ÿæˆå¾®ä¿¡å®˜æ–¹å°ç¨‹åºç 
            String base64Image = wechatMiniProgramService.generateVisitorInviteCode(
                phone, community, province, city, district);
            
            // æ„å»ºå®Œæ•´åœ°å€
            String fullAddress = buildFullAddress(province, city, district, community, 
                                                building, units, floor, room);
            
            // æ„å»ºå“åº”æ•°æ®
            Map<String, Object> response = new HashMap<>();
            response.put("type", "wechat_mini_program");
            response.put("officialCode", true); // æ ‡è®°ä¸ºå®˜æ–¹å°ç¨‹åºç 
            response.put("qrCodeImage", base64Image); // Base64å›¾ç‰‡æ•°æ®
            response.put("pagePath", "pages/auth/visitor-apply");
            response.put("butlerPhone", phone);
            response.put("fullAddress", fullAddress);
            response.put("timestamp", System.currentTimeMillis());
            
            log.info("å°ç¨‹åºç ç”ŸæˆæˆåŠŸ: phone={}, imageSize={} bytes", 
                    phone, base64Image.length());
            
            return ApiResponse.success(response);
            
        } catch (Exception e) {
            log.error("ç”Ÿæˆå¾®ä¿¡å°ç¨‹åºç å¤±è´¥: phone={}", phone, e);
            
            // è¿”å›é”™è¯¯ä¿¡æ¯
            Map<String, Object> errorResponse = new HashMap<>();
            errorResponse.put("type", "error");
            errorResponse.put("message", "å°ç¨‹åºç ç”Ÿæˆå¤±è´¥: " + e.getMessage());
            errorResponse.put("suggestion", "è¯·æ£€æŸ¥å¾®ä¿¡å°ç¨‹åºé…ç½®æˆ–è”ç³»æŠ€æœ¯æ”¯æŒ");
            
            return ApiResponse.error("ç”Ÿæˆå°ç¨‹åºç å¤±è´¥", errorResponse);
        }
    }
    
    /**
     * æ ¹æ®æ‰‹æœºå·åç¼€æŸ¥è¯¢ç®¡å®¶ä¿¡æ¯ï¼ˆç”¨äºå°ç¨‹åºç åœºæ™¯å€¼è§£æï¼‰
     */
    @GetMapping("/getByPhoneSuffix")
    public ApiResponse<Butler> getByPhoneSuffix(@RequestParam String phoneSuffix) {
        try {
            log.info("æ ¹æ®æ‰‹æœºå·åç¼€æŸ¥è¯¢ç®¡å®¶: {}", phoneSuffix);
            
            // è¿™é‡Œéœ€è¦å®ç°æ ¹æ®æ‰‹æœºå·åç¼€æ¨¡ç³ŠæŸ¥è¯¢ç®¡å®¶çš„é€»è¾‘
            // ç¤ºä¾‹SQL: SELECT * FROM butler WHERE phone LIKE '%' + phoneSuffix
            Butler butler = butlerService.findByPhoneSuffix(phoneSuffix);
            
            if (butler != null) {
                log.info("æ‰¾åˆ°åŒ¹é…çš„ç®¡å®¶: {}", butler.getUsername());
                return ApiResponse.success(butler);
            } else {
                log.warn("æœªæ‰¾åˆ°åŒ¹é…çš„ç®¡å®¶: {}", phoneSuffix);
                return ApiResponse.error("æœªæ‰¾åˆ°åŒ¹é…çš„ç®¡å®¶ä¿¡æ¯");
            }
            
        } catch (Exception e) {
            log.error("æŸ¥è¯¢ç®¡å®¶ä¿¡æ¯å¤±è´¥: phoneSuffix={}", phoneSuffix, e);
            return ApiResponse.error("æŸ¥è¯¢å¤±è´¥: " + e.getMessage());
        }
    }
    
    private String buildFullAddress(String province, String city, String district,
                                  String community, String building, String units,
                                  String floor, String room) {
        StringBuilder address = new StringBuilder();
        if (hasText(province)) address.append(province);
        if (hasText(city)) address.append(city);
        if (hasText(district)) address.append(district);
        if (hasText(community)) address.append(community);
        if (hasText(building)) address.append(building).append("æ ‹");
        if (hasText(units)) address.append(units).append("å•å…ƒ");
        if (hasText(floor)) address.append(floor).append("å±‚");
        if (hasText(room)) address.append(room);
        return address.toString();
    }
    
    private boolean hasText(String str) {
        return str != null && !str.trim().isEmpty();
    }
}
```

### 6. æ•°æ®åº“æŸ¥è¯¢å®ç°

```java
package com.parkingmanage.service.impl;

import com.parkingmanage.entity.Butler;
import com.parkingmanage.mapper.ButlerMapper;
import com.parkingmanage.service.ButlerService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

@Service
public class ButlerServiceImpl implements ButlerService {
    
    @Autowired
    private ButlerMapper butlerMapper;
    
    /**
     * æ ¹æ®æ‰‹æœºå·åç¼€æŸ¥è¯¢ç®¡å®¶
     */
    public Butler findByPhoneSuffix(String phoneSuffix) {
        // ä½¿ç”¨LIKEæŸ¥è¯¢åŒ¹é…æ‰‹æœºå·åç¼€
        return butlerMapper.findByPhoneSuffix(phoneSuffix);
    }
}
```

### 7. Mapperå®ç°

```java
package com.parkingmanage.mapper;

import com.parkingmanage.entity.Butler;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;
import org.apache.ibatis.annotations.Select;

@Mapper
public interface ButlerMapper {
    
    /**
     * æ ¹æ®æ‰‹æœºå·åç¼€æŸ¥è¯¢ç®¡å®¶
     */
    @Select("SELECT * FROM butler WHERE phone LIKE CONCAT('%', #{phoneSuffix}) LIMIT 1")
    Butler findByPhoneSuffix(@Param("phoneSuffix") String phoneSuffix);
}
```

## ğŸš€ éƒ¨ç½²å’Œæµ‹è¯•

### 1. é…ç½®å¾®ä¿¡å°ç¨‹åºä¿¡æ¯

1. ç™»å½• https://mp.weixin.qq.com
2. è·å– AppID å’Œ AppSecret
3. æ›´æ–° application.yml é…ç½®
4. ç¡®ä¿æœåŠ¡å™¨åŸŸåå·²é…ç½®

### 2. æµ‹è¯•æ­¥éª¤

```bash
# 1. æµ‹è¯•åç«¯çŠ¶æ€
curl https://csharphrb.picp.vip/parking/butler/generateMiniProgramCode?phone=13800138000&test=true

# 2. ç”ŸæˆçœŸå®å°ç¨‹åºç 
curl https://csharphrb.picp.vip/parking/butler/generateMiniProgramCode?phone=13800138000&community=æµ‹è¯•å°åŒº

# 3. éªŒè¯è¿”å›æ•°æ®åŒ…å« qrCodeImage å­—æ®µ
```

### 3. å‰ç«¯éªŒè¯

å®Œæˆåç«¯å®ç°åï¼Œå‰ç«¯åº”è¯¥èƒ½ï¼š
- âœ… æ£€æµ‹åˆ°åç«¯è¿”å›äº† `qrCodeImage`
- âœ… æ˜¾ç¤º"å¾®ä¿¡å®˜æ–¹å°ç¨‹åºç ç”ŸæˆæˆåŠŸ"
- âœ… æ‰«ç èƒ½ç›´æ¥è·³è½¬åˆ°å°ç¨‹åº

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **AppSecretä¿æŠ¤**: ä¸è¦å°†AppSecretæäº¤åˆ°ä»£ç ä»“åº“
2. **access_tokenç¼“å­˜**: é¿å…é¢‘ç¹è¯·æ±‚å¾®ä¿¡API
3. **é”™è¯¯å¤„ç†**: å®Œå–„å¼‚å¸¸å¤„ç†å’Œé™çº§æ–¹æ¡ˆ
4. **åœºæ™¯å€¼é™åˆ¶**: ç¡®ä¿åœºæ™¯å€¼ä¸è¶…è¿‡32ä¸ªå­—ç¬¦
5. **APIé™åˆ¶**: æ³¨æ„å¾®ä¿¡APIçš„è°ƒç”¨é¢‘ç‡é™åˆ¶

å®Œæˆä»¥ä¸Šå®ç°åï¼Œæ‚¨çš„å°ç¨‹åºç å°†èƒ½å®ç°çœŸæ­£çš„æ‰«ç è·³è½¬åŠŸèƒ½ï¼ 