# 预约24小时有效期功能实现说明

## 功能需求

### 原需求
- 预约时限制手机号"未入场"的预约数量
- 同一车场不能有多个待入场预约

### 新需求
1. **移除待入场限制**：只要发了码就可以预约，不再限制未入场的预约数量
2. **保留黑名单检查**：黑名单车牌仍需拦截
3. **24小时有效期**：预约通过后24小时内有效，超时自动失效
4. **用户提醒**：提交时明确告知24小时有效期

---

## 前端修改

### 1. 移除待入场限制检查

**文件：** `pagesA/reservation/form.vue` 第3801-3813行

**修改前：**
```javascript
// 检查手机号历史记录
if (this.currentUserRole === 'manager' || this.currentUserRole === 'owner') {
    const vehicleCheck = await this.checkManagerAppointmentLimit();
    if (!vehicleCheck.canSubmit) {
        return;
    }
} else {
    const historyCheck = await this.checkPhoneHistory();
    if (!historyCheck.canSubmit) {
        return;
    }
}
```

**修改后：**
```javascript
// ⚠️ 已移除待入场限制检查
// 新规则：只要发了码就可以预约，不再限制未入场的预约数量
// 黑名单检查已在上方单独处理
console.log('✅ [预约限制] 已移除待入场限制，允许多次预约');
```

**影响范围：**
- 管家预约不再限制业主待入场预约数量
- 访客预约不再限制同一手机号的待入场数量
- 黑名单检查保持不变（第3775-3798行）

---

### 2. 添加24小时有效期提醒

**文件：** `pagesA/reservation/form.vue` 多个位置

#### 2.1 管家代人预约（第5586-5591行）

```javascript
uni.showModal({
    title: '✅ 预约提交成功',
    content: '🎉 管家代人预约已自动通过！\n\n📋 预约状态：已通过审核\n🚪 入场状态：待入场\n⏰ 有效期限：24小时内有效\n\n💡 温馨提示：\n• 预约无需审核，可直接入场\n• ⚠️ 请在24小时内进场，超时将自动失效\n• 请提醒访客按时到达\n• 如有变更请及时联系',
    showCancel: false,
    confirmText: '我知道了'
});
```

#### 2.2 免审核预约（第5594-5599行）

```javascript
uni.showModal({
    title: '✅ 预约提交成功',
    content: '🎉 您的预约已自动通过！\n\n📋 预约状态：免审核通过\n🚪 入场状态：待入场\n⏰ 有效期限：24小时内有效\n\n💡 温馨提示：\n• 该时间段无需审核\n• 可直接前往停车场\n• ⚠️ 请在24小时内进场，超时将自动失效\n• 请按预约时间准时到达\n• 入场时请出示预约信息',
    showCancel: false,
    confirmText: '我知道了'
});
```

#### 2.3 需要审批预约（第5602-5607行）

```javascript
uni.showModal({
    title: '⏳ 预约提交成功',
    content: '📝 您的预约正在等待审批...\n\n📋 预约状态：待审批\n👨‍💼 审核人员：小区管家\n⏰ 有效期限：审批通过后24小时内有效\n\n💡 温馨提示：\n• 管家将在24小时内审核\n• 审核结果将通过短信通知\n• ⚠️ 审批通过后请在24小时内进场，超时将自动失效\n• 可在"我的预约"中查看进度\n• 如有疑问请联系小区管家',
    showCancel: false,
    confirmText: '我知道了'
});
```

#### 2.4 访客邀请预约（第5610-5615行）

```javascript
uni.showModal({
    title: '✅ 预约提交成功',
    content: '🎉 访客预约已通过管家审核！\n\n📋 预约状态：已通过审核\n🚪 入场状态：待入场\n⏰ 有效期限：24小时内有效\n👨‍💼 审核人员：邀请管家\n\n💡 温馨提示：\n• 管家邀请预约无需等待\n• 可直接前往停车场\n• ⚠️ 请在24小时内进场，超时将自动失效\n• 请按预约时间准时到达\n• 感谢管家的邀请安排',
    showCancel: false,
    confirmText: '我知道了'
});
```

**提示要点：**
- ⏰ 明确标注"24小时内有效"
- ⚠️ 突出显示超时失效警告
- 💡 用户友好的温馨提示

---

## 后端修改

### 创建定时任务处理过期预约

**文件：** `src/main/java/com/parkingmanage/task/AppointmentExpirationTask.java`

#### 1. 每小时检查过期预约

```java
@Scheduled(cron = "0 15 * * * ?")
public void checkAndExpireAppointments() {
    // 执行时间：每小时的第15分钟
    // 过期条件：
    // - venuestatus = '待入场'
    // - auditstatus IN ('已通过', '不审核')
    // - recorddate < now - 24小时
    
    // 处理方式：
    // - 更新 venuestatus = '已过期'
    // - 更新 auditdate = now
}
```

**执行时间：** 每小时的第15分钟（例如：1:15, 2:15, 3:15...）

**过期规则：**
1. 预约状态为"待入场"（`venuestatus='待入场'`）
2. 审核状态为已通过（`auditstatus='已通过'` 或 `'不审核'`）
3. 创建时间超过24小时（`recorddate < now - 24小时`）

**处理方式：**
- 将 `venuestatus` 更新为 `'已过期'`
- 记录过期时间到 `auditdate`

#### 2. 每天清理旧的过期记录

```java
@Scheduled(cron = "0 0 2 * * ?")
public void cleanOldExpiredRecords() {
    // 执行时间：每天凌晨2点
    // 清理条件：
    // - venuestatus = '已过期'
    // - auditdate < now - 30天
    
    // 处理方式：物理删除记录
}
```

**执行时间：** 每天凌晨2点

**清理规则：**
- 只删除已过期的记录（`venuestatus='已过期'`）
- 保留30天内的记录用于统计分析
- 避免数据库膨胀

#### 3. 手动触发方法（测试用）

```java
public int manualCheckExpiration() {
    // 手动触发过期检查
    // 返回值：标记为过期的记录数量
}
```

**用途：** 测试环境手动触发过期检查，生产环境使用定时任务

---

## 技术细节

### 定时任务Cron表达式

| 任务 | Cron表达式 | 说明 |
|------|-----------|------|
| 过期检查 | `0 15 * * * ?` | 每小时15分执行 |
| 清理旧记录 | `0 0 2 * * ?` | 每天凌晨2点执行 |

### 数据库字段

| 字段 | 类型 | 说明 |
|------|------|------|
| `venuestatus` | VARCHAR | 入场状态：待入场、已入场、已离场、已过期 |
| `auditstatus` | VARCHAR | 审核状态：待审批、已通过、不审核 |
| `recorddate` | DATETIME | 预约创建时间 |
| `auditdate` | DATETIME | 审核/更新时间 |

### 状态流转

```
预约创建 → 待入场（通过审核）
    ↓ 24小时内
入场 → 已入场 → 已离场
    ↓ 超过24小时
过期 → 已过期（自动标记）
    ↓ 30天后
删除 → 物理删除（定时清理）
```

---

## 测试验证

### 前端测试

1. **提交预约**
   - 管家代人预约
   - 访客扫码预约
   - 普通访客预约

2. **查看提示**
   - 确认显示"24小时内有效"
   - 确认显示超时失效警告

3. **多次预约**
   - 验证同一手机号可多次预约
   - 验证不再限制待入场数量

### 后端测试

1. **手动触发测试**
```java
// 调用手动触发方法
AppointmentExpirationTask task = new AppointmentExpirationTask();
int count = task.manualCheckExpiration();
System.out.println("标记为过期的记录数：" + count);
```

2. **模拟过期数据**
```sql
-- 创建24小时前的测试数据
INSERT INTO appointment (
    venuestatus, auditstatus, recorddate, ownerphone, platenumber
) VALUES (
    '待入场', '已通过', DATE_SUB(NOW(), INTERVAL 25 HOUR), '13800138000', '京A12345'
);

-- 等待定时任务执行或手动触发
-- 验证记录状态更新为'已过期'
```

3. **查看日志**
```
⏰ [定时任务] 开始检查过期预约记录
📊 [定时任务] 找到 3 条过期预约记录，开始处理...
✅ [定时任务] 成功标记 3 条预约为已过期
```

---

## 注意事项

### 1. 不影响已入场的预约
- 定时任务只处理"待入场"状态
- 已入场的预约不受影响
- 已离场的预约不受影响

### 2. 审批流程不影响有效期
- 待审批的预约不会被标记为过期
- 只有审批通过后才开始计算24小时
- 审批通过时间 = `auditdate`

### 3. 黑名单检查保持不变
- 黑名单车牌仍然被拦截
- 其他限制条件保持不变
- 只移除了待入场数量限制

### 4. 定时任务性能考虑
- 每小时只执行一次，不会频繁查询
- 使用批量更新，性能高效
- 避开整点执行，减少数据库压力

---

## 回滚方案

如需回滚到旧版本（限制待入场数量）：

### 前端回滚
1. 恢复 `checkManagerAppointmentLimit()` 方法调用
2. 恢复 `checkPhoneHistory()` 方法调用
3. 移除24小时有效期提示

### 后端回滚
1. 注释 `@Scheduled` 注解，停用定时任务
2. 或删除 `AppointmentExpirationTask.java` 文件

---

## 文档更新日期
2025-12-05

## 相关文件
- 前端：`pagesA/reservation/form.vue`
- 后端：`src/main/java/com/parkingmanage/task/AppointmentExpirationTask.java`
- 文档：`docs/预约24小时有效期功能实现说明.md`
