# æ”¹è¿›åçš„è§’è‰²åˆ¤æ–­é€»è¾‘

## ğŸ¯ æ–°çš„ä¸‰å±‚è§’è‰²ä½“ç³»

### è§’è‰²ä¼˜å…ˆçº§
1. **ç®¡å®¶** (Butlerè¡¨) - æœ€é«˜æƒé™
2. **ä¸šä¸»** (Ownerinfoè¡¨) - ä¸­ç­‰æƒé™  
3. **è®¿å®¢** (Memberè¡¨) - åŸºç¡€æƒé™

### æ”¹è¿›åçš„determineUserRoleæ–¹æ³•

```java
private Map<String, Object> determineUserRole(String phoneNumber, String openid) {
    Map<String, Object> userInfo = new HashMap<>();
    userInfo.put("phone", phoneNumber);
    
    logger.info("å¼€å§‹ä¸‰å±‚è§’è‰²æŸ¥è¯¢ï¼Œæ‰‹æœºå·: [{}], openid: [{}]", phoneNumber, openid);
    
    // ç¬¬ä¸€å±‚ï¼šæŸ¥è¯¢ç®¡å®¶è¡¨ (æœ€é«˜ä¼˜å…ˆçº§)
    Butler butler = butlerService.list().stream()
        .filter(b -> phoneNumber.equals(b.getPhone()))
        .findFirst()
        .orElse(null);
        
    if (butler != null) {
        logger.info("æ‰¾åˆ°ç®¡å®¶è§’è‰²");
        userInfo.put("role", "manager");
        userInfo.put("roleText", "ç®¡å®¶");
        userInfo.put("userInfo", butler);
        userInfo.put("permissions", getManagerPermissions());
        return userInfo;
    }
    
    // ç¬¬äºŒå±‚ï¼šæŸ¥è¯¢ä¸šä¸»è¡¨
    List<Ownerinfo> ownerList = ownerinfoService.phoneNumberOwnerInfo(phoneNumber);
    if (!ownerList.isEmpty()) {
        Ownerinfo owner = ownerList.get(0);
        logger.info("æ‰¾åˆ°ä¸šä¸»è§’è‰²");
        userInfo.put("role", "owner");
        userInfo.put("roleText", "ä¸šä¸»");
        userInfo.put("userInfo", owner);
        userInfo.put("permissions", getOwnerPermissions());
        return userInfo;
    }
    
    // ç¬¬ä¸‰å±‚ï¼šæŸ¥è¯¢Memberè¡¨ (è®¿å®¢)
    Member member = memberService.getMemberByOpenId(openid);
    if (member != null && "å·²é€šè¿‡".equals(member.getAuditstatus())) {
        logger.info("æ‰¾åˆ°è®¿å®¢è§’è‰²");
        userInfo.put("role", "visitor");
        userInfo.put("roleText", "è®¿å®¢");
        userInfo.put("userInfo", member);
        userInfo.put("permissions", getVisitorPermissions());
        return userInfo;
    }
    
    // ç¬¬å››å±‚ï¼šæœªæ‰¾åˆ°ä»»ä½•è§’è‰²æˆ–æœªå®¡æ ¸é€šè¿‡
    if (member != null && "å¾…å®¡æ‰¹".equals(member.getAuditstatus())) {
        logger.info("ç”¨æˆ·ç”³è¯·å¾…å®¡æ ¸");
        userInfo.put("role", "pending");
        userInfo.put("roleText", "å¾…å®¡æ ¸");
        userInfo.put("userInfo", member);
        userInfo.put("permissions", new String[]{});
        userInfo.put("message", "æ‚¨çš„ç”³è¯·æ­£åœ¨å®¡æ ¸ä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…");
        return userInfo;
    }
    
    // å®Œå…¨æœªæ³¨å†Œçš„ç”¨æˆ·
    logger.info("ç”¨æˆ·æœªæ³¨å†Œ");
    userInfo.put("role", "unregistered");
    userInfo.put("roleText", "æœªæ³¨å†Œ");
    userInfo.put("userInfo", null);
    userInfo.put("permissions", new String[]{});
    userInfo.put("message", "è¯·å…ˆç”³è¯·æ³¨å†Œ");
    return userInfo;
}

/**
 * è·å–è®¿å®¢æƒé™åˆ—è¡¨
 */
private String[] getVisitorPermissions() {
    return new String[]{
        "appointment.create",      // åˆ›å»ºè®¿å®¢é¢„çº¦
        "appointment.query.own"    // æŸ¥è¯¢è‡ªå·±çš„é¢„çº¦
    };
}
```

## ğŸ”„ æ”¹è¿›åçš„å®Œæ•´æµç¨‹

### ç”¨æˆ·é¦–æ¬¡ä½¿ç”¨å°ç¨‹åº
```mermaid
graph TD
    A[å¾®ä¿¡æˆæƒè·å–æ‰‹æœºå·å’Œopenid] --> B[ä¸‰å±‚è§’è‰²æŸ¥è¯¢]
    B --> C[æŸ¥è¯¢Butlerè¡¨]
    C --> D{æ˜¯å¦å­˜åœ¨?}
    D -->|æ˜¯| E[è¿”å›ç®¡å®¶è§’è‰²]
    D -->|å¦| F[æŸ¥è¯¢Ownerinfoè¡¨]
    F --> G{æ˜¯å¦å­˜åœ¨?}
    G -->|æ˜¯| H[è¿”å›ä¸šä¸»è§’è‰²]
    G -->|å¦| I[æŸ¥è¯¢Memberè¡¨]
    I --> J{æ˜¯å¦å­˜åœ¨ä¸”å®¡æ ¸é€šè¿‡?}
    J -->|æ˜¯| K[è¿”å›è®¿å®¢è§’è‰²]
    J -->|å¾…å®¡æ ¸| L[è¿”å›å¾…å®¡æ ¸çŠ¶æ€]
    J -->|å¦| M[å¼•å¯¼ç”¨æˆ·ç”³è¯·æ³¨å†Œ]
```

### è®¿å®¢æ³¨å†Œæµç¨‹
```mermaid
graph TD
    A[ç”¨æˆ·é€‰æ‹©ç”³è¯·è®¿å®¢èº«ä»½] --> B[å¡«å†™åŸºæœ¬ä¿¡æ¯]
    B --> C[æäº¤åˆ°Memberè¡¨]
    C --> D[çŠ¶æ€è®¾ä¸ºå¾…å®¡æ‰¹]
    D --> E[ç®¡ç†å‘˜åœ¨MemberAudit.vueå®¡æ ¸]
    E --> F{å®¡æ ¸ç»“æœ}
    F -->|é€šè¿‡| G[ç”¨æˆ·è·å¾—è®¿å®¢æƒé™]
    F -->|æ‹’ç»| H[ç”¨æˆ·æ— æ³•ä½¿ç”¨]
```

## ğŸ“± å°ç¨‹åºTabBaré…ç½®

### è®¿å®¢TabBar (2ä¸ªTab)
```javascript
visitor: [
  {
    index: 0,
    pagePath: "pages/reservation/form",
    text: "è®¿å®¢é¢„çº¦",
    show: true
  },
  {
    index: 1, 
    pagePath: "pages/reservation/searchResult/searchResult",
    text: "é¢„çº¦æŸ¥è¯¢",
    show: true
  },
  // ä¸æ˜¾ç¤ºè¿è§„å’Œå®¡æ ¸åŠŸèƒ½
  {
    index: 2,
    pagePath: "pages/violation/owner-new-violation",
    text: "è¿è§„è½¦è¾†", 
    show: false
  },
  {
    index: 3,
    pagePath: "pages/site/facility",
    text: "å®¡æ ¸",
    show: false
  }
]
```

## ğŸ¨ è§’è‰²ä¸»é¢˜åŒºåˆ†

### è®¿å®¢ä¸»é¢˜
```javascript
visitor: {
  selectedColor: '#52c41a', // è®¿å®¢ç»¿è‰²
  color: '#7A7E83',
  backgroundColor: '#ffffff'
}
```

## ğŸ’¡ ä¼˜åŠ¿

1. **è§’è‰²è¦†ç›–å®Œæ•´**ï¼šç®¡å®¶ã€ä¸šä¸»ã€è®¿å®¢ä¸‰ç§è§’è‰²
2. **æƒé™å±‚æ¬¡æ¸…æ™°**ï¼šä¸åŒè§’è‰²æœ‰ä¸åŒçš„åŠŸèƒ½æƒé™
3. **å®¡æ ¸æœºåˆ¶ä¿ç•™**ï¼šè®¿å®¢ä¹Ÿéœ€è¦å®¡æ ¸ï¼Œç¡®ä¿å®‰å…¨
4. **æ‰©å±•æ€§å¥½**ï¼šæœªæ¥å¯ä»¥æ·»åŠ æ›´å¤šè§’è‰²ç±»å‹
5. **ç”¨æˆ·ä½“éªŒå¥½**ï¼šæ¯ç§è§’è‰²éƒ½æœ‰åˆé€‚çš„åŠŸèƒ½ç•Œé¢

## ğŸ”§ éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

1. **WeChatAuthController.java** - ä¿®æ”¹è§’è‰²åˆ¤æ–­é€»è¾‘
2. **DynamicTabBarManager.js** - æ·»åŠ è®¿å®¢TabBaré…ç½®
3. **permission.js** - æ·»åŠ è®¿å®¢æƒé™å®šä¹‰
4. **phone-auth.vue** - å¤„ç†è®¿å®¢æ³¨å†Œæµç¨‹
5. **å„é¡µé¢æƒé™æ§åˆ¶** - æ ¹æ®è®¿å®¢æƒé™è°ƒæ•´é¡µé¢åŠŸèƒ½ 