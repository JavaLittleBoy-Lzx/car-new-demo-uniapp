# è®¿å®¢äºŒç»´ç 24å°æ—¶æœ‰æ•ˆæœŸå®ç°è¯´æ˜

## åŠŸèƒ½éœ€æ±‚

è®¿å®¢é‚€è¯·äºŒç»´ç ç”Ÿæˆåï¼Œ24å°æ—¶å†…æœ‰æ•ˆã€‚è®¿å®¢æ‰«æäºŒç»´ç æ—¶ï¼Œç³»ç»Ÿæ£€æµ‹å½“å‰æ—¶é—´å’Œåˆ›å»ºæ—¶é—´æ˜¯å¦è¶…è¿‡24å°æ—¶ï¼Œè‹¥è¶…è¿‡åˆ™ä¸å…è®¸é¢„çº¦ã€‚

---

## å®ç°æ–¹æ¡ˆ

### 1. å‰ç«¯æ£€æµ‹ï¼ˆphone-auth.vueï¼‰

#### ä¿®æ”¹ä½ç½®
æ–‡ä»¶ï¼š`pages/auth/phone-auth.vue`

#### æ£€æµ‹é€»è¾‘

åœ¨ `checkVisitorQrCodeUsage()` æ–¹æ³•ä¸­æ·»åŠ è¿‡æœŸæ£€æµ‹ï¼š

```javascript
// ğŸ†• æ£€æŸ¥äºŒç»´ç æ˜¯å¦å·²è¿‡æœŸï¼ˆ24å°æ—¶æœ‰æ•ˆæœŸï¼‰
if (response.data.data.expired) {
    console.warn('â° è®¿å®¢äºŒç»´ç å·²è¿‡æœŸï¼Œç«‹å³æ‹’ç»è®¿é—®');
    const self = this;
    setTimeout(() => {
        self.showQrCodeExpiredError(qrId, response.data.data);
    }, 100);
    return false;
}

if (response.data.data.used) {
    // äºŒç»´ç å·²è¢«ä½¿ç”¨
    ...
} else {
    // äºŒç»´ç æœªä½¿ç”¨ä¸”æœªè¿‡æœŸï¼Œå…è®¸ç»§ç»­
    console.log('âœ… è®¿å®¢äºŒç»´ç æœªä½¿ç”¨ä¸”æœªè¿‡æœŸï¼Œå…è®¸ç»§ç»­');
    return true;
}
```

#### é”™è¯¯æç¤º

æ·»åŠ  `showQrCodeExpiredError()` æ–¹æ³•æ˜¾ç¤ºè¿‡æœŸé”™è¯¯ï¼š

```javascript
showQrCodeExpiredError(qrId, expirationData) {
    const createdTime = expirationData.createdTime ? 
        new Date(expirationData.createdTime).toLocaleString() : 'æœªçŸ¥æ—¶é—´';
    const expiresAt = expirationData.expiresAt ? 
        new Date(expirationData.expiresAt).toLocaleString() : 'æœªçŸ¥æ—¶é—´';

    // ç«‹å³éšè—é¡µé¢å†…å®¹ï¼Œæ˜¾ç¤ºé”å®šçŠ¶æ€
    this.isPageLocked = true;

    uni.showModal({
        title: 'â° äºŒç»´ç å·²è¿‡æœŸ',
        content: `æ­¤è®¿å®¢äºŒç»´ç å·²è¶…è¿‡æœ‰æ•ˆæœŸï¼Œæ— æ³•ç»§ç»­ä½¿ç”¨ã€‚\n\nğŸ“… ç”Ÿæˆæ—¶é—´ï¼š${createdTime}\nâ° è¿‡æœŸæ—¶é—´ï¼š${expiresAt}\nğŸ†” äºŒç»´ç IDï¼š${qrId}\n\nâš ï¸ è®¿å®¢äºŒç»´ç æœ‰æ•ˆæœŸä¸º24å°æ—¶ï¼Œè¯·è”ç³»ç®¡å®¶é‡æ–°ç”ŸæˆäºŒç»´ç ã€‚`,
        showCancel: false,
        confirmText: 'çŸ¥é“äº†'
    });
}
```

#### é¡µé¢é”å®š

è¿‡æœŸåç«‹å³é”å®šé¡µé¢ï¼Œé˜»æ­¢ç»§ç»­æ“ä½œï¼š
```javascript
this.isPageLocked = true;
```

---

### 2. åç«¯æ£€æµ‹ï¼ˆQrCodeController.javaï¼‰

#### ä¿®æ”¹ä½ç½®
æ–‡ä»¶ï¼š`src/main/java/com/parkingmanage/controller/QrCodeController.java`

#### æ£€æµ‹é€»è¾‘

åœ¨ `/parking/qrcode/checkUsed` æ¥å£ä¸­æ·»åŠ 24å°æ—¶æœ‰æ•ˆæœŸæ£€æµ‹ï¼š

```java
if (qrUsage != null) {
    // ğŸ†• æ£€æŸ¥äºŒç»´ç æ˜¯å¦å·²è¿‡æœŸï¼ˆ24å°æ—¶æœ‰æ•ˆæœŸï¼‰
    Date createdDate = qrUsage.getCreatedTime();
    LocalDateTime createdTime = createdDate.toInstant()
        .atZone(ZoneId.systemDefault())
        .toLocalDateTime();
    LocalDateTime now = LocalDateTime.now();
    LocalDateTime expiresAt = createdTime.plusHours(24);
    boolean isExpired = now.isAfter(expiresAt);
    
    if (isExpired) {
        // äºŒç»´ç å·²è¿‡æœŸ
        data.put("expired", true);
        data.put("used", false);
        data.put("createdTime", createdTime);
        data.put("expiresAt", expiresAt);
        logger.warn("â° äºŒç»´ç å·²è¿‡æœŸ: qrId={}, åˆ›å»ºæ—¶é—´={}, è¿‡æœŸæ—¶é—´={}, å½“å‰æ—¶é—´={}", 
            qrId, createdTime, expiresAt, now);
    } else if (qrUsage.getIsUsed() != null && qrUsage.getIsUsed() == 1) {
        // äºŒç»´ç å·²ä½¿ç”¨
        data.put("expired", false);
        data.put("used", true);
        ...
    } else {
        // äºŒç»´ç æœªä½¿ç”¨ä¸”æœªè¿‡æœŸ
        data.put("expired", false);
        data.put("used", false);
        data.put("createdTime", createdTime);
        data.put("expiresAt", expiresAt);
        logger.info("âœ… äºŒç»´ç æœªä½¿ç”¨ä¸”æœªè¿‡æœŸ: qrId={}, è¿‡æœŸæ—¶é—´={}", qrId, expiresAt);
    }
}
```

#### è¿”å›æ•°æ®ç»“æ„

```json
{
  "code": "0",
  "msg": "æŸ¥è¯¢æˆåŠŸ",
  "data": {
    "expired": true/false,      // æ˜¯å¦å·²è¿‡æœŸ
    "used": true/false,          // æ˜¯å¦å·²ä½¿ç”¨
    "createdTime": "2025-12-05T10:00:00",  // åˆ›å»ºæ—¶é—´
    "expiresAt": "2025-12-06T10:00:00",    // è¿‡æœŸæ—¶é—´
    "usedTime": "...",           // ä½¿ç”¨æ—¶é—´ï¼ˆä»…å·²ä½¿ç”¨æ—¶ï¼‰
    "usedBy": "..."              // ä½¿ç”¨è€…ï¼ˆä»…å·²ä½¿ç”¨æ—¶ï¼‰
  }
}
```

#### å¯¼å…¥ä¾èµ–

```java
import java.time.LocalDateTime;
import java.time.ZoneId;
import java.util.Date;
```

---

## æ£€æµ‹æµç¨‹

```
è®¿å®¢æ‰«æäºŒç»´ç 
    â†“
phone-auth.vue é¡µé¢åŠ è½½
    â†“
æ£€æµ‹åˆ° qrId å‚æ•°
    â†“
è°ƒç”¨ checkVisitorQrCodeUsage(qrId)
    â†“
è¯·æ±‚åç«¯ /parking/qrcode/checkUsed
    â†“
åç«¯æ£€æµ‹ï¼š
  â”œâ”€ äºŒç»´ç ä¸å­˜åœ¨ï¼Ÿ â†’ è¿”å› expired=false, used=false
  â”œâ”€ åˆ›å»ºæ—¶é—´ + 24h < å½“å‰æ—¶é—´ï¼Ÿ â†’ è¿”å› expired=true
  â”œâ”€ is_used = 1ï¼Ÿ â†’ è¿”å› used=true
  â””â”€ å¦åˆ™ â†’ è¿”å› expired=false, used=false
    â†“
å‰ç«¯æ¥æ”¶å“åº”ï¼š
  â”œâ”€ expired = trueï¼Ÿ â†’ æ˜¾ç¤ºè¿‡æœŸé”™è¯¯ï¼Œé”å®šé¡µé¢
  â”œâ”€ used = trueï¼Ÿ â†’ æ˜¾ç¤ºå·²ä½¿ç”¨é”™è¯¯ï¼Œé”å®šé¡µé¢
  â””â”€ å¦åˆ™ â†’ å…è®¸ç»§ç»­æˆæƒæµç¨‹
```

---

## çŠ¶æ€ä¼˜å…ˆçº§

æ£€æµ‹é¡ºåºï¼ˆåç«¯ï¼‰ï¼š
1. **äºŒç»´ç ä¸å­˜åœ¨** â†’ è¿”å›æœªè¿‡æœŸã€æœªä½¿ç”¨ï¼ˆå…è®¸ç»§ç»­ï¼Œä½†å¯èƒ½åç»­å¤±è´¥ï¼‰
2. **å·²è¿‡æœŸï¼ˆè¶…è¿‡24å°æ—¶ï¼‰** â†’ ç«‹å³è¿”å› `expired=true`ï¼Œé˜»æ­¢ä½¿ç”¨
3. **å·²ä½¿ç”¨ï¼ˆis_used=1ï¼‰** â†’ è¿”å› `used=true`ï¼Œé˜»æ­¢é‡å¤ä½¿ç”¨
4. **æœªè¿‡æœŸä¸”æœªä½¿ç”¨** â†’ è¿”å› `expired=false, used=false`ï¼Œå…è®¸ç»§ç»­

æ£€æµ‹é¡ºåºï¼ˆå‰ç«¯ï¼‰ï¼š
1. **expired = true** â†’ æ˜¾ç¤ºè¿‡æœŸé”™è¯¯
2. **used = true** â†’ æ˜¾ç¤ºå·²ä½¿ç”¨é”™è¯¯
3. **å¦åˆ™** â†’ å…è®¸ç»§ç»­

---

## ç”¨æˆ·ä½“éªŒ

### è¿‡æœŸæç¤º
```
â° äºŒç»´ç å·²è¿‡æœŸ

æ­¤è®¿å®¢äºŒç»´ç å·²è¶…è¿‡æœ‰æ•ˆæœŸï¼Œæ— æ³•ç»§ç»­ä½¿ç”¨ã€‚

ğŸ“… ç”Ÿæˆæ—¶é—´ï¼š2025-12-05 10:00:00
â° è¿‡æœŸæ—¶é—´ï¼š2025-12-06 10:00:00
ğŸ†” äºŒç»´ç IDï¼šqr_xxxxx

âš ï¸ è®¿å®¢äºŒç»´ç æœ‰æ•ˆæœŸä¸º24å°æ—¶ï¼Œè¯·è”ç³»ç®¡å®¶é‡æ–°ç”ŸæˆäºŒç»´ç ã€‚
```

### é¡µé¢é”å®š
è¿‡æœŸæˆ–å·²ä½¿ç”¨æ—¶ï¼Œé¡µé¢æ˜¾ç¤ºé”å®šé®ç½©ï¼Œé˜»æ­¢ä»»ä½•æ“ä½œï¼š
```html
<view class="page-lock-overlay">
  <view class="lock-content">
    <text class="lock-icon">ğŸ”’</text>
    <text class="lock-title">è®¿é—®å·²è¢«é˜»æ­¢</text>
    <text class="lock-message">æ­¤äºŒç»´ç å·²è¢«ä½¿ç”¨/å·²è¿‡æœŸ...</text>
  </view>
</view>
```

---

## ä¸é¢„çº¦è¿‡æœŸçš„åŒºåˆ«

| é¡¹ç›® | äºŒç»´ç è¿‡æœŸ | é¢„çº¦è¿‡æœŸ |
|------|-----------|---------|
| **å¯¹è±¡** | è®¿å®¢é‚€è¯·äºŒç»´ç  | å·²æäº¤çš„é¢„çº¦è®°å½• |
| **æ£€æµ‹æ—¶æœº** | æ‰«æäºŒç»´ç æ—¶ï¼ˆæˆæƒå‰ï¼‰ | å®šæ—¶ä»»åŠ¡æ£€æµ‹ï¼ˆæ¯å°æ—¶ï¼‰ |
| **æ£€æµ‹ä½ç½®** | `phone-auth.vue` + `/qrcode/checkUsed` | `AppointmentExpirationTask` |
| **è¿‡æœŸæ¡ä»¶** | äºŒç»´ç åˆ›å»ºæ—¶é—´ + 24h | é¢„çº¦åˆ›å»ºæ—¶é—´ + 24h |
| **å¤„ç†æ–¹å¼** | æ‹¦æˆªè®¿é—®ï¼Œæ˜¾ç¤ºé”™è¯¯ | æ›´æ–°çŠ¶æ€ä¸º"å·²è¿‡æœŸ" |
| **ç”¨æˆ·å½±å“** | æ— æ³•è¿›å…¥é¢„çº¦é¡µé¢ | é¢„çº¦è®°å½•æ ‡è®°ä¸ºè¿‡æœŸ |

---

## æ—¥å¿—è¾“å‡º

### åç«¯æ—¥å¿—

**äºŒç»´ç å·²è¿‡æœŸï¼š**
```
â° äºŒç»´ç å·²è¿‡æœŸ: qrId=qr_123, åˆ›å»ºæ—¶é—´=2025-12-05T10:00, è¿‡æœŸæ—¶é—´=2025-12-06T10:00, å½“å‰æ—¶é—´=2025-12-07T15:00
```

**äºŒç»´ç æœªè¿‡æœŸï¼š**
```
âœ… äºŒç»´ç æœªä½¿ç”¨ä¸”æœªè¿‡æœŸ: qrId=qr_123, è¿‡æœŸæ—¶é—´=2025-12-06T10:00
```

### å‰ç«¯æ—¥å¿—

**æ£€æµ‹è¿‡æœŸï¼š**
```
â° è®¿å®¢äºŒç»´ç å·²è¿‡æœŸï¼Œç«‹å³æ‹’ç»è®¿é—®
```

**å…è®¸ç»§ç»­ï¼š**
```
âœ… è®¿å®¢äºŒç»´ç æœªä½¿ç”¨ä¸”æœªè¿‡æœŸï¼Œå…è®¸ç»§ç»­
```

---

## æµ‹è¯•éªŒè¯

### 1. æµ‹è¯•æœªè¿‡æœŸäºŒç»´ç 
1. ç®¡å®¶ç”Ÿæˆæ–°çš„è®¿å®¢é‚€è¯·äºŒç»´ç 
2. è®¿å®¢ç«‹å³æ‰«æï¼ˆ24å°æ—¶å†…ï¼‰
3. âœ… åº”å…è®¸è¿›å…¥æˆæƒé¡µé¢

### 2. æµ‹è¯•å·²è¿‡æœŸäºŒç»´ç 
1. ä¿®æ”¹æ•°æ®åº“ä¸­äºŒç»´ç çš„ `created_time` ä¸º25å°æ—¶å‰
2. è®¿å®¢æ‰«æäºŒç»´ç 
3. âœ… åº”æ˜¾ç¤º"â° äºŒç»´ç å·²è¿‡æœŸ"é”™è¯¯
4. âœ… é¡µé¢åº”è¢«é”å®šï¼Œæ— æ³•ç»§ç»­æ“ä½œ

### 3. æµ‹è¯•è¾¹ç•Œæƒ…å†µ
**23å°æ—¶59åˆ†ï¼ˆæœªè¿‡æœŸï¼‰ï¼š**
- âœ… å…è®¸ä½¿ç”¨

**24å°æ—¶01åˆ†ï¼ˆå·²è¿‡æœŸï¼‰ï¼š**
- âœ… æ‹’ç»ä½¿ç”¨ï¼Œæ˜¾ç¤ºè¿‡æœŸé”™è¯¯

### 4. æµ‹è¯•å·²ä½¿ç”¨çš„äºŒç»´ç 
1. ä½¿ç”¨ä¸€ä¸ªå·²æ ‡è®°ä¸º `is_used=1` çš„äºŒç»´ç 
2. å³ä½¿æœªè¿‡æœŸï¼Œä¹Ÿåº”æ˜¾ç¤º"å·²ä½¿ç”¨"é”™è¯¯
3. âœ… è¿‡æœŸæ£€æµ‹ä¸å½±å“å·²ä½¿ç”¨æ£€æµ‹

---

## æ•°æ®åº“ç›¸å…³

### QrCodeUsage è¡¨å­—æ®µ

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `qr_id` | VARCHAR | äºŒç»´ç ID |
| `created_time` | DATETIME | åˆ›å»ºæ—¶é—´ï¼ˆç”¨äºè®¡ç®—æ˜¯å¦è¿‡æœŸï¼‰ |
| `is_used` | TINYINT | æ˜¯å¦å·²ä½¿ç”¨ï¼š0-æœªä½¿ç”¨ï¼Œ1-å·²ä½¿ç”¨ |
| `used_time` | DATETIME | ä½¿ç”¨æ—¶é—´ |
| `visitor_openid` | VARCHAR | ä½¿ç”¨è€…openid |

### æŸ¥è¯¢ç¤ºä¾‹

```sql
-- æŸ¥è¯¢æ‰€æœ‰å·²è¿‡æœŸä½†æœªä½¿ç”¨çš„äºŒç»´ç 
SELECT qr_id, created_time, 
       TIMESTAMPDIFF(HOUR, created_time, NOW()) as hours_elapsed
FROM qr_code_usage
WHERE is_used = 0
  AND TIMESTAMPDIFF(HOUR, created_time, NOW()) > 24;
```

---

## æ³¨æ„äº‹é¡¹

1. **æ—¶åŒºå¤„ç†**ï¼šä½¿ç”¨ `ZoneId.systemDefault()` ç¡®ä¿æ—¶åŒºä¸€è‡´
2. **ç©ºå€¼æ£€æŸ¥**ï¼šæ£€æŸ¥ `createdDate` æ˜¯å¦ä¸ºç©ºï¼Œé¿å…ç©ºæŒ‡é’ˆå¼‚å¸¸
3. **ä¼˜å…ˆçº§**ï¼šå…ˆæ£€æŸ¥è¿‡æœŸï¼Œå†æ£€æŸ¥ä½¿ç”¨çŠ¶æ€
4. **é¡µé¢é”å®š**ï¼šè¿‡æœŸæˆ–å·²ä½¿ç”¨æ—¶å¿…é¡»é”å®šé¡µé¢ï¼Œé˜²æ­¢ç»•è¿‡æ£€æµ‹
5. **æ—¥å¿—è®°å½•**ï¼šè¯¦ç»†è®°å½•æ£€æµ‹ç»“æœï¼Œä¾¿äºæ’æŸ¥é—®é¢˜

---

## æ–‡æ¡£æ›´æ–°æ—¥æœŸ
2025-12-05

## ç›¸å…³æ–‡ä»¶
- **å‰ç«¯**ï¼š`pages/auth/phone-auth.vue`
- **åç«¯**ï¼š`src/main/java/com/parkingmanage/controller/QrCodeController.java`
- **ç›¸å…³åŠŸèƒ½**ï¼šé¢„çº¦24å°æ—¶æœ‰æ•ˆæœŸï¼ˆ`AppointmentExpirationTask.java`ï¼‰
