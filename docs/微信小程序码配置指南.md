# 微信小程序码配置指南

## 📋 概述

本指南将帮助您配置微信官方小程序码，实现扫码直接跳转到小程序的功能。

## 🎯 目标效果

✅ **配置前**：扫码显示文本内容，需要手动复制
✅ **配置后**：扫码直接跳转到小程序，信息自动填入

## 🔧 配置步骤

### 第一步：微信开发者后台配置

#### 1.1 登录微信公众平台
1. 访问：https://mp.weixin.qq.com
2. 使用小程序管理员微信扫码登录
3. 进入您的小程序管理后台

#### 1.2 获取AppID和AppSecret
1. 在左侧菜单中找到：**开发** → **开发管理** → **开发设置**
2. 记录以下信息：
   - **AppID (小程序ID)**：形如 `wx1234567890abcdef`
   - **AppSecret (小程序密钥)**：点击"生成"或"重置"获取

⚠️ **重要提醒**：
- AppSecret只显示一次，务必保存好
- 不要在代码中硬编码AppSecret
- 建议使用环境变量或配置文件管理

#### 1.3 配置服务器域名
1. 在开发设置页面找到：**服务器域名**
2. 将您的花生壳域名添加到：
   - **request合法域名**：`https://csharphrb.picp.vip`
   - **downloadFile合法域名**：`https://csharphrb.picp.vip`

### 第二步：后端配置实现

#### 2.1 更新配置文件
编辑 `application.yml`：

```yaml
# 微信小程序配置
wechat:
  miniapp:
    appid: wx1234567890abcdef  # 替换为实际的AppID
    secret: your_actual_secret_here  # 替换为实际的AppSecret
    token-cache-time: 7000
```

#### 2.2 实现后端代码
参考文档：`后端微信小程序码实现示例.md`

完成以下关键组件：
- ✅ `WechatMiniAppConfig` - 微信配置类
- ✅ `WechatMiniProgramService` - 小程序码生成服务  
- ✅ 更新 `ButlerController` - 接口实现
- ✅ 数据库查询支持

### 第三步：测试和验证

#### 3.1 后端API测试
```bash
# 测试后端状态
curl "https://csharphrb.picp.vip/parking/butler/generateMiniProgramCode?phone=13800138000&test=true"

# 期望返回：
{
  "code": "0",
  "data": {
    "type": "wechat_mini_program",
    "status": "backend_ready"
  }
}
```

#### 3.2 生成真实小程序码
```bash
# 生成小程序码
curl "https://csharphrb.picp.vip/parking/butler/generateMiniProgramCode?phone=13800138000&community=测试小区"

# 期望包含：
{
  "code": "0", 
  "data": {
    "type": "wechat_mini_program",
    "officialCode": true,
    "qrCodeImage": "data:image/png;base64,iVBORw0KGgo..."
  }
}
```

#### 3.3 前端验证
1. 打开小程序二维码生成页面
2. 点击"🔍 检查后端API状态"按钮
3. 查看检查结果：
   - ✅ **成功**：显示"后端已实现微信官方API"
   - ❌ **失败**：显示具体的错误信息和解决方案

### 第四步：完整测试流程

#### 4.1 生成小程序码
1. 选择访问地址信息
2. 选择"小程序码"类型
3. 点击"生成小程序码"
4. 检查是否显示"微信官方小程序码生成成功"

#### 4.2 扫码测试
1. 使用微信扫一扫扫描生成的二维码
2. **期望效果**：
   - ✅ 直接打开您的小程序
   - ✅ 跳转到访客申请页面
   - ✅ 管家信息和地址自动填入
   - ✅ 访客直接填写申请信息

#### 4.3 访客体验测试
1. 分享小程序码给测试用户
2. 测试用户扫码后的完整流程：
   - 扫码 → 打开小程序 → 自动跳转页面 → 信息已填入 → 提交申请

## 🔍 常见问题解决

### Q1: 提示"AppSecret配置错误"
**解决方案**：
1. 检查AppSecret是否正确复制（没有多余空格）
2. 确认AppSecret是最新生成的（未过期）
3. 验证AppID和AppSecret的对应关系

### Q2: 提示"access_token获取失败"
**解决方案**：
1. 检查网络连接是否通畅
2. 确认服务器能访问微信API（`api.weixin.qq.com`）
3. 检查系统时间是否正确
4. 验证防火墙是否阻止外网访问

### Q3: 提示"场景值超过32位字符限制"
**解决方案**：
1. 检查地址信息是否过长
2. 使用场景值简化策略（已在代码中实现）
3. 优先使用手机号+时间戳的方案

### Q4: 小程序码生成成功但扫码无反应
**解决方案**：
1. 确认小程序已发布（不是开发版）
2. 检查页面路径是否正确：`pages/auth/visitor-apply`
3. 验证场景值解析逻辑是否正确实现
4. 检查小程序是否已审核通过

### Q5: 前端显示"后端未返回小程序码图片"
**解决方案**：
1. 检查后端日志中的错误信息
2. 验证微信API调用是否成功
3. 确认Base64图片数据格式是否正确
4. 检查接口返回的数据结构

## 📱 调试技巧

### 使用前端检查工具
1. 点击"🔍 检查后端API状态"
2. 根据返回信息定位问题：
   - API不可用 → 检查后端服务
   - 配置缺失 → 补充微信配置
   - 格式错误 → 检查返回数据结构

### 查看后端日志
```bash
# 查看Spring Boot日志
tail -f logs/application.log | grep -i wechat

# 关键日志信息：
# - "开始生成小程序码"
# - "场景值构建"  
# - "小程序码生成成功"
# - 错误信息和异常堆栈
```

### 使用微信开发者工具
1. 打开微信开发者工具
2. 扫码预览功能测试场景值解析
3. 调试访客申请页面的参数接收逻辑

## 🎯 成功标志

配置成功后，您应该看到：

✅ **前端提示**：
- "✅ 微信官方小程序码生成成功！"
- "访客扫码后将自动跳转到小程序"

✅ **扫码效果**：
- 微信扫码直接打开小程序
- 自动跳转到访客申请页面
- 管家信息和地址自动填入

✅ **用户体验**：
- 管家分享小程序码
- 访客扫码即可申请
- 无需手动输入任何信息

完成配置后，您的小程序码将实现真正的"扫码即用"体验！

## 📞 技术支持

如遇到问题，请检查：
1. 微信开发者后台配置是否正确
2. 后端服务日志中的具体错误信息  
3. 花生壳域名映射是否正常
4. 防火墙和网络访问权限

建议保留详细的错误日志和配置信息，便于问题定位和解决。 