# 管家二维码生成功能使用说明

## 功能概述

管家二维码生成功能允许管家为特定地址生成专属的访客预约二维码。访客扫描二维码后可直接跳转到预约页面，地址和管家信息将自动预填，大大简化预约流程。

## 功能特点

### 🏠 多级地址选择器
- **完整层级**：省份 → 城市 → 区县 → 小区 → 楼栋 → 单元 → 楼层 → 房间号
- **级联查询**：每级选择后自动查询下级数据
- **后端数据**：所有数据均从后端community表实时查询
- **智能预填**：根据管家信息自动预填默认地址

### 📱 二维码生成
- **包含信息**：地址、管家姓名、管家电话、生成时间
- **扫码跳转**：直接跳转到预约页面
- **信息预填**：自动预填地址和联系方式
- **保存分享**：支持保存到相册和分享功能

## 使用流程

### 管家操作流程

1. **登录系统**
   - 使用管家账号登录小程序

2. **进入二维码生成页面**
   - 点击底部TabBar中的"二维码"按钮
   - 或直接访问 `/pages/butler/qrcode-generator`

3. **选择访问地址**
   ```
   省份选择 → 城市选择 → 区县选择 → 小区选择
   ↓
   楼栋选择 → 单元选择 → 楼层选择 → 房间选择（可选）
   ```

4. **生成二维码**
   - 至少选择到小区级别
   - 点击"生成二维码"按钮
   - 系统生成包含地址和管家信息的二维码

5. **保存或分享**
   - 点击"保存图片"将二维码保存到手机相册
   - 点击"分享二维码"通过微信等方式分享

### 访客使用流程

1. **扫描二维码**
   - 使用微信扫一扫或其他二维码扫描工具

2. **跳转预约页面**
   - 自动跳转到小程序预约页面
   - 显示管家邀请信息提示

3. **完善预约信息**
   - 地址信息已自动预填
   - 管家联系方式已预填
   - 只需选择预约时间、车牌号等信息

4. **提交预约**
   - 完善所有必填信息后提交预约申请

## API接口说明

### 后端接口

#### 1. 地址查询接口
```
GET /parking/community/province           # 查询省份列表
GET /parking/community/city              # 查询城市列表
GET /parking/community/district          # 查询区县列表
GET /parking/community/community         # 查询小区列表
GET /parking/community/building          # 查询楼栋列表
GET /parking/community/units             # 查询单元列表
GET /parking/community/floor             # 查询楼层列表
GET /parking/community/getOnlyRoomNumber # 查询房间号列表
```

#### 2. 二维码生成接口
```
GET /parking/butler/generateQrCodeData
参数：
- openid: 管家openid
- province: 省份（可选）
- city: 城市（可选）
- district: 区县（可选）
- community: 小区（可选）
- building: 楼栋（可选）
- units: 单元（可选）
- floor: 楼层（可选）
- room: 房间号（可选）
```

#### 3. 响应数据格式
```json
{
  "code": "0",
  "msg": "成功",
  "data": {
    "type": "butler_reservation",
    "butlerId": "123",
    "butlerName": "张管家",
    "butlerPhone": "13800138000",
    "timestamp": 1640995200000,
    "addressInfo": {
      "province": "黑龙江省",
      "city": "哈尔滨市",
      "district": "香坊区",
      "community": "四季上东",
      "building": "1",
      "units": "2",
      "floor": "3",
      "room": "301"
    },
    "fullAddress": "黑龙江省哈尔滨市香坊区四季上东1栋2单元3层301室"
  }
}
```

### 前端配置

#### 1. 页面路由配置
```json
{
  "path": "pages/butler/qrcode-generator",
  "style": {
    "navigationBarTitleText": "访客预约二维码",
    "navigationBarBackgroundColor": "#0081ff",
    "navigationBarTextStyle": "white",
    "enablePullDownRefresh": false
  }
}
```

#### 2. TabBar配置
```javascript
// 管家角色TabBar配置
manager: [
  // ...其他Tab
  {
    pagePath: "pages/butler/qrcode-generator",
    text: "二维码",
    iconPath: "/static/2.jpg",
    selectedIconPath: "/static/2.jpg"
  }
]
```

## 技术实现

### 前端技术栈
- **框架**：uni-app
- **UI组件**：uview-ui
- **地址选择**：级联选择器（u-picker）
- **二维码**：Canvas绘制（可集成专业二维码库）

### 后端技术栈
- **框架**：Spring Boot
- **数据库**：MySQL
- **ORM**：MyBatis Plus
- **数据表**：Community表

### 数据库表结构
```sql
-- Community表关键字段
community (
  id INT PRIMARY KEY,
  province VARCHAR(50),    -- 省份
  city VARCHAR(50),        -- 城市
  district VARCHAR(50),    -- 区县
  community VARCHAR(100),  -- 小区名称
  building VARCHAR(20),    -- 楼栋
  units INT,              -- 单元
  floor INT,              -- 楼层
  roomnumber INT          -- 房间号
)
```

## 注意事项

### 权限控制
- 二维码生成功能仅对管家角色可见
- 其他角色的TabBar不显示"二维码"选项

### 数据验证
- 地址选择必须至少到小区级别
- 上级地址变更时，下级地址自动重置
- 防止无效数据提交

### 用户体验
- 管家信息自动预填，减少操作步骤
- 级联选择器响应迅速，提供良好交互体验
- 二维码生成后可立即保存和分享

### 错误处理
- 网络请求失败时显示友好提示
- 数据加载失败时支持重试
- 二维码生成失败时给出明确原因

## 扩展功能

### 可选增强
1. **批量生成**：支持批量生成多个地址的二维码
2. **模板定制**：支持自定义二维码样式和内容
3. **使用统计**：统计二维码使用情况和效果
4. **有效期设置**：为二维码设置有效期限制

### 集成建议
1. **专业二维码库**：建议集成qrcode.js等专业库
2. **图片压缩**：优化二维码图片大小
3. **云存储**：考虑将二维码保存到云存储
4. **推送通知**：访客扫码时通知管家

## 故障排除

### 常见问题

**Q: 地址选择器无法加载数据**
A: 检查后端API是否正常，确认community表数据完整性

**Q: 二维码生成失败**
A: 确认管家信息完整，检查选择的地址级别是否达到要求

**Q: 扫码跳转失败**
A: 确认小程序配置正确，检查二维码数据格式

**Q: TabBar不显示二维码选项**
A: 确认当前用户角色为manager（管家）

### 技术支持
如遇到技术问题，请检查：
1. 后端服务是否正常运行
2. 数据库连接是否正常
3. 小程序配置是否正确
4. 用户权限是否正确设置 