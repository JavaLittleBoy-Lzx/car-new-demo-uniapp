# å¾®ä¿¡å°ç¨‹åºç ç”ŸæˆåŠŸèƒ½è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

æœ¬æ–‡æ¡£ä»‹ç»äº†å¦‚ä½•åœ¨ç®¡å®¶äºŒç»´ç ç”Ÿæˆé¡µé¢ä¸­é›†æˆå¾®ä¿¡å®˜æ–¹å°ç¨‹åºç ç”ŸæˆåŠŸèƒ½ã€‚è¯¥åŠŸèƒ½æ”¯æŒç”Ÿæˆä¸¤ç§ç±»å‹çš„äºŒç»´ç ï¼š

1. **æ–‡æœ¬äºŒç»´ç **ï¼šåŒ…å«é¢„çº¦ä¿¡æ¯çš„æ™®é€šäºŒç»´ç 
2. **å¾®ä¿¡å°ç¨‹åºç **ï¼šåŸºäºå¾®ä¿¡å®˜æ–¹APIç”Ÿæˆçš„æ–¹å½¢å°ç¨‹åºç ï¼Œæ‰«ç å¯ç›´æ¥è·³è½¬åˆ°å°ç¨‹åºé¢„çº¦é¡µé¢

## å‚è€ƒèµ„æ–™

æœ¬åŠŸèƒ½åŸºäºCSDNæ–‡ç« ã€Šå¾®ä¿¡å°ç¨‹åºç”Ÿæˆæ–¹å½¢äºŒç»´ç å¯è‡ªå®šä¹‰é¡µé¢ã€‹çš„å®ç°æ€è·¯ï¼š
- æ–‡ç« é“¾æ¥ï¼šhttps://blog.csdn.net/weixin_44345217/article/details/148371736
- ä¸»è¦ä½¿ç”¨å¾®ä¿¡å®˜æ–¹çš„ `createQRCode` æ¥å£ç”Ÿæˆæ–¹å½¢å°ç¨‹åºç 

## åŠŸèƒ½ç‰¹ç‚¹

### ğŸ¯ æ™ºèƒ½é€‰æ‹©
- é»˜è®¤æ¨èä½¿ç”¨å°ç¨‹åºç ï¼ˆç”¨æˆ·ä½“éªŒæ›´å¥½ï¼‰
- æ”¯æŒåˆ‡æ¢åˆ°æ™®é€šæ–‡æœ¬äºŒç»´ç ï¼ˆå…¼å®¹æ€§æ›´å¼ºï¼‰

### ğŸ”„ æ— ç¼é›†æˆ
- æ‰«æå°ç¨‹åºç ç›´æ¥è·³è½¬åˆ°é¢„çº¦é¡µé¢
- è‡ªåŠ¨é¢„å¡«ç®¡å®¶ä¿¡æ¯å’Œåœ°å€
- æ— éœ€æ‰‹åŠ¨è¾“å…¥ï¼Œæå‡ç”¨æˆ·ä½“éªŒ

### ğŸ›¡ï¸ ç¨³å®šå¯é 
- å¾®ä¿¡APIä¸å¯ç”¨æ—¶è‡ªåŠ¨é™çº§åˆ°å ä½ç¬¦
- å¤šé‡é”™è¯¯å¤„ç†æœºåˆ¶
- å¼€å‘æµ‹è¯•å‹å¥½

## å‰ç«¯å®ç°

### 1. é¡µé¢ç»“æ„è°ƒæ•´

åœ¨ `pages/butler/qrcode-generator.vue` ä¸­æ·»åŠ äº†äºŒç»´ç ç±»å‹é€‰æ‹©å™¨ï¼š

```vue
<!-- äºŒç»´ç ç±»å‹é€‰æ‹© -->
<view class="qr-type-section">
  <view class="type-title">
    <tui-icon name="setting" size="16" color="#025def"></tui-icon>
    <text class="title-text">äºŒç»´ç ç±»å‹</text>
  </view>
  <view class="type-options">
    <view class="type-option" :class="{ active: qrCodeType === 'text' }" @click="qrCodeType = 'text'">
      <view class="option-content">
        <text class="option-title">æ–‡æœ¬äºŒç»´ç </text>
        <text class="option-desc">åŒ…å«é¢„çº¦ä¿¡æ¯çš„æ™®é€šäºŒç»´ç </text>
      </view>
      <view class="option-icon">{{ qrCodeType === 'text' ? 'âœ“' : '' }}</view>
    </view>
    <view class="type-option" :class="{ active: qrCodeType === 'miniprogram' }" @click="qrCodeType = 'miniprogram'">
      <view class="option-content">
        <text class="option-title">å°ç¨‹åºç </text>
        <text class="option-desc">æ‰«ç ç›´æ¥è·³è½¬åˆ°é¢„çº¦é¡µé¢ï¼ˆæ¨èï¼‰</text>
      </view>
      <view class="option-icon">{{ qrCodeType === 'miniprogram' ? 'âœ“' : '' }}</view>
    </view>
  </view>
</view>
```

### 2. æ•°æ®å’Œæ–¹æ³•

```javascript
data() {
  return {
    // ...ç°æœ‰æ•°æ®
    qrCodeType: 'miniprogram' // é»˜è®¤é€‰æ‹©å°ç¨‹åºç 
  }
},

methods: {
  // ç”ŸæˆæŒ‰é’®æ–‡æœ¬
  getGenerateButtonText() {
    if (this.qrCodeData) {
      return this.qrCodeType === 'miniprogram' ? 'é‡æ–°ç”Ÿæˆå°ç¨‹åºç ' : 'é‡æ–°ç”ŸæˆäºŒç»´ç ';
    } else {
      return this.qrCodeType === 'miniprogram' ? 'ç”Ÿæˆå°ç¨‹åºç ' : 'ç”ŸæˆäºŒç»´ç ';
    }
  },

  // ç”Ÿæˆå°ç¨‹åºç 
  async generateMiniProgramCode(openid) {
    const response = await request({
      url: apiUrls.butler.generateMiniProgramCode,
      method: 'GET',
      data: {
        openid: openid,
        ...this.selectedAddress
      }
    });
    
    if (response.code === '0' && response.data) {
      if (response.data.type === 'wechat_mini_program') {
        this.qrCodeData = response.data;
        
        // å¦‚æœæœ‰Base64å›¾ç‰‡ï¼Œç›´æ¥æ˜¾ç¤º
        if (response.data.qrCodeImage) {
          this.displayBase64Image(response.data.qrCodeImage);
        } else {
          // å¦åˆ™ä½¿ç”¨æ™®é€šäºŒç»´ç ç”Ÿæˆé¡µé¢è·¯å¾„
          this.qrCodeText = response.data.pagePath;
          await this.drawQrCode();
        }
        
        uni.showToast({
          title: 'å°ç¨‹åºç ç”ŸæˆæˆåŠŸ',
          icon: 'success'
        });
      }
    }
  }
}
```

### 3. APIé…ç½®

åœ¨ `config/api.js` ä¸­æ·»åŠ æ–°çš„æ¥å£ï¼š

```javascript
butler: {
  // ...ç°æœ‰æ¥å£
  generateMiniProgramCode: '/parking/butler/generateMiniProgramCode'
}
```

## åç«¯å®ç°

### 1. æ§åˆ¶å™¨æ–¹æ³•

åœ¨ `ButlerController.java` ä¸­æ·»åŠ äº† `generateMiniProgramCode` æ–¹æ³•ï¼š

```java
@ApiOperation("ç”Ÿæˆå¾®ä¿¡å°ç¨‹åºç ")
@GetMapping("/generateMiniProgramCode")
public ResponseEntity<Result> generateMiniProgramCode(
    @RequestParam String openid,
    @RequestParam(required = false) String province,
    @RequestParam(required = false) String city,
    @RequestParam(required = false) String district,
    @RequestParam(required = false) String community,
    @RequestParam(required = false) String building,
    @RequestParam(required = false) String units,
    @RequestParam(required = false) String floor,
    @RequestParam(required = false) String room) {
    
    // è·å–ç®¡å®¶ä¿¡æ¯
    Butler butler = butlerService.getButlerByOpenId(openid);
    if (butler == null) {
        Result result = new Result();
        result.setCode("1");
        result.setMsg("ç®¡å®¶ä¿¡æ¯ä¸å­˜åœ¨");
        return ResponseEntity.ok(result);
    }
    
    // æ„å»ºå°ç¨‹åºé¡µé¢è·¯å¾„å’Œå‚æ•°
    StringBuilder pagePath = new StringBuilder("pages/reservation/form");
    // ...å‚æ•°æ„å»ºé€»è¾‘
    
    // è°ƒç”¨å¾®ä¿¡APIç”Ÿæˆå°ç¨‹åºç 
    String qrCodeBase64 = generateWechatMiniProgramCode(pagePath.toString());
    
    // è¿”å›æ•°æ®
    Map<String, Object> qrData = new HashMap<>();
    qrData.put("type", "wechat_mini_program");
    qrData.put("qrCodeImage", qrCodeBase64);
    qrData.put("pagePath", pagePath.toString());
    // ...å…¶ä»–æ•°æ®
    
    Result result = new Result();
    result.setData(qrData);
    return ResponseEntity.ok(result);
}
```

### 2. å¾®ä¿¡APIè°ƒç”¨

```java
private String generateWechatMiniProgramCode(String pagePath) throws Exception {
    String appId = "wxYourAppId";  // æ›¿æ¢ä¸ºå®é™…çš„AppID
    String appSecret = "YourAppSecret";  // æ›¿æ¢ä¸ºå®é™…çš„AppSecret
    
    RestTemplate restTemplate = new RestTemplate();
    ObjectMapper objectMapper = new ObjectMapper();
    
    try {
        // 1. è·å–Access Token
        String tokenUrl = String.format(
            "https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=%s&secret=%s", 
            appId, appSecret);
        
        String tokenResponse = restTemplate.getForObject(tokenUrl, String.class);
        JsonNode tokenNode = objectMapper.readTree(tokenResponse);
        String accessToken = tokenNode.get("access_token").asText();
        
        // 2. è°ƒç”¨createQRCodeæ¥å£ç”Ÿæˆæ–¹å½¢äºŒç»´ç 
        String apiUrl = String.format(
            "https://api.weixin.qq.com/cgi-bin/wxaapp/createwxaqrcode?access_token=%s", 
            accessToken);
        
        Map<String, Object> requestBody = new HashMap<>();
        requestBody.put("path", pagePath);
        requestBody.put("width", 430);
        
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);
        HttpEntity<Map<String, Object>> request = new HttpEntity<>(requestBody, headers);
        
        // è·å–äºŒè¿›åˆ¶å›¾ç‰‡æ•°æ®
        byte[] qrCodeBytes = restTemplate.postForObject(apiUrl, request, byte[].class);
        
        // è½¬æ¢ä¸ºBase64
        String base64Image = Base64.getEncoder().encodeToString(qrCodeBytes);
        return "data:image/png;base64," + base64Image;
        
    } catch (Exception e) {
        // é™çº§å¤„ç†
        return generatePlaceholderQrCode();
    }
}
```

## é…ç½®è¯´æ˜

### 1. å¾®ä¿¡å°ç¨‹åºé…ç½®

åœ¨ä½¿ç”¨å‰éœ€è¦é…ç½®å¾®ä¿¡å°ç¨‹åºçš„AppIDå’ŒAppSecretï¼š

```java
// åœ¨ButlerController.javaä¸­ä¿®æ”¹
String appId = "wx1234567890abcdef";     // æ›¿æ¢ä¸ºä½ çš„AppID
String appSecret = "abcdef1234567890";   // æ›¿æ¢ä¸ºä½ çš„AppSecret
```

**è·å–æ–¹å¼ï¼š**
1. ç™»å½• [å¾®ä¿¡å…¬ä¼—å¹³å°](https://mp.weixin.qq.com/)
2. è¿›å…¥å°ç¨‹åºç®¡ç†åå°
3. å¼€å‘ â†’ å¼€å‘è®¾ç½®
4. å¤åˆ¶AppIDå’ŒAppSecret

### 2. æ¥å£æƒé™

ç¡®ä¿å°ç¨‹åºå·²å¼€é€šä»¥ä¸‹æƒé™ï¼š
- ç”Ÿæˆå°ç¨‹åºç æƒé™
- æœåŠ¡å™¨åŸŸåå·²é…ç½®

### 3. é¡µé¢è·¯å¾„é…ç½®

å°ç¨‹åºç ç”Ÿæˆçš„é¡µé¢è·¯å¾„æ ¼å¼ï¼š
```
pages/reservation/form?type=butler_reservation&butlerId=123&butlerName=å¼ ç®¡å®¶&butlerPhone=13800138000&address=è¯¦ç»†åœ°å€
```

## ä½¿ç”¨æµç¨‹

### 1. ç®¡å®¶æ“ä½œæµç¨‹

1. æ‰“å¼€ç®¡å®¶TabBarä¸­çš„"äºŒç»´ç "é¡µé¢
2. é€‰æ‹©å®Œæ•´çš„8çº§åœ°å€ä¿¡æ¯
3. é€‰æ‹©äºŒç»´ç ç±»å‹ï¼ˆæ¨èé€‰æ‹©"å°ç¨‹åºç "ï¼‰
4. ç‚¹å‡»"ç”Ÿæˆå°ç¨‹åºç "æŒ‰é’®
5. ç”ŸæˆæˆåŠŸåå¯ä¿å­˜æˆ–åˆ†äº«ç»™è®¿å®¢

### 2. è®¿å®¢æ‰«ç æµç¨‹

1. ä½¿ç”¨å¾®ä¿¡æ‰«ä¸€æ‰«åŠŸèƒ½æ‰«æå°ç¨‹åºç 
2. è‡ªåŠ¨è·³è½¬åˆ°å°ç¨‹åºé¢„çº¦é¡µé¢
3. åœ°å€å’Œç®¡å®¶ä¿¡æ¯å·²è‡ªåŠ¨é¢„å¡«
4. å®Œæˆå…¶ä»–é¢„çº¦ä¿¡æ¯å¡«å†™
5. æäº¤é¢„çº¦ç”³è¯·

## æŠ€æœ¯ä¼˜åŠ¿

### 1. ç”¨æˆ·ä½“éªŒ
- **ç›´æ¥è·³è½¬**ï¼šæ‰«ç åç›´æ¥è¿›å…¥é¢„çº¦é¡µé¢
- **ä¿¡æ¯é¢„å¡«**ï¼šæ— éœ€æ‰‹åŠ¨è¾“å…¥åœ°å€å’Œè”ç³»æ–¹å¼
- **æµç¨‹ç®€åŒ–**ï¼šå‡å°‘æ“ä½œæ­¥éª¤ï¼Œæå‡è½¬åŒ–ç‡

### 2. æŠ€æœ¯å®ç°
- **å®˜æ–¹API**ï¼šä½¿ç”¨å¾®ä¿¡å®˜æ–¹createQRCodeæ¥å£
- **æ–¹å½¢ç **ï¼šç”Ÿæˆæ ‡å‡†çš„æ–¹å½¢äºŒç»´ç ï¼Œä¾¿äºæ‰“å°
- **é«˜æ¸…æ™°åº¦**ï¼šæ”¯æŒ430pxé«˜æ¸…æ™°åº¦è¾“å‡º

### 3. å…¼å®¹æ€§
- **é™çº§ç­–ç•¥**ï¼šAPIä¸å¯ç”¨æ—¶æä¾›å ä½ç¬¦
- **åŒé‡é€‰æ‹©**ï¼šæ”¯æŒä¼ ç»Ÿæ–‡æœ¬äºŒç»´ç å¤‡é€‰
- **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„å¼‚å¸¸å¤„ç†æœºåˆ¶

## æ³¨æ„äº‹é¡¹

### 1. å¼€å‘ç¯å¢ƒ
- å¼€å‘é˜¶æ®µå¯èƒ½æ— æ³•è·å–çœŸå®çš„å°ç¨‹åºç 
- ä¼šæ˜¾ç¤ºå ä½ç¬¦å›¾ç‰‡ï¼Œä½†ä¸å½±å“åŠŸèƒ½æµ‹è¯•
- ç”Ÿäº§ç¯å¢ƒéœ€è¦é…ç½®æ­£ç¡®çš„AppIDå’ŒAppSecret

### 2. æ¥å£é™åˆ¶
- å¾®ä¿¡APIæœ‰è°ƒç”¨é¢‘ç‡é™åˆ¶
- å»ºè®®ç”Ÿäº§ç¯å¢ƒå¢åŠ ç¼“å­˜æœºåˆ¶
- æ³¨æ„AccessTokençš„æœ‰æ•ˆæœŸç®¡ç†

### 3. é¡µé¢è·¯å¾„
- ç¡®ä¿é¡µé¢è·¯å¾„åœ¨å°ç¨‹åºä¸­å­˜åœ¨
- å‚æ•°è¿‡é•¿å¯èƒ½è¢«æˆªæ–­ï¼Œéœ€è¦ä¼˜åŒ–
- å»ºè®®ä½¿ç”¨çŸ­é“¾æ¥æˆ–å‚æ•°å‹ç¼©

## æµ‹è¯•éªŒè¯

### 1. åŠŸèƒ½æµ‹è¯•
```bash
# æµ‹è¯•å°ç¨‹åºç ç”Ÿæˆæ¥å£
curl -X GET "http://localhost:8080/parking/butler/generateMiniProgramCode" \
  -d "openid=test123&province=é»‘é¾™æ±Ÿçœ&city=å“ˆå°”æ»¨å¸‚&community=æµ‹è¯•å°åŒº"
```

### 2. é¢„æœŸç»“æœ
```json
{
  "code": "0",
  "data": {
    "type": "wechat_mini_program",
    "qrCodeImage": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA...",
    "pagePath": "pages/reservation/form?type=butler_reservation...",
    "butlerName": "å¼ ç®¡å®¶",
    "butlerPhone": "13800138000",
    "fullAddress": "é»‘é¾™æ±Ÿçœå“ˆå°”æ»¨å¸‚æµ‹è¯•å°åŒº",
    "timestamp": 1704067200000
  }
}
```

## æ‰©å±•åŠŸèƒ½

### 1. æ‰¹é‡ç”Ÿæˆ
å¯ä»¥æ‰©å±•ä¸ºæ‰¹é‡ç”Ÿæˆå¤šä¸ªå°ç¨‹åºç ï¼Œé€‚ç”¨äºï¼š
- ä¸åŒæ¥¼æ ‹çš„ç®¡å®¶
- ä¸åŒæ—¶é—´æ®µçš„é¢„çº¦
- ä¸åŒç±»å‹çš„æœåŠ¡

### 2. æ ·å¼è‡ªå®šä¹‰
å¾®ä¿¡APIæ”¯æŒæ›´å¤šè‡ªå®šä¹‰é€‰é¡¹ï¼š
- äºŒç»´ç é¢œè‰²
- LogoåµŒå…¥
- å°ºå¯¸è°ƒæ•´

### 3. ç»Ÿè®¡åˆ†æ
å¯ä»¥æ·»åŠ æ‰«ç ç»Ÿè®¡åŠŸèƒ½ï¼š
- æ‰«ç æ¬¡æ•°ç»Ÿè®¡
- è½¬åŒ–ç‡åˆ†æ
- ç”¨æˆ·è¡Œä¸ºè·Ÿè¸ª

## æ€»ç»“

æœ¬åŠŸèƒ½æˆåŠŸé›†æˆäº†å¾®ä¿¡å®˜æ–¹å°ç¨‹åºç ç”Ÿæˆèƒ½åŠ›ï¼Œæä¾›äº†æ›´å¥½çš„ç”¨æˆ·ä½“éªŒå’Œæ›´ç®€åŒ–çš„é¢„çº¦æµç¨‹ã€‚é€šè¿‡åˆç†çš„é™çº§ç­–ç•¥å’Œé”™è¯¯å¤„ç†ï¼Œç¡®ä¿äº†åŠŸèƒ½çš„ç¨³å®šæ€§å’Œå¯é æ€§ã€‚

åœ¨å®é™…éƒ¨ç½²æ—¶ï¼Œè¯·ç¡®ä¿ï¼š
1. æ­£ç¡®é…ç½®å¾®ä¿¡å°ç¨‹åºçš„AppIDå’ŒAppSecret
2. æµ‹è¯•ç”Ÿæˆçš„å°ç¨‹åºç èƒ½å¤Ÿæ­£å¸¸è·³è½¬
3. éªŒè¯é¢„çº¦é¡µé¢çš„å‚æ•°å¤„ç†é€»è¾‘
4. ç›‘æ§APIè°ƒç”¨é¢‘ç‡å’ŒæˆåŠŸç‡ 