# å¾®ä¿¡å°ç¨‹åºç éƒ¨ç½²æŒ‡å—

## ğŸ¯ é—®é¢˜è¯´æ˜

å½“å‰æ‰«ç æ˜¾ç¤ºçš„æ˜¯æ–‡æœ¬å†…å®¹ï¼Œä¸ä¼šè‡ªåŠ¨è·³è½¬åˆ°å°ç¨‹åºã€‚éœ€è¦é…ç½®å¾®ä¿¡å®˜æ–¹å°ç¨‹åºç APIã€‚

## ğŸ“‹ å®Œæ•´é…ç½®æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šå¾®ä¿¡å¼€å‘è€…åå°é…ç½®

1. ç™»å½•å¾®ä¿¡å…¬ä¼—å¹³å°ï¼šhttps://mp.weixin.qq.com
2. è¿›å…¥æ‚¨çš„å°ç¨‹åºç®¡ç†åå°
3. å¼€å‘ â†’ å¼€å‘ç®¡ç† â†’ å¼€å‘è®¾ç½®
4. è®°å½• AppID å’Œ AppSecret

### ç¬¬äºŒæ­¥ï¼šåç«¯APIé…ç½®

éœ€è¦åœ¨åç«¯å®ç°çœŸæ­£çš„å¾®ä¿¡å°ç¨‹åºç ç”Ÿæˆæ¥å£ï¼š

#### 1. è·å–access_tokenæ¥å£
```java
// ç¤ºä¾‹Javaä»£ç 
@GetMapping("/wechat/access-token")
public String getAccessToken() {
    String url = "https://api.weixin.qq.com/cgi-bin/token" +
                "?grant_type=client_credential" +
                "&appid=" + APPID +
                "&secret=" + APPSECRET;
    // è°ƒç”¨å¾®ä¿¡APIè·å–access_token
}
```

#### 2. ç”Ÿæˆå°ç¨‹åºç æ¥å£
```java
@GetMapping("/butler/generateMiniProgramCode")
public ResponseEntity<?> generateMiniProgramCode(@RequestParam String phone, 
                                               @RequestParam String community) {
    try {
        // 1. è·å–access_token
        String accessToken = getAccessToken();
        
        // 2. æ„å»ºåœºæ™¯å€¼ï¼ˆç®€åŒ–æ ¼å¼é¿å…é•¿åº¦é™åˆ¶ï¼‰
        String scene = "bp=" + phone.substring(3) + "&c=" + URLEncoder.encode(community, "UTF-8");
        
        // 3. è°ƒç”¨å¾®ä¿¡APIç”Ÿæˆå°ç¨‹åºç 
        String wechatUrl = "https://api.weixin.qq.com/wxa/getwxacodeunlimit?access_token=" + accessToken;
        
        Map<String, Object> params = new HashMap<>();
        params.put("scene", scene);
        params.put("page", "pages/reservation/form");  // ç›®æ ‡é¡µé¢
        params.put("width", 430);
        params.put("auto_color", false);
        params.put("line_color", Map.of("r", 0, "g", 0, "b", 0));
        
        // 4. å‘é€è¯·æ±‚è·å–å°ç¨‹åºç å›¾ç‰‡
        byte[] imageBytes = callWechatApi(wechatUrl, params);
        
        // 5. è½¬æ¢ä¸ºBase64è¿”å›
        String base64Image = "data:image/png;base64," + Base64.getEncoder().encodeToString(imageBytes);
        
        return ResponseEntity.ok(Map.of(
            "code", "0",
            "data", Map.of(
                "type", "wechat_mini_program",
                "qrCodeImage", base64Image,
                "officialCode", true,
                "pagePath", "pages/reservation/form?scene=" + scene,
                "butlerPhone", phone
            )
        ));
        
    } catch (Exception e) {
        return ResponseEntity.ok(Map.of("code", "500", "msg", "ç”Ÿæˆå¤±è´¥ï¼š" + e.getMessage()));
    }
}
```

### ç¬¬ä¸‰æ­¥ï¼šå‰ç«¯é¡µé¢å¤„ç†åœºæ™¯å€¼

ä¿®æ”¹ `pages/reservation/form.vue` é¡µé¢ï¼Œæ·»åŠ åœºæ™¯å€¼å¤„ç†ï¼š

```javascript
// åœ¨ onLoad æ–¹æ³•ä¸­æ·»åŠ 
async onLoad(options) {
    // å¤„ç†åœºæ™¯å€¼å‚æ•°
    if (options.scene) {
        const sceneParams = this.parseSceneValue(options.scene);
        if (sceneParams.bp) {
            // æ ¹æ®ç®¡å®¶æ‰‹æœºå·åç¼€è·å–å®Œæ•´ä¿¡æ¯
            const butlerInfo = await this.getButlerInfoByPhoneSuffix(sceneParams.bp);
            if (butlerInfo) {
                // è‡ªåŠ¨å¡«å…¥ç®¡å®¶ä¿¡æ¯
                this.form.ownerPhone = butlerInfo.phone;
                this.form.fullAddress = butlerInfo.address;
            }
        }
    }
    
    // å¤„ç†URLå‚æ•°ï¼ˆå…¼å®¹ç°æœ‰æ–¹å¼ï¼‰
    if (options.butlerPhone) {
        this.form.ownerPhone = options.butlerPhone;
    }
    if (options.butlerName) {
        this.form.butlerName = options.butlerName;
    }
}

// è§£æåœºæ™¯å€¼
parseSceneValue(scene) {
    const params = {};
    const pairs = scene.split('&');
    pairs.forEach(pair => {
        const [key, value] = pair.split('=');
        if (key && value) {
            params[key] = decodeURIComponent(value);
        }
    });
    return params;
}
```

## ğŸ”§ ä¸´æ—¶è§£å†³æ–¹æ¡ˆ

åœ¨é…ç½®å¾®ä¿¡å®˜æ–¹å°ç¨‹åºç ä¹‹å‰ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä¸´æ—¶æ–¹æ¡ˆï¼š

### æ–¹æ¡ˆAï¼šä¿®å¤é¡µé¢è·³è½¬é€»è¾‘ 