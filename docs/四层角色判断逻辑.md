# å››å±‚è§’è‰²åˆ¤æ–­é€»è¾‘ï¼ˆå«å¤–éƒ¨APIï¼‰

## ğŸ¯ å‡çº§ç›®æ ‡

åœ¨åŸæœ‰ä¸‰å±‚è§’è‰²ä½“ç³»åŸºç¡€ä¸Šï¼Œå¢åŠ å¤–éƒ¨APIæŸ¥è¯¢ä½œä¸ºä¸šä¸»èº«ä»½çš„è¡¥å……éªŒè¯ï¼Œè§£å†³ownerinfoè¡¨æ•°æ®ä¸å…¨çš„é—®é¢˜ã€‚

## ğŸ”„ æ–°çš„å››å±‚æŸ¥è¯¢é€»è¾‘

### Javaåç«¯å®ç°

```java
private Map<String, Object> determineUserRole(String phoneNumber, String openid) {
    Map<String, Object> userInfo = new HashMap<>();
    userInfo.put("phone", phoneNumber);
    
    logger.info("å¼€å§‹å››å±‚è§’è‰²æŸ¥è¯¢ï¼Œæ‰‹æœºå·: [{}], openid: [{}]", phoneNumber, openid);
    
    // ç¬¬ä¸€å±‚ï¼šæŸ¥è¯¢ç®¡å®¶è¡¨ (æœ€é«˜ä¼˜å…ˆçº§)
    Butler butler = butlerService.list().stream()
        .filter(b -> phoneNumber.equals(b.getPhone()))
        .findFirst()
        .orElse(null);
        
    if (butler != null) {
        logger.info("ç¬¬ä¸€å±‚æŸ¥è¯¢æˆåŠŸï¼šæ‰¾åˆ°ç®¡å®¶è§’è‰²");
        userInfo.put("role", "manager");
        userInfo.put("roleText", "ç®¡å®¶");
        userInfo.put("userInfo", butler);
        userInfo.put("permissions", getManagerPermissions());
        userInfo.put("source", "butler_table");
        return userInfo;
    }
    
    // ç¬¬äºŒå±‚ï¼šæŸ¥è¯¢ä¸šä¸»è¡¨
    List<Ownerinfo> ownerList = ownerinfoService.phoneNumberOwnerInfo(phoneNumber);
    if (!ownerList.isEmpty()) {
        Ownerinfo owner = ownerList.get(0);
        logger.info("ç¬¬äºŒå±‚æŸ¥è¯¢æˆåŠŸï¼šæ‰¾åˆ°ä¸šä¸»è§’è‰²ï¼ˆæœ¬åœ°æ•°æ®ï¼‰");
        userInfo.put("role", "owner");
        userInfo.put("roleText", "ä¸šä¸»");
        userInfo.put("userInfo", owner);
        userInfo.put("permissions", getOwnerPermissions());
        userInfo.put("source", "ownerinfo_table");
        return userInfo;
    }
    
    // ç¬¬ä¸‰å±‚ï¼šæŸ¥è¯¢å¤–éƒ¨APIï¼ˆä¸šä¸»è¡¥å……éªŒè¯ï¼‰
    try {
        boolean isOwnerFromAPI = checkOwnerFromExternalAPI(phoneNumber);
        if (isOwnerFromAPI) {
            logger.info("ç¬¬ä¸‰å±‚æŸ¥è¯¢æˆåŠŸï¼šæ‰¾åˆ°ä¸šä¸»è§’è‰²ï¼ˆå¤–éƒ¨APIï¼‰");
            
            // åˆ›å»ºä¸´æ—¶ä¸šä¸»ä¿¡æ¯ï¼ˆä»APIè·å–ï¼‰
            Map<String, Object> apiOwnerInfo = getOwnerInfoFromAPI(phoneNumber);
            
            userInfo.put("role", "owner");
            userInfo.put("roleText", "ä¸šä¸»");
            userInfo.put("userInfo", apiOwnerInfo);
            userInfo.put("permissions", getOwnerPermissions());
            userInfo.put("source", "external_api");
            userInfo.put("needSync", true); // æ ‡è®°éœ€è¦åŒæ­¥åˆ°æœ¬åœ°æ•°æ®åº“
            return userInfo;
        }
    } catch (Exception e) {
        logger.warn("ç¬¬ä¸‰å±‚æŸ¥è¯¢å¤±è´¥ï¼šå¤–éƒ¨APIè°ƒç”¨å¼‚å¸¸", e);
        // APIè°ƒç”¨å¤±è´¥ä¸å½±å“åç»­æŸ¥è¯¢
    }
    
    // ç¬¬å››å±‚ï¼šæŸ¥è¯¢Memberè¡¨ (è®¿å®¢)
    Member member = memberService.getMemberByOpenId(openid);
    if (member != null && "å·²é€šè¿‡".equals(member.getAuditstatus())) {
        logger.info("ç¬¬å››å±‚æŸ¥è¯¢æˆåŠŸï¼šæ‰¾åˆ°è®¿å®¢è§’è‰²");
        userInfo.put("role", "visitor");
        userInfo.put("roleText", "è®¿å®¢");
        userInfo.put("userInfo", member);
        userInfo.put("permissions", getVisitorPermissions());
        userInfo.put("source", "member_table");
        return userInfo;
    }
    
    // ç¬¬äº”å±‚ï¼šå¾…å®¡æ ¸çŠ¶æ€
    if (member != null && "å¾…å®¡æ‰¹".equals(member.getAuditstatus())) {
        logger.info("ç¬¬äº”å±‚ï¼šç”¨æˆ·ç”³è¯·å¾…å®¡æ ¸");
        userInfo.put("role", "pending");
        userInfo.put("roleText", "å¾…å®¡æ ¸");
        userInfo.put("userInfo", member);
        userInfo.put("permissions", new String[]{});
        userInfo.put("source", "member_table");
        userInfo.put("message", "æ‚¨çš„ç”³è¯·æ­£åœ¨å®¡æ ¸ä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…");
        return userInfo;
    }
    
    // ç¬¬å…­å±‚ï¼šå®Œå…¨æœªæ³¨å†Œçš„ç”¨æˆ·
    logger.info("ç¬¬å…­å±‚ï¼šç”¨æˆ·æœªæ³¨å†Œ");
    userInfo.put("role", "unregistered");
    userInfo.put("roleText", "æœªæ³¨å†Œ");
    userInfo.put("userInfo", null);
    userInfo.put("permissions", new String[]{});
    userInfo.put("source", "none");
    userInfo.put("message", "è¯·å…ˆç”³è¯·æ³¨å†Œ");
    return userInfo;
}

/**
 * è°ƒç”¨å¤–éƒ¨APIæ£€æŸ¥æ˜¯å¦ä¸ºä¸šä¸»
 */
private boolean checkOwnerFromExternalAPI(String phoneNumber) {
    try {
        // è°ƒç”¨å¤–éƒ¨APIè·å–æœˆç¥¨åˆ—è¡¨
        List<Map<String, Object>> ticketList = getOnlineMonthTicketList();
        
        // æ£€æŸ¥æ‰‹æœºå·æ˜¯å¦åœ¨åˆ—è¡¨ä¸­
        return ticketList.stream()
            .anyMatch(ticket -> phoneNumber.equals(ticket.get("userPhone")));
            
    } catch (Exception e) {
        logger.error("è°ƒç”¨å¤–éƒ¨APIå¤±è´¥", e);
        return false;
    }
}

/**
 * ä»å¤–éƒ¨APIè·å–ä¸šä¸»è¯¦ç»†ä¿¡æ¯
 */
private Map<String, Object> getOwnerInfoFromAPI(String phoneNumber) {
    try {
        List<Map<String, Object>> ticketList = getOnlineMonthTicketList();
        
        Optional<Map<String, Object>> ownerTicket = ticketList.stream()
            .filter(ticket -> phoneNumber.equals(ticket.get("userPhone")))
            .findFirst();
            
        if (ownerTicket.isPresent()) {
            Map<String, Object> ticket = ownerTicket.get();
            
            // æ„å»ºä¸šä¸»ä¿¡æ¯
            Map<String, Object> ownerInfo = new HashMap<>();
            ownerInfo.put("ownername", ticket.get("userName"));
            ownerInfo.put("ownerphone", ticket.get("userPhone"));
            ownerInfo.put("carno", ticket.get("carNo"));
            ownerInfo.put("source", "external_api");
            ownerInfo.put("originalData", ticket); // ä¿å­˜åŸå§‹APIæ•°æ®
            
            return ownerInfo;
        }
        
    } catch (Exception e) {
        logger.error("ä»å¤–éƒ¨APIè·å–ä¸šä¸»ä¿¡æ¯å¤±è´¥", e);
    }
    
    // è¿”å›åŸºæœ¬ä¿¡æ¯
    Map<String, Object> ownerInfo = new HashMap<>();
    ownerInfo.put("ownerphone", phoneNumber);
    ownerInfo.put("source", "external_api");
    return ownerInfo;
}

/**
 * è°ƒç”¨å¤–éƒ¨APIè·å–æœˆç¥¨åˆ—è¡¨
 */
private List<Map<String, Object>> getOnlineMonthTicketList() {
    List<Map<String, Object>> allTickets = new ArrayList<>();
    int pageNum = 1;
    int pageSize = 100;
    boolean hasMore = true;
    
    while (hasMore) {
        try {
            // æ„å»ºè¯·æ±‚å‚æ•°
            Map<String, Object> params = new HashMap<>();
            params.put("pageNum", pageNum);
            params.put("pageSize", pageSize);
            params.put("parkCodeList", Arrays.asList("2KUG6XLU")); // æ ¹æ®å®é™…æƒ…å†µé…ç½®
            params.put("validStatus", 1);
            
            // è°ƒç”¨API
            String response = callExternalAPI(
                "https://openydt.yidianting.xin/Api/getOnlineMonthTicketList", 
                params
            );
            
            // è§£æå“åº”
            Map<String, Object> result = parseAPIResponse(response);
            List<Map<String, Object>> pageTickets = (List<Map<String, Object>>) result.get("data");
            
            if (pageTickets != null && !pageTickets.isEmpty()) {
                allTickets.addAll(pageTickets);
                
                // å¦‚æœè¿”å›æ•°æ®å°‘äºpageSizeï¼Œè¯´æ˜å·²ç»æ˜¯æœ€åä¸€é¡µ
                hasMore = pageTickets.size() >= pageSize;
                pageNum++;
            } else {
                hasMore = false;
            }
            
        } catch (Exception e) {
            logger.error("è°ƒç”¨å¤–éƒ¨APIç¬¬{}é¡µå¤±è´¥", pageNum, e);
            hasMore = false;
        }
    }
    
    logger.info("ä»å¤–éƒ¨APIè·å–åˆ°{}æ¡æœˆç¥¨æ•°æ®", allTickets.size());
    return allTickets;
}

/**
 * è°ƒç”¨å¤–éƒ¨API
 */
private String callExternalAPI(String url, Map<String, Object> params) {
    // è¿™é‡Œä½¿ç”¨æ‚¨ç°æœ‰çš„HTTPå®¢æˆ·ç«¯ï¼Œæ¯”å¦‚RestTemplateæˆ–OkHttp
    // ç¤ºä¾‹ä½¿ç”¨RestTemplate
    
    HttpHeaders headers = new HttpHeaders();
    headers.setContentType(MediaType.APPLICATION_JSON);
    
    HttpEntity<Map<String, Object>> request = new HttpEntity<>(params, headers);
    
    ResponseEntity<String> response = restTemplate.postForEntity(url, request, String.class);
    
    if (response.getStatusCode() == HttpStatus.OK) {
        return response.getBody();
    } else {
        throw new RuntimeException("APIè°ƒç”¨å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š" + response.getStatusCode());
    }
}

/**
 * è§£æAPIå“åº”
 */
private Map<String, Object> parseAPIResponse(String response) {
    try {
        ObjectMapper mapper = new ObjectMapper();
        return mapper.readValue(response, Map.class);
    } catch (Exception e) {
        throw new RuntimeException("è§£æAPIå“åº”å¤±è´¥", e);
    }
}
```

## ğŸ¨ è§’è‰²åˆ¤æ–­æµç¨‹å›¾

```mermaid
graph TD
    A[å¾®ä¿¡æˆæƒè·å–æ‰‹æœºå·] --> B[ç¬¬ä¸€å±‚ï¼šæŸ¥è¯¢Butlerè¡¨]
    B --> C{æ˜¯å¦æ‰¾åˆ°ç®¡å®¶?}
    C -->|æ˜¯| D[è¿”å›ç®¡å®¶è§’è‰²]
    C -->|å¦| E[ç¬¬äºŒå±‚ï¼šæŸ¥è¯¢Ownerinfoè¡¨]
    E --> F{æ˜¯å¦æ‰¾åˆ°ä¸šä¸»?}
    F -->|æ˜¯| G[è¿”å›ä¸šä¸»è§’è‰² - æœ¬åœ°æ•°æ®]
    F -->|å¦| H[ç¬¬ä¸‰å±‚ï¼šè°ƒç”¨å¤–éƒ¨API]
    H --> I{APIä¸­æ˜¯å¦æœ‰è¯¥æ‰‹æœºå·?}
    I -->|æ˜¯| J[è¿”å›ä¸šä¸»è§’è‰² - å¤–éƒ¨æ•°æ®]
    I -->|å¦æˆ–APIå¼‚å¸¸| K[ç¬¬å››å±‚ï¼šæŸ¥è¯¢Memberè¡¨]
    K --> L{æ˜¯å¦å·²å®¡æ ¸é€šè¿‡?}
    L -->|æ˜¯| M[è¿”å›è®¿å®¢è§’è‰²]
    L -->|å¾…å®¡æ ¸| N[è¿”å›å¾…å®¡æ ¸çŠ¶æ€]
    L -->|å¦| O[è¿”å›æœªæ³¨å†ŒçŠ¶æ€]
```

## ğŸ“ é…ç½®å»ºè®®

### 1. application.ymlé…ç½®

```yaml
external-api:
  ticket-list:
    url: https://openydt.yidianting.xin/Api/getOnlineMonthTicketList
    timeout: 10000
    retry-count: 3
    park-codes:
      - "2KUG6XLU"
    cache-duration: 300  # ç¼“å­˜5åˆ†é’Ÿ
```

### 2. ç¼“å­˜ä¼˜åŒ–

```java
@Service
public class ExternalAPIService {
    
    @Cacheable(value = "ownerTickets", key = "#phoneNumber")
    public boolean isOwnerInExternalAPI(String phoneNumber) {
        return checkOwnerFromExternalAPI(phoneNumber);
    }
    
    @CacheEvict(value = "ownerTickets", allEntries = true)
    @Scheduled(fixedDelay = 300000) // 5åˆ†é’Ÿæ¸…é™¤ä¸€æ¬¡ç¼“å­˜
    public void clearCache() {
        logger.info("æ¸…é™¤å¤–éƒ¨APIç¼“å­˜");
    }
}
```

## ğŸš€ ä¼˜åŠ¿

1. **æ•°æ®å®Œæ•´æ€§æå‡**ï¼šè§£å†³ownerinfoè¡¨æ•°æ®ä¸å…¨çš„é—®é¢˜
2. **å®æ—¶æ€§ä¿è¯**ï¼šå¤–éƒ¨APIæ•°æ®æ›´åŠæ—¶
3. **é™çº§å¤„ç†**ï¼šAPIå¼‚å¸¸æ—¶ä¸å½±å“æ­£å¸¸æµç¨‹
4. **æ•°æ®åŒæ­¥**ï¼šå¯æ ‡è®°éœ€è¦åŒæ­¥çš„ä¸šä¸»æ•°æ®
5. **æ€§èƒ½ä¼˜åŒ–**ï¼šå¢åŠ ç¼“å­˜æœºåˆ¶å‡å°‘APIè°ƒç”¨

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **APIè°ƒç”¨é¢‘ç‡**ï¼šé¿å…è¿‡åº¦è°ƒç”¨ï¼Œå»ºè®®å¢åŠ ç¼“å­˜
2. **å¼‚å¸¸å¤„ç†**ï¼šAPIå¼‚å¸¸ä¸åº”å½±å“å…¶ä»–è§’è‰²åˆ¤æ–­
3. **æ•°æ®åŒæ­¥**ï¼šå»ºè®®å°†å¤–éƒ¨APIæ•°æ®åŒæ­¥åˆ°æœ¬åœ°
4. **æƒé™é…ç½®**ï¼šç¡®ä¿APIè°ƒç”¨æƒé™å’Œç½‘ç»œè®¿é—®
5. **ç›‘æ§å‘Šè­¦**ï¼šç›‘æ§APIè°ƒç”¨æˆåŠŸç‡å’Œå“åº”æ—¶é—´

è¿™ä¸ªå››å±‚æŸ¥è¯¢æœºåˆ¶è®©ä¸šä¸»èº«ä»½åˆ¤æ–­æ›´åŠ å‡†ç¡®å’Œå®Œæ•´ï¼ 