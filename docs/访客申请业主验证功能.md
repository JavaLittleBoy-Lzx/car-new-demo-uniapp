# 访客申请业主验证功能

## 功能概述

在访客申请页面中新增了"访问业主手机号"验证功能，确保访客申请时必须填写有效的本小区月票业主手机号，提高申请的准确性和安全性。

## 核心特性

### 1. 📱 实时验证
- **防抖输入**：输入手机号后800ms自动触发验证
- **格式校验**：验证手机号格式（1开头的11位数字）
- **自检防护**：禁止填写访客自己的手机号

### 2. 🔍 业主身份验证
- **月票查询**：调用后端API验证该手机号是否为当前小区月票用户
- **实时状态**：显示验证中、验证成功、验证失败等状态
- **业主信息**：验证成功后显示业主姓名和地址信息

### 3. ✅ 表单约束
- **必填校验**：业主手机号为必填项
- **验证通过**：只有验证通过的业主手机号才能提交申请
- **动态提示**：根据验证状态动态更新提交按钮文本

## 技术实现

### 1. 数据结构

```javascript
data() {
  return {
    form: {
      ownerPhone: '', // 访问业主手机号
      // ... 其他字段
    },
    
    // 业主验证相关
    ownerVerifyStatus: '', // 'verifying', 'valid', 'invalid', 'error'
    ownerInfo: { // 验证通过的业主信息
      name: '',
      address: '',
      community: '',
      phone: ''
    },
    verifyTimer: null, // 防抖计时器
  }
}
```

### 2. 防抖验证机制

```javascript
// 输入事件处理（防抖）
onOwnerPhoneInput(e) {
  const phone = e.detail.value;
  this.form.ownerPhone = phone;

  // 清除之前的计时器
  if (this.verifyTimer) {
    clearTimeout(this.verifyTimer);
  }

  // 重置验证状态
  this.ownerVerifyStatus = '';
  
  // 如果手机号长度为11位，启动防抖验证
  if (phone.length === 11) {
    this.verifyTimer = setTimeout(() => {
      this.validateOwnerPhone();
    }, 800); // 800ms防抖
  }
}
```

### 3. API调用验证

```javascript
// 调用后端验证月票信息
async checkOwnerMonthlyTicket(phone) {
  const response = await uni.request({
    url: 'http://localhost:8543/parking/owner/checkMonthlyTicket',
    method: 'GET',
    data: {
      phone: phone,
      community: this.currentCommunityName
    },
    timeout: 10000
  });

  // 处理响应数据
  if (response.statusCode === 200 && response.data.code === "0") {
    return {
      isValid: true,
      ownerName: response.data.data.ownerName,
      address: response.data.data.fullAddress,
      community: response.data.data.community,
      message: '验证成功'
    };
  } else {
    return {
      isValid: false,
      message: response.data.msg || '该手机号非本小区月票用户'
    };
  }
}
```

### 4. 表单验证约束

```javascript
computed: {
  canSubmit() {
    const hasOwnerPhone = this.form.ownerPhone.trim().length === 11;
    const hasValidOwner = this.ownerVerifyStatus === 'valid';
    // ... 其他验证条件
    
    return hasOwnerPhone && hasValidOwner && /* 其他条件 */;
  }
}
```

## UI/UX设计

### 1. 状态指示器
- **验证中**：蓝色脉冲动画 + "验证中..."文字
- **验证成功**：绿色背景 + "✓ 已验证"
- **验证失败**：红色背景 + "✗ 非本小区业主"
- **验证错误**：橙色背景 + "验证失败"

### 2. 业主信息展示
```html
<view class="owner-info" v-if="ownerInfo.name">
  <text class="owner-detail">业主姓名：{{ ownerInfo.name }}</text>
  <text class="owner-detail">地址：{{ ownerInfo.address }}</text>
</view>
```

### 3. 动态按钮文本
- 未填写："请输入业主手机号"
- 格式错误："手机号格式不正确"
- 验证中："验证业主身份中..."
- 验证失败："该手机号非本小区业主"
- 验证成功："提交申请"

## API接口规范

### 请求接口
```
GET /parking/owner/checkMonthlyTicket
```

### 请求参数
```javascript
{
  "phone": "13800138001",     // 业主手机号
  "community": "四季上东"      // 小区名称
}
```

### 响应格式
```javascript
{
  "code": "0",
  "msg": "成功",
  "data": {
    "ownerName": "张三",
    "username": "张三",
    "fullAddress": "1栋2单元3楼401室",
    "building": "1",
    "units": "2", 
    "floor": "3",
    "roomnumber": "401",
    "community": "四季上东",
    "phone": "13800138001"
  }
}
```

## 安全特性

### 1. 输入验证
- **格式校验**：严格验证手机号格式
- **自检防护**：防止填写访客自己的手机号
- **长度限制**：限制输入11位数字

### 2. 防抖机制
- **减少请求**：800ms防抖避免频繁API调用
- **状态管理**：输入时重置验证状态
- **计时器清理**：组件卸载时清理计时器

### 3. 错误处理
- **网络异常**：超时、网络错误的友好提示
- **业务错误**：非月票用户的明确提示
- **系统错误**：服务器异常的降级处理

## 用户体验优化

### 1. 实时反馈
- **即时验证**：输入完成后自动验证
- **状态显示**：清晰的验证状态指示
- **结果展示**：验证成功后显示业主信息

### 2. 错误提示
- **具体明确**：详细说明验证失败原因
- **操作指导**：提示用户如何正确操作
- **重试机制**：支持重新输入和验证

### 3. 视觉设计
- **状态色彩**：不同状态使用不同颜色
- **动画效果**：验证中的脉冲动画
- **信息层次**：业主信息的清晰展示

## 提交数据结构

访客申请提交时会包含完整的业主验证信息：

```javascript
const submitData = {
  // 访客基本信息
  nickname: "李四",
  phone: "13800138002", 
  ownerPhone: "13800138001", // 访问业主手机号
  
  // 业主相关信息
  ownerName: "张三",
  ownerAddress: "1栋2单元3楼401室", 
  ownerCommunity: "四季上东",
  
  // 其他申请信息...
};
```

## 后续扩展

1. **批量验证**：支持验证多个业主联系方式
2. **关系验证**：验证访客与业主的关系类型
3. **访问历史**：记录访客的历史访问记录
4. **智能推荐**：根据地址信息智能推荐可能的业主

这个功能确保了访客申请的真实性和准确性，提高了物业管理的安全性和效率。 