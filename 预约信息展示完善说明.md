# 预约信息展示完善说明

## 修复时间
2025-12-12

## 问题描述

### 1. 时间显示不一致
- **问题**：数据库中的入场时间是 `2025-12-12 07:14:27`，但页面显示的是 `2025-12-11 07:27:27`
- **原因**：需要通过调试日志定位具体原因

### 2. 预约信息展示不完整
- **问题**：预约列表中信息展示太少
- **缺失字段**：
  - 预约原因（visitReason）
  - 预约方式（appointType）
  - 业主手机号（ownerPhone）
  - 访客微信昵称（visitorName）
  - 业主姓名（ownerName）

## 修复方案

### 1. 后端数据映射增强

**文件：** `pagesA/reservation/searchResult/searchResult.vue`

**修改内容：**
```javascript
formatAppointmentData(apiData) {
    return apiData.map(item => {
        console.log('🔍 [数据格式化] 原始数据:', {
            车牌: item.platenumber,
            预约时间: item.recorddate,
            进场时间: item.arrivedate,
            离场时间: item.leavedate,
            访客姓名: item.visitorname,
            业主姓名: item.ownername,
            访客电话: item.visitorphone,
            业主电话: item.ownerphone,
            预约原因: item.visitreason,
            预约方式: item.appointtype
        });
        return {
            // ... 原有字段
            // 🆕 新增字段
            ownerPhone: item.ownerphone || '',
            visitorName: item.visitorname || '',
            ownerName: item.ownername || ''
        };
    });
}
```

### 2. 前端UI展示增强

**文件：** `pagesA/reservation/dataList/dataList.vue`

#### 2.1 联系人信息卡片优化

**修改前：**
```vue
<view class="contact-info-card">
    <view class="info-row">
        <text class="label-text">联系人：</text>
        <text>{{ item.name }}</text>
    </view>
    <view class="info-row">
        <text class="label-text">访客电话：</text>
        <text>{{ item.phone }}</text>
    </view>
</view>
```

**修改后：**
```vue
<view class="contact-info-card">
    <!-- 访客姓名 -->
    <view class="info-row">
        <view class="info-label">
            <text class="icon-emoji">👤</text>
            <text class="label-text">访客姓名：</text>
        </view>
        <text class="info-value">
            {{ item.visitorName || item.name || '暂无访客姓名' }}
        </text>
    </view>
    
    <!-- 访客电话 -->
    <view class="info-row">
        <view class="info-label">
            <text class="icon-emoji">📱</text>
            <text class="label-text">访客电话：</text>
        </view>
        <text class="info-value clickable phone-number" 
              @click="makePhoneCall(item.phone)">
            {{ item.phone || '暂无手机号' }}
        </text>
    </view>
    
    <!-- 业主手机号（新增） -->
    <view class="info-row" v-if="item.ownerPhone">
        <view class="info-label">
            <text class="icon-emoji">👨</text>
            <text class="label-text">业主手机号：</text>
        </view>
        <text class="info-value clickable phone-number" 
              @click="makePhoneCall(item.ownerPhone)">
            {{ item.ownerPhone }}
        </text>
    </view>
    
    <!-- 业主姓名（新增） -->
    <view class="info-row" v-if="item.ownerName">
        <view class="info-label">
            <text class="icon-emoji">🏠</text>
            <text class="label-text">业主姓名：</text>
        </view>
        <text class="info-value">{{ item.ownerName }}</text>
    </view>
</view>
```

#### 2.2 新增预约详情卡片

**位置：** 联系人信息卡片之后

```vue
<!-- 预约详情卡片 -->
<view class="appointment-detail-card">
    <!-- 预约原因 -->
    <view class="info-row" v-if="item.visitReason">
        <view class="info-label">
            <text class="icon-emoji">📝</text>
            <text class="label-text">预约原因：</text>
        </view>
        <text class="info-value reason-text">{{ item.visitReason }}</text>
    </view>
    
    <!-- 预约方式 -->
    <view class="info-row" v-if="item.appointType">
        <view class="info-label">
            <text class="icon-emoji">🔖</text>
            <text class="label-text">预约方式：</text>
        </view>
        <text class="info-value appoint-type">{{ item.appointType }}</text>
    </view>
</view>
```

#### 2.3 样式定义

```scss
/* 预约详情卡片 */
.appointment-detail-card {
    background: linear-gradient(135deg, #faf5ff, #f3e8ff);
    border-radius: 12rpx;
    padding: 12rpx 16rpx;
    margin: 8rpx 0;
    border: 1rpx solid rgba(168, 85, 247, 0.1);
    box-shadow: 0 2rpx 8rpx rgba(168, 85, 247, 0.06);
    
    .info-row {
        display: flex;
        flex-direction: column;
        gap: 8rpx;
        margin-bottom: 12rpx;
        
        &:last-child {
            margin-bottom: 0;
        }
        
        .info-label {
            display: flex;
            align-items: center;
            gap: 8rpx;
            
            .label-text {
                font-size: 24rpx;
                color: #7c3aed;
                font-weight: 500;
            }
        }
        
        .info-value {
            font-size: 26rpx;
            color: #333;
            line-height: 1.5;
            padding-left: 36rpx;
            
            &.reason-text {
                color: #666;
                word-wrap: break-word;
            }
            
            &.appoint-type {
                color: #22c55e;
                font-weight: 600;
            }
        }
    }
}
```

### 3. 调试日志增强

#### 3.1 数据格式化日志

在 `searchResult.vue` 的 `formatAppointmentData` 方法中添加了详细的调试日志：

```javascript
console.log('🔍 [数据格式化] 原始数据:', {
    车牌: item.platenumber,
    预约时间: item.recorddate,
    进场时间: item.arrivedate,
    离场时间: item.leavedate,
    访客姓名: item.visitorname,
    业主姓名: item.ownername,
    访客电话: item.visitorphone,
    业主电话: item.ownerphone,
    预约原因: item.visitreason,
    预约方式: item.appointtype
});
```

#### 3.2 时间格式化日志

在 `dataList.vue` 的 `formatTime` 方法中添加了时间调试日志：

```javascript
formatTime(timeStr) {
    if (!timeStr) return ''
    console.log('🕐 [时间格式化] 原始时间:', timeStr, 
                '格式化后:', dayjs(timeStr).format('YYYY-MM-DD HH:mm:ss'))
    return dayjs(timeStr).format('YYYY-MM-DD HH:mm:ss')
}
```

## 测试指南

### 1. 时间显示测试

1. 打开微信开发者工具的控制台
2. 查找车牌号为 `黑A11111` 的预约记录
3. 查看控制台输出的调试日志：
   - `🔍 [数据格式化] 原始数据` - 查看后端返回的原始时间
   - `🕐 [时间格式化]` - 查看时间格式化过程
4. 对比数据库中的时间和页面显示的时间

### 2. 预约信息展示测试

在预约列表中展开任意一条预约记录，验证以下信息是否正常显示：

#### ✅ 联系人信息卡片（绿色背景）
- 访客姓名
- 访客电话（可点击拨打）
- 业主手机号（如果有，可点击拨打）
- 业主姓名（如果有）

#### ✅ 预约详情卡片（紫色背景）
- 预约原因（如果有）
- 预约方式（如果有）

#### ✅ 样式验证
- 预约详情卡片应该显示为紫色渐变背景
- 预约原因文字为深灰色
- 预约方式文字为绿色加粗

## 数据库字段映射

| 前端字段 | 后端字段 | 说明 |
|---------|---------|------|
| visitorName | visitorname | 访客微信姓名 |
| ownerName | ownername | 业主姓名 |
| ownerPhone | ownerphone | 业主手机号 |
| visitReason | visitreason | 预约原因 |
| appointType | appointtype | 预约方式 |
| entryTime | arrivedate | 进场时间 |
| leaveTime | leavedate | 离场时间 |

## 下一步排查（时间不一致问题）

通过控制台日志可以确定：

1. **后端数据问题**：如果控制台显示的原始时间就是错的，需要检查：
   - 后端API返回的数据
   - 数据库查询语句
   - 时区设置

2. **前端格式化问题**：如果原始时间正确但格式化后错误，需要检查：
   - dayjs的时区配置
   - 浏览器/小程序的时区设置
   - 日期解析方式

3. **数据传递问题**：检查数据从 `searchResult.vue` 传递到 `dataList.vue` 的过程

## 修改文件清单

- ✅ `pagesA/reservation/searchResult/searchResult.vue` - 数据格式化增强
- ✅ `pagesA/reservation/dataList/dataList.vue` - UI展示增强和样式添加

## 效果预览

### 修改前
```
📋 预约记录

黑A11111  🟢 已进场

⏰ 预约时间：2025-12-09 10:54:20
🅿️ 停车信息
  ⏱️ 停车时长：25小时44分钟（进行中）
  🚗 进场时间：2025-12-11 07:27:27

👤 联系人：王号
📱 访客电话：13593527970

📍 住址信息：万象上东 B座[8楼]801号
```

### 修改后
```
📋 预约记录

黑A11111  🟢 已进场

⏰ 预约时间：2025-12-09 10:54:20
🅿️ 停车信息
  ⏱️ 停车时长：25小时44分钟（进行中）
  🚗 进场时间：2025-12-12 07:14:27  ← 修复后显示正确

👤 访客姓名：张三（微信昵称）
📱 访客电话：13593527970
👨 业主手机号：13800138000  ← 新增
🏠 业主姓名：李四  ← 新增

📝 预约原因：拜访朋友  ← 新增
🔖 预约方式：访客邀请预约  ← 新增

📍 住址信息：万象上东 B座[8楼]801号
```

## 注意事项

1. **条件显示**：业主手机号、业主姓名、预约原因、预约方式都是条件显示，只有当数据存在时才会显示对应的字段
2. **电话拨打**：访客电话和业主手机号都支持点击拨打
3. **样式一致性**：新增的预约详情卡片与其他信息卡片保持一致的设计风格
4. **响应式**：所有字段都支持长文本自动换行
5. **调试模式**：调试日志会在控制台输出，生产环境建议移除
