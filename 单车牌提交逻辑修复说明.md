# å•è½¦ç‰Œæäº¤é€»è¾‘ä¿®å¤è¯´æ˜

## é—®é¢˜æè¿°

ä¸šä¸»å’Œç®¡å®¶ä½¿ç”¨å•è½¦ç‰Œè¾“å…¥ç•Œé¢æ—¶ï¼Œå·²ç»è¾“å…¥äº†å®Œæ•´çš„è½¦ç‰Œå·ç ï¼ˆå¦‚"é»‘ADE357"ï¼‰ï¼Œä½†ç‚¹å‡»æäº¤æŒ‰é’®ä»ç„¶æç¤ºï¼š"è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªè½¦ç‰Œå·"ã€‚

**åŸå› **ï¼š
- å½“å‰é¡¹ç›®çš„ `submit` æ–¹æ³•ä½¿ç”¨å¤šè½¦ç‰ŒéªŒè¯é€»è¾‘ `validateMultiCarForm()`
- è¯¥æ–¹æ³•æ£€æŸ¥çš„æ˜¯ `this.carList` æ•°ç»„
- å•è½¦ç‰Œç•Œé¢ä¸ä½¿ç”¨ `carList` æ•°ç»„ï¼Œè€Œæ˜¯ç›´æ¥åœ¨é”®ç›˜ç»„ä»¶ä¸­è¾“å…¥
- å¯¼è‡´éªŒè¯å¤±è´¥

---

## ä¿®å¤æ–¹æ¡ˆ

æ ¹æ®ç”¨æˆ·è§’è‰²ï¼ˆvisitor/owner/managerï¼‰ä½¿ç”¨ä¸åŒçš„éªŒè¯å’Œæäº¤é€»è¾‘ã€‚

---

## ä¿®å¤çš„æ–¹æ³•

### 1. submit() - ä¸»æäº¤æ–¹æ³•

**ä¿®æ”¹å‰**ï¼š
```javascript
async submit() {
    // é˜²æ­¢é‡å¤æäº¤
    if (this.isSubmittingAppointment) {
        return;
    }

    // ğŸš— å¤šè½¦ç‰Œè¡¨å•éªŒè¯ï¼ˆæ‰€æœ‰è§’è‰²éƒ½ç”¨è¿™ä¸ªï¼‰
    if (!this.validateMultiCarForm()) {
        return;
    }

    // ğŸš— è½¦ç‰Œæ•°é‡äºŒæ¬¡ç¡®è®¤ï¼ˆå¦‚æœæœªæ»¡ï¼‰
    if (this.shouldWarnBeforeSubmit && !this.isSubmittingWithWarning) {
        this.showCarCountConfirmation();
        return;
    }
    
    // ... å…¶ä»–æ£€æŸ¥ ...
    
    // ğŸš— æŒ‰è½¦ç‰Œé€æ¡æäº¤ï¼ˆæ‰€æœ‰è§’è‰²éƒ½ç”¨è¿™ä¸ªï¼‰
    await this.submitMultipleCarAppointments();
}
```

**ä¿®æ”¹å**ï¼š
```javascript
async submit() {
    // é˜²æ­¢é‡å¤æäº¤
    if (this.isSubmittingAppointment) {
        return;
    }

    // æ ¹æ®è§’è‰²é€‰æ‹©ä¸åŒçš„éªŒè¯é€»è¾‘
    if (this.currentUserRole === 'visitor') {
        // è®¿å®¢ï¼šå¤šè½¦ç‰Œè¡¨å•éªŒè¯
        if (!this.validateMultiCarForm()) {
            return;
        }

        // è½¦ç‰Œæ•°é‡äºŒæ¬¡ç¡®è®¤ï¼ˆå¦‚æœæœªæ»¡ï¼‰
        if (this.shouldWarnBeforeSubmit && !this.isSubmittingWithWarning) {
            this.showCarCountConfirmation();
            return;
        }
    } else {
        // ä¸šä¸»/ç®¡å®¶ï¼šå•è½¦ç‰Œè¡¨å•éªŒè¯
        if (!this.validateSingleCarForm()) {  // âœ… æ–°å¢
            return;
        }
    }
    
    // ... å…¶ä»–æ£€æŸ¥ ...
    
    // æ ¹æ®è§’è‰²é€‰æ‹©ä¸åŒçš„æäº¤æ–¹å¼
    if (this.currentUserRole === 'visitor') {
        // è®¿å®¢ï¼šæŒ‰è½¦ç‰Œé€æ¡æäº¤
        await this.submitMultipleCarAppointments();
    } else {
        // ä¸šä¸»/ç®¡å®¶ï¼šå•è½¦ç‰Œæäº¤
        await this.submitSingleCarAppointment();  // âœ… æ–°å¢
    }
}
```

---

### 2. validateSingleCarForm() - å•è½¦ç‰ŒéªŒè¯ âœ… æ–°å¢

```javascript
// å•è½¦ç‰Œè¡¨å•éªŒè¯ï¼ˆä¸šä¸»å’Œç®¡å®¶ä½¿ç”¨ï¼‰
validateSingleCarForm() {
    // æ£€æŸ¥æ—¥æœŸé€‰æ‹©
    if (this.activeDate === -1) {
        uni.showToast({
            title: 'è¯·é€‰æ‹©é¢„çº¦æ—¥æœŸ',
            icon: 'none',
            duration: 2000
        });
        return false;
    }

    // æ£€æŸ¥ç”µè¯å·ç 
    if (!this.model1.code) {
        uni.showToast({
            title: 'è¯·ç¡®è®¤è”ç³»ç”µè¯',
            icon: 'none',
            duration: 2000
        });
        return false;
    }

    // æ£€æŸ¥æ¥è®¿åŸå› 
    if (!this.model1.reason) {
        uni.showToast({
            title: 'è¯·é€‰æ‹©æ¥è®¿åŸå› ',
            icon: 'none',
            duration: 2000
        });
        return false;
    }

    // æ£€æŸ¥è½¦ç‰Œå·ï¼ˆä½¿ç”¨getPlateNumberè·å–ï¼‰
    const plateNumber = this.getPlateNumber();
    if (!plateNumber || plateNumber.length < 7) {
        uni.showToast({
            title: 'è¯·è¾“å…¥å®Œæ•´çš„è½¦ç‰Œå·',  // âœ… æ­£ç¡®çš„æç¤º
            icon: 'none',
            duration: 2000
        });
        return false;
    }

    return true;
}
```

**å…³é”®ç‚¹**ï¼š
- ä½¿ç”¨ `getPlateNumber()` æ–¹æ³•è·å–è½¦ç‰Œå·
- è¯¥æ–¹æ³•å·²ä¿®å¤æ”¯æŒ `keyboardInputSingle`
- ä¸æ£€æŸ¥ `carList` æ•°ç»„

---

### 3. submitSingleCarAppointment() - å•è½¦ç‰Œæäº¤ âœ… æ–°å¢

```javascript
// å•è½¦ç‰Œæäº¤æ–¹æ³•ï¼ˆä¸šä¸»å’Œç®¡å®¶ä½¿ç”¨ï¼‰
async submitSingleCarAppointment() {
    uni.showLoading({
        title: 'æäº¤ä¸­...',
        mask: true
    });

    try {
        // æ„å»ºåŸºç¡€é¢„çº¦æ•°æ®
        const baseAppointmentData = await this.buildBaseAppointmentData();
        
        // è·å–è½¦ç‰Œå·å’Œè½¦ç‰Œç±»å‹
        const plateNumber = this.getPlateNumber();
        
        // æ ¹æ®å½“å‰é€‰æ‹©çš„é¢œè‰²ç¡®å®šè½¦ç‰Œç±»å‹
        let cartype = 'blue'; // é»˜è®¤è“ç‰Œ
        if (this.selectedColor === 'linear-gradient(to bottom, #f8c401, #dba700)') {
            cartype = 'yellow';
        } else if (this.selectedColor === 'linear-gradient(to bottom, #d0f1e4, #6ad390)') {
            cartype = 'green';
        } else if (this.selectedColor === 'linear-gradient(to bottom, #f5f5f5, #e0e0e0)') {
            cartype = 'white';
        } else if (this.selectedColor === 'linear-gradient(to bottom, #525252, #1e1e1e)') {
            cartype = 'black';
        }
        
        // æ„å»ºå®Œæ•´çš„é¢„çº¦æ•°æ®
        const appointmentData = {
            ...baseAppointmentData,
            platenumber: plateNumber,
            cartype: cartype
        };
        
        console.log('ğŸ“¤ æäº¤å•è½¦ç‰Œé¢„çº¦:', plateNumber, appointmentData);
        
        // æäº¤é¢„çº¦
        const result = await this.submitSingleAppointment(appointmentData);
        
        console.log('âœ… å•è½¦ç‰Œæäº¤æˆåŠŸ:', plateNumber);
        
        // ä¿å­˜é¢„çº¦æ•°æ®åˆ°Storageä¾›resulté¡µé¢ä½¿ç”¨
        const parkInfo = uni.getStorageSync('parkInfo');
        let parkingLotName = parkInfo?.fullName || parkInfo?.name || 'åœè½¦åœº';
        
        const lastAppointmentData = {
            visitDate: baseAppointmentData.visitdate || '',
            plateNumber: plateNumber,
            visitReason: baseAppointmentData.visitreason || '',
            parkingLotName: parkingLotName,
            visitAddress: `${baseAppointmentData.building}æ ‹${baseAppointmentData.units}å•å…ƒ${baseAppointmentData.room}å®¤`
        };
        
        uni.setStorageSync('lastAppointmentData', lastAppointmentData);
        
        // æˆåŠŸåè·³è½¬
        uni.hideLoading();
        uni.navigateTo({
            url: '/pagesD/reservation/result'
        });
        
    } catch (error) {
        console.error('âŒ å•è½¦ç‰Œæäº¤å¤±è´¥:', error);
        uni.hideLoading();
        uni.showModal({
            title: 'é¢„çº¦å¤±è´¥',
            content: error.message || 'æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•',
            showCancel: false
        });
    } finally {
        this.isSubmittingAppointment = false;
    }
}
```

**å…³é”®åŠŸèƒ½**ï¼š
1. âœ… ä½¿ç”¨ `buildBaseAppointmentData()` æ„å»ºåŸºç¡€æ•°æ®
2. âœ… ä½¿ç”¨ `getPlateNumber()` è·å–è½¦ç‰Œå·
3. âœ… æ ¹æ® `selectedColor` ç¡®å®šè½¦ç‰Œç±»å‹
4. âœ… è°ƒç”¨ `submitSingleAppointment()` æäº¤
5. âœ… ä¿å­˜æ•°æ®ä¾›ç»“æœé¡µé¢ä½¿ç”¨
6. âœ… æˆåŠŸåè·³è½¬åˆ°ç»“æœé¡µ

---

### 4. é»‘åå•æ£€æŸ¥ä¿®å¤

**ä¿®æ”¹å‰**ï¼š
```javascript
// æ£€æŸ¥æ‰€æœ‰è½¦ç‰Œæ˜¯å¦åœ¨é»‘åå•ä¸­ï¼ˆæ‰€æœ‰è§’è‰²éƒ½ç”¨è¿™ä¸ªï¼‰
const blacklistCheck = await this.checkAllCarsBlacklistStatus();
if (!blacklistCheck.canSubmit) {
    return;
}
```

**ä¿®æ”¹å**ï¼š
```javascript
// æ£€æŸ¥è½¦ç‰Œæ˜¯å¦åœ¨é»‘åå•ä¸­
if (this.currentUserRole === 'visitor') {
    // è®¿å®¢ï¼šæ£€æŸ¥æ‰€æœ‰è½¦ç‰Œ
    const blacklistCheck = await this.checkAllCarsBlacklistStatus();
    if (!blacklistCheck.canSubmit) {
        return;
    }
} else {
    // ä¸šä¸»/ç®¡å®¶ï¼šæ£€æŸ¥å•ä¸ªè½¦ç‰Œ
    const plateNumber = this.getPlateNumber();
    const blacklistCheck = await this.checkSingleCarBlacklistStatus(plateNumber);
    if (!blacklistCheck.canSubmit) {
        uni.showModal({
            title: 'âš ï¸ è½¦ç‰Œé»‘åå•æé†’',
            content: `è½¦ç‰Œ ${plateNumber} åœ¨é»‘åå•ä¸­ï¼Œ${blacklistCheck.message}`,
            showCancel: false
        });
        this.isSubmittingAppointment = false;
        return;
    }
}
```

---

## å®Œæ•´çš„æäº¤æµç¨‹

### è®¿å®¢ï¼ˆvisitorï¼‰

```
1. è¾“å…¥å¤šä¸ªè½¦ç‰Œåˆ°carListæ•°ç»„
    â†“
2. ç‚¹å‡»æäº¤æŒ‰é’®
    â†“
3. validateMultiCarForm() - æ£€æŸ¥carListæ•°ç»„
    â†“
4. checkAllCarsBlacklistStatus() - æ£€æŸ¥æ‰€æœ‰è½¦ç‰Œ
    â†“
5. submitMultipleCarAppointments() - é€ä¸ªæäº¤è½¦ç‰Œ
    â†“
6. è·³è½¬åˆ°ç»“æœé¡µ
```

### ä¸šä¸»/ç®¡å®¶ï¼ˆowner/managerï¼‰

```
1. åœ¨é”®ç›˜è¾“å…¥ç»„ä»¶ä¸­è¾“å…¥è½¦ç‰Œ
    â†“
2. ç‚¹å‡»æäº¤æŒ‰é’®
    â†“
3. validateSingleCarForm() - ä½¿ç”¨getPlateNumber()æ£€æŸ¥
    â†“
4. checkSingleCarBlacklistStatus() - æ£€æŸ¥å•ä¸ªè½¦ç‰Œ
    â†“
5. submitSingleCarAppointment() - æäº¤å•ä¸ªè½¦ç‰Œ
    â†“
6. è·³è½¬åˆ°ç»“æœé¡µ
```

---

## éªŒè¯é€»è¾‘å¯¹æ¯”

| æ£€æŸ¥é¡¹ | è®¿å®¢å¤šè½¦ç‰Œ | ä¸šä¸»/ç®¡å®¶å•è½¦ç‰Œ |
|--------|----------|----------------|
| æ—¥æœŸ | âœ… activeDate === -1 | âœ… activeDate === -1 |
| ç”µè¯ | âœ… !model1.code | âœ… !model1.code |
| åŸå›  | âœ… !model1.reason | âœ… !model1.reason |
| è½¦ç‰Œ | âœ… carList.length === 0 | âœ… getPlateNumber().length < 7 |
| è½¦ç‰Œå®Œæ•´æ€§ | âœ… å¾ªç¯æ£€æŸ¥æ¯ä¸ªè½¦ç‰Œ | âœ… å•ä¸ªè½¦ç‰Œé•¿åº¦æ£€æŸ¥ |

---

## ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰ âŒ

```
è¾“å…¥è½¦ç‰Œ"é»‘ADE357"
    â†“
ç‚¹å‡»æäº¤
    â†“
validateMultiCarForm() - æ£€æŸ¥carListæ•°ç»„
    â†“
carList.length === 0
    â†“
âŒ æç¤ºï¼š"è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªè½¦ç‰Œå·"
```

### ä¿®å¤å âœ…

```
è¾“å…¥è½¦ç‰Œ"é»‘ADE357"
    â†“
ç‚¹å‡»æäº¤
    â†“
validateSingleCarForm() - æ£€æŸ¥getPlateNumber()
    â†“
getPlateNumber() è¿”å› "é»‘ADE357"
    â†“
é•¿åº¦ = 8ï¼Œå¤§äº7 âœ…
    â†“
submitSingleCarAppointment()
    â†“
âœ… æäº¤æˆåŠŸï¼Œè·³è½¬åˆ°ç»“æœé¡µ
```

---

## ç›¸å…³æ–‡ä»¶

- **ä¸»æ–‡ä»¶**: `pagesA/reservation/form.vue`
- **ä¿®æ”¹æ–¹æ³•**:
  - `submit()` - ç¬¬3742-3814è¡Œ
  - `validateSingleCarForm()` - ç¬¬3872-3916è¡Œï¼ˆæ–°å¢ï¼‰
  - `submitSingleCarAppointment()` - ç¬¬9025-9103è¡Œï¼ˆæ–°å¢ï¼‰
  - é»‘åå•æ£€æŸ¥é€»è¾‘ - ç¬¬3773-3793è¡Œ

---

## å‚è€ƒæ–‡ä»¶

- `d:\github-demo\car-new-demo\car-new-demo\pagesA\reservation\form.vue`
- å‚è€ƒäº†å…¶ä¸­çš„ `validateForm()` æ–¹æ³•å’Œå•è½¦ç‰ŒéªŒè¯é€»è¾‘

---

## æµ‹è¯•éªŒè¯

### ä¸šä¸»é¢„çº¦

1. âœ… é€‰æ‹©æ—¥æœŸ
2. âœ… å¡«å†™è”ç³»ç”µè¯ï¼ˆè‡ªåŠ¨å¡«å……ï¼‰
3. âœ… é€‰æ‹©æ¥è®¿åŸå› 
4. âœ… è¾“å…¥è½¦ç‰Œå·ï¼ˆå¦‚ï¼šäº¬A12345ï¼‰
5. âœ… é€‰æ‹©è½¦ç‰Œé¢œè‰²
6. âœ… ç‚¹å‡»æäº¤
7. âœ… éªŒè¯é€šè¿‡
8. âœ… æäº¤æˆåŠŸ
9. âœ… è·³è½¬åˆ°ç»“æœé¡µ

### ç®¡å®¶ä»£äººé¢„çº¦

1. âœ… é€‰æ‹©åœ°å€ï¼ˆæ˜¾ç¤ºä¸šä¸»ä¿¡æ¯ï¼‰
2. âœ… é€‰æ‹©æ—¥æœŸ
3. âœ… å¡«å†™è”ç³»ç”µè¯
4. âœ… é€‰æ‹©æ¥è®¿åŸå› 
5. âœ… è¾“å…¥è½¦ç‰Œå·ï¼ˆå¦‚ï¼šé»‘ADE357ï¼‰
6. âœ… é€‰æ‹©è½¦ç‰Œé¢œè‰²ï¼ˆé»‘ç‰Œï¼‰
7. âœ… ç‚¹å‡»æäº¤
8. âœ… éªŒè¯é€šè¿‡ï¼ˆä½¿ç”¨getPlateNumber()ï¼‰
9. âœ… æäº¤æˆåŠŸï¼ˆappointtype="ä»£äºº"ï¼‰
10. âœ… è·³è½¬åˆ°ç»“æœé¡µ

### è®¿å®¢é‚€è¯·é¢„çº¦

1. âœ… æ‰«æäºŒç»´ç 
2. âœ… é€‰æ‹©æ—¥æœŸ
3. âœ… æ·»åŠ å¤šä¸ªè½¦ç‰Œ
4. âœ… ç‚¹å‡»æäº¤
5. âœ… éªŒè¯carListæ•°ç»„
6. âœ… é€ä¸ªæäº¤è½¦ç‰Œ
7. âœ… è·³è½¬åˆ°ç»“æœé¡µ

---

## ä¿®å¤æ—¥æœŸ
2025å¹´12æœˆ3æ—¥

## ä¿®å¤äººå‘˜
Cascade AI Assistant

## ç›¸å…³é—®é¢˜
- å•è½¦ç‰Œè¾“å…¥æç¤º"è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªè½¦ç‰Œå·"
- validateMultiCarFormæ£€æŸ¥carListæ•°ç»„
- ä¸šä¸»å’Œç®¡å®¶æ— æ³•æäº¤é¢„çº¦
