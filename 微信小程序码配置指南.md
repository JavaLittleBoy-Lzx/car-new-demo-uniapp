# å¾®ä¿¡å°ç¨‹åºç é…ç½®æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

è¦å®ç°è®¿å®¢æ‰«ç ç›´æ¥è·³è½¬åˆ°å°ç¨‹åºï¼Œéœ€è¦ç”Ÿæˆå¾®ä¿¡å®˜æ–¹çš„å°ç¨‹åºç ï¼Œè€Œä¸æ˜¯æ™®é€šçš„äºŒç»´ç ã€‚æœ¬æ–‡æ¡£å°†è¯¦ç»†è¯´æ˜é…ç½®æ­¥éª¤ã€‚

## ğŸ—ï¸ é…ç½®æ­¥éª¤

### 1. å¾®ä¿¡å¼€å‘è€…åå°é…ç½®

#### 1.1 ç™»å½•å¾®ä¿¡å…¬ä¼—å¹³å°
- è®¿é—®ï¼šhttps://mp.weixin.qq.com
- ä½¿ç”¨å°ç¨‹åºç®¡ç†å‘˜è´¦å·ç™»å½•

#### 1.2 è·å–å¼€å‘ä¿¡æ¯
1. è¿›å…¥ã€è®¾ç½®ã€‘â†’ã€å¼€å‘è®¾ç½®ã€‘
2. è®°å½•ä»¥ä¸‹ä¿¡æ¯ï¼š
   - `AppID`ï¼šå°ç¨‹åºå”¯ä¸€æ ‡è¯†
   - `AppSecret`ï¼šå°ç¨‹åºå¯†é’¥ï¼ˆéœ€è¦ç”Ÿæˆï¼‰

#### 1.3 é…ç½®æœåŠ¡å™¨åŸŸå
1. åœ¨ã€è®¾ç½®ã€‘â†’ã€å¼€å‘è®¾ç½®ã€‘â†’ã€æœåŠ¡å™¨åŸŸåã€‘
2. æ·»åŠ åç«¯åŸŸååˆ° `request åˆæ³•åŸŸå`ï¼š
   ```
   https://your-backend-domain.com
   ```

### 2. åç«¯å®ç°

#### 2.1 æ·»åŠ å¾®ä¿¡APIä¾èµ–
```xml
<!-- pom.xml -->
<dependency>
    <groupId>com.github.binarywang</groupId>
    <artifactId>weixin-java-miniapp</artifactId>
    <version>4.6.0</version>
</dependency>
```

#### 2.2 é…ç½®æ–‡ä»¶
```yaml
# application.yml
wechat:
  miniapp:
    appid: your_miniapp_appid
    secret: your_miniapp_secret
```

#### 2.3 å¾®ä¿¡é…ç½®ç±»
```java
@Configuration
public class WechatMiniAppConfig {
    
    @Value("${wechat.miniapp.appid}")
    private String appId;
    
    @Value("${wechat.miniapp.secret}")
    private String secret;
    
    @Bean
    public WxMaService wxMaService() {
        WxMaService service = new WxMaServiceImpl();
        WxMaDefaultConfigImpl config = new WxMaDefaultConfigImpl();
        config.setAppid(appId);
        config.setSecret(secret);
        service.setWxMaConfig(config);
        return service;
    }
}
```

#### 2.4 å°ç¨‹åºç ç”ŸæˆæœåŠ¡
```java
@Service
public class MiniProgramCodeService {
    
    @Autowired
    private WxMaService wxMaService;
    
    /**
     * ç”Ÿæˆè®¿å®¢é‚€è¯·å°ç¨‹åºç 
     */
    public byte[] generateVisitorInviteCode(String butlerPhone, String fullAddress, 
                                          String addressInfo) {
        try {
            // æ„å»ºåœºæ™¯å€¼ï¼ˆæœ€å¤š32ä½å­—ç¬¦ï¼‰
            String scene = String.format("b=%s&a=%s", 
                butlerPhone.substring(butlerPhone.length() - 8), // æ‰‹æœºå·å8ä½
                addressInfo.hashCode() & 0x7FFFFFFF // åœ°å€ä¿¡æ¯å“ˆå¸Œå€¼
            );
            
            // ç”Ÿæˆå°ç¨‹åºç 
            WxMaQrcodeGenRequest request = new WxMaQrcodeGenRequest();
            request.setPage("pages/auth/visitor-apply"); // ç›®æ ‡é¡µé¢
            request.setScene(scene); // åœºæ™¯å€¼
            request.setWidth(430); // äºŒç»´ç å®½åº¦
            request.setAutoColor(false); // ä¸ä½¿ç”¨è‡ªåŠ¨é…è‰²
            request.setLineColor(new WxMaQrcodeGenRequest.LineColor("0", "0", "0")); // é»‘è‰²
            request.setIsHyaline(false); // ä¸é€æ˜
            
            // è°ƒç”¨å¾®ä¿¡APIç”Ÿæˆå°ç¨‹åºç 
            File qrCodeFile = wxMaService.getQrcodeService().createWxaCodeUnlimitBytes(request);
            
            // è¯»å–æ–‡ä»¶å†…å®¹
            return Files.readAllBytes(qrCodeFile.toPath());
            
        } catch (Exception e) {
            log.error("ç”Ÿæˆå°ç¨‹åºç å¤±è´¥", e);
            throw new RuntimeException("ç”Ÿæˆå°ç¨‹åºç å¤±è´¥: " + e.getMessage());
        }
    }
}
```

å®Œæˆä»¥ä¸Šé…ç½®åï¼Œè®¿å®¢æ‰«æå°ç¨‹åºç å°†èƒ½å¤Ÿç›´æ¥è·³è½¬åˆ°å°ç¨‹åºï¼ 