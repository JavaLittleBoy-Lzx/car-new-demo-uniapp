# 访客二维码一次性使用功能实现说明

## 功能概述

实现了访客二维码一次性使用功能，确保：
1. 扫描访客二维码时先检查qr_code_usage表中的qrId是否已被使用
2. 如果已使用，不允许用户进入系统
3. 如果未使用，允许进入系统，但只有在用户完成预约记录后才标记二维码为已使用
4. 只有通过访客二维码扫描且还没有完成预约记录的情况下才能打开form.vue表单

## 实现细节

### 前端修改

#### 1. 访问控制逻辑优化 (pages/reservation/form.vue)

**checkPageAccess方法**：
- 管家角色直接放行
- 访客二维码一次性使用控制：
  - 检测到qrId参数时，先检查是否已被使用
  - 如果已使用，显示锁定界面拒绝访问
  - 如果未使用，调用validateQrCodeWithoutMarking验证但不标记为已使用
- 没有二维码参数时，访客用户不允许直接访问表单

#### 2. 新增验证方法

**validateQrCodeWithoutMarking方法**：
- 只验证二维码有效性，不标记为已使用
- 用于访问控制检查阶段
- 调用新的后端接口 `/parking/qrcode/validateOnly`

**markQrCodeAsUsed方法优化**：
- 预约完成后调用原有的validate接口来真正标记二维码为已使用
- 确保只有在预约记录真正完成时才标记

#### 3. 用户界面优化

**showVisitorAccessDenied方法**：
- 显示访客访问被拒绝界面
- 提示访客必须通过扫描专用二维码才能访问

### 后端修改

#### 1. 新增API接口 (QrCodeController.java)

**validateOnly接口**：
```java
@PostMapping("/validateOnly")
public ResponseEntity<Result> validateQrCodeOnly(
    @RequestParam String qrId,
    @RequestParam String openid,
    @RequestParam(required = false) String visitorPhone)
```

#### 2. 服务层实现 (QrCodeUsageService.java & QrCodeUsageServiceImpl.java)

**validateQrCodeOnly方法**：
- 查询二维码记录
- 检查是否已使用
- 检查有效期
- 不标记为已使用，只生成访问令牌

#### 3. API配置更新 (config/api.js)

添加新的接口配置：
```javascript
qrcode: {
  validateOnly: '/parking/qrcode/validateOnly', // 只验证不标记为已使用
  // ... 其他接口
}
```

## 工作流程

### 1. 访客扫描二维码
1. 用户扫描管家生成的访客二维码
2. 系统检测到qrId参数
3. 调用checkQrCodeUsed检查是否已被使用
4. 如果已使用，显示锁定界面
5. 如果未使用，调用validateQrCodeWithoutMarking验证有效性
6. 验证通过后允许进入表单页面

### 2. 预约提交过程
1. 用户填写预约信息并提交
2. 预约数据保存成功后
3. 调用markQrCodeAsUsed方法
4. 使用原有的validate接口标记二维码为已使用
5. 同步到本地存储确保功能可用

### 3. 重复扫描处理
1. 如果用户再次扫描已使用的二维码
2. checkQrCodeUsed检查发现已被使用
3. 显示锁定界面，提示联系管家重新生成

## 安全特性

1. **一次性使用**：每个二维码只能使用一次
2. **访问控制**：访客必须通过二维码才能访问表单
3. **状态同步**：本地和后端双重状态管理
4. **容错机制**：后端不可用时本地存储仍然生效

## 测试建议

1. **正常流程测试**：
   - 扫描新二维码 → 进入表单 → 完成预约 → 二维码标记为已使用

2. **重复使用测试**：
   - 扫描已使用的二维码 → 显示锁定界面

3. **访问控制测试**：
   - 访客直接访问表单URL → 显示访问被拒绝界面

4. **网络异常测试**：
   - 断网情况下的本地存储检查功能

## 注意事项

1. 管家角色不受访问控制限制
2. 本地存储作为备用机制确保功能可用
3. 二维码验证和标记使用不同的接口
4. 预约完成后才真正标记二维码为已使用
