# 访客二维码一次性使用修复验证

## 问题描述

用户报告：数据库中 `is_used` 字段为 1 的二维码（如 `QR_1752473731552_7970_x6r0ycjbw`）仍然可以显示 phone-auth.vue 页面，没有被正确拦截。

## 修复内容

### 1. 增强二维码检查逻辑

**文件**: `pages/auth/phone-auth.vue`

**修改点**:
1. **同步等待检查结果**: 将异步的二维码检查改为 Promise 链式调用，确保检查完成后再决定是否继续
2. **立即显示错误**: 检测到已使用的二维码时，立即显示错误提示
3. **页面锁定机制**: 添加 `isPageLocked` 状态，当二维码已使用时锁定整个页面
4. **视觉反馈**: 添加锁定遮罩，防止用户继续操作

### 2. 关键修改

#### onLoad 方法中的检查逻辑
```javascript
// 🔒 检查访客二维码是否已被使用（同步等待）
if (this.scannedParams.qrId) {
    console.log('🔍 检测到访客二维码，开始验证:', this.scannedParams.qrId);
    this.checkVisitorQrCodeUsage(this.scannedParams.qrId).then(isValid => {
        if (!isValid) {
            console.warn('🔒 二维码验证失败，已阻止页面继续加载');
            return; // 如果二维码无效，不继续执行后续逻辑
        }
        console.log('✅ 二维码验证通过，继续页面加载');
    }).catch(error => {
        console.error('❌ 二维码验证异常:', error);
    });
}
```

#### 增强的错误显示
```javascript
showQrCodeUsedError(qrId, usageData) {
    const usedTime = usageData.usedTime ? new Date(usageData.usedTime).toLocaleString() : '未知时间';

    // 立即隐藏页面内容，显示锁定状态
    this.isPageLocked = true;

    uni.showModal({
        title: '🔒 二维码已使用',
        content: `此访客二维码已被使用，无法重复使用。\n\n📅 使用时间：${usedTime}\n🆔 二维码ID：${qrId}\n\n⚠️ 每个访客二维码只能使用一次，请联系管家重新生成二维码。`,
        showCancel: false,
        confirmText: '知道了',
        success: () => {
            // 立即跳转回首页或关闭页面
            uni.reLaunch({
                url: '/pages/index/index'
            });
        }
    });
}
```

#### 页面锁定遮罩
```vue
<!-- 🔒 页面锁定遮罩（二维码已使用时显示） -->
<view v-if="isPageLocked" class="page-lock-overlay">
    <view class="lock-content">
        <text class="lock-icon">🔒</text>
        <text class="lock-title">访问已被阻止</text>
        <text class="lock-message">此二维码已被使用，正在跳转...</text>
    </view>
</view>

<!-- 正常页面内容（未锁定时显示） -->
<view v-if="!isPageLocked">
    <!-- 原有页面内容 -->
</view>
```

## 测试步骤

### 1. 测试已使用的二维码

**测试URL**:
```
/pages/auth/phone-auth?qrId=QR_1752473731552_7970_x6r0ycjbw
```

**预期结果**:
1. 页面加载时立即检查二维码状态
2. 检测到 `is_used=1`，立即显示锁定遮罩
3. 弹出错误提示："🔒 二维码已使用"
4. 用户点击"知道了"后跳转到首页
5. 控制台显示相关日志

### 2. 测试未使用的二维码

**测试URL**:
```
/pages/auth/phone-auth?qrId=TEST_QR_NEW_001
```

**预期结果**:
1. 页面正常加载
2. 二维码验证通过
3. 用户可以继续使用页面功能
4. 控制台显示："✅ 访客二维码未使用，允许继续"

### 3. 验证要点

#### 控制台日志检查
观察以下关键日志：
- `🔍 检测到访客二维码，开始验证: [qrId]`
- `🔍 检查访客二维码使用状态: [qrId]`
- `🔍 二维码使用状态检查响应: [response]`
- `🔒 访客二维码已被使用，立即拒绝访问` 或 `✅ 访客二维码未使用，允许继续`

#### 网络请求检查
在浏览器开发者工具的Network标签中检查：
- 请求URL：`/parking/qrcode/checkUsed`
- 请求方法：GET
- 请求参数：qrId, openid
- 响应状态：200
- 响应数据：`{"code":"0","data":{"used":true/false}}`

#### 数据库状态验证
```sql
-- 检查测试二维码的使用状态
SELECT qr_id, is_used, used_time, visitor_openid 
FROM qr_code_usage 
WHERE qr_id = 'QR_1752473731552_7970_x6r0ycjbw';
```

## 安全特性

1. **早期拦截**: 在页面加载阶段就检查二维码状态
2. **视觉锁定**: 使用遮罩层防止用户继续操作
3. **强制跳转**: 检测到已使用的二维码时强制跳转到首页
4. **容错处理**: 网络异常时也会阻止访问
5. **用户友好**: 提供清晰的错误信息和使用时间

## 注意事项

1. 确保后端 `/parking/qrcode/checkUsed` 接口正常工作
2. 确保前端能正确解析URL参数中的qrId
3. 测试时注意观察控制台日志和网络请求
4. 验证页面锁定遮罩的显示效果
