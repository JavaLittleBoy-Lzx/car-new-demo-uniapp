# è½¦è¾†åœè½¦è¶…æ—¶æé†’åŠŸèƒ½å®ç°æ–¹æ¡ˆ

## 1. éœ€æ±‚åˆ†æ

### 1.1 åŠŸèƒ½æè¿°
- **æ ¸å¿ƒéœ€æ±‚**ï¼šä¸ç®¡æ˜¯å“ªä¸ªè§’è‰²é¢„çº¦äº†è½¦è¾†ï¼Œè½¦è¾†è¿›åœºåï¼Œæ ¹æ®è½¦åœºè®¾ç½®çš„åœè½¦è¶…æ—¶æ—¶é—´ï¼Œåœ¨ç”¨æˆ·è·ç¦»è¶…æ—¶å‰15åˆ†é’Ÿé€šè¿‡å…¬ä¼—å·æ¶ˆæ¯æ¨é€æé†’ç”¨æˆ·
- **é€‚ç”¨è§’è‰²**ï¼šæ‰€æœ‰é¢„çº¦è½¦è¾†çš„ç”¨æˆ·ï¼ˆä¸šä¸»ã€è®¿å®¢ã€ä¸´æ—¶è½¦è¾†ç­‰ï¼‰
- **æé†’æ–¹å¼**ï¼šå¾®ä¿¡å…¬ä¼—å·è®¢é˜…æ¶ˆæ¯æ¨é€
- **æé†’æ—¶æœº**ï¼šè¶…æ—¶å‰15åˆ†é’Ÿ

### 1.2 ä¸šåŠ¡æµç¨‹
1. ç”¨æˆ·é¢„çº¦è½¦è¾†è¿›åœº
2. è½¦è¾†å®é™…è¿›åœºï¼Œç³»ç»Ÿè®°å½•è¿›åœºæ—¶é—´
3. ç³»ç»Ÿæ ¹æ®è½¦åœºè¶…æ—¶æ—¶é—´è®¾ç½®è®¡ç®—é¢„è®¡ç¦»åœºæ—¶é—´
4. å®šæ—¶ä»»åŠ¡æ£€æŸ¥æ‰€æœ‰åœ¨åœºè½¦è¾†ï¼Œç­›é€‰å‡ºå³å°†è¶…æ—¶çš„è½¦è¾†ï¼ˆ15åˆ†é’Ÿå†…ï¼‰
5. å‘é€å…¬ä¼—å·æ¶ˆæ¯æé†’ç”¨æˆ·

## 2. ç³»ç»Ÿæ¶æ„åˆ†æ

### 2.1 ç°æœ‰ç›¸å…³æ¨¡å—
- **VehicleReservation**ï¼šè½¦è¾†é¢„çº¦å®ä½“ï¼Œè®°å½•é¢„çº¦å’Œè¿›åœºä¿¡æ¯
- **SubscribeMessageController**ï¼šè®¢é˜…æ¶ˆæ¯æ¨é€æ§åˆ¶å™¨
- **å®šæ—¶ä»»åŠ¡åŸºç¡€**ï¼šå·²æœ‰@Scheduledæ³¨è§£çš„å®šæ—¶ä»»åŠ¡ç¤ºä¾‹

### 2.2 éœ€è¦æ–°å¢çš„æ¨¡å—
1. **åœè½¦è¶…æ—¶æ—¶é—´é…ç½®è¡¨**
2. **æ¶ˆæ¯æé†’è®°å½•è¡¨**
3. **è¶…æ—¶æé†’å®šæ—¶ä»»åŠ¡**
4. **å¾®ä¿¡å…¬ä¼—å·æ¶ˆæ¯æ¨¡æ¿**

## 3. æ•°æ®åº“è®¾è®¡

### 3.1 åœè½¦è¶…æ—¶æ—¶é—´é…ç½®è¡¨ (parking_timeout_config)
```sql
CREATE TABLE `parking_timeout_config` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
  `yard_code` varchar(50) DEFAULT NULL COMMENT 'è½¦åœºç¼–ç ',
  `yard_name` varchar(100) DEFAULT NULL COMMENT 'è½¦åœºåç§°',
  `vehicle_type` varchar(50) DEFAULT NULL COMMENT 'è½¦è¾†ç±»å‹ï¼ˆä¸´æ—¶ã€è®¿å®¢ã€ä¸šä¸»ç­‰ï¼‰',
  `timeout_minutes` int(11) DEFAULT NULL COMMENT 'è¶…æ—¶æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰',
  `is_active` tinyint(1) DEFAULT '1' COMMENT 'æ˜¯å¦å¯ç”¨ï¼š1-å¯ç”¨ï¼Œ0-ç¦ç”¨',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  KEY `idx_yard_code` (`yard_code`),
  KEY `idx_vehicle_type` (`vehicle_type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='åœè½¦è¶…æ—¶æ—¶é—´é…ç½®è¡¨';
```

### 3.2 æ¶ˆæ¯æé†’è®°å½•è¡¨ (message_notification_log)
```sql
CREATE TABLE `message_notification_log` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
  `reservation_id` int(11) DEFAULT NULL COMMENT 'é¢„çº¦è®°å½•ID',
  `plate_number` varchar(20) DEFAULT NULL COMMENT 'è½¦ç‰Œå·ç ',
  `openid` varchar(100) DEFAULT NULL COMMENT 'å¾®ä¿¡OpenID',
  `message_type` varchar(50) DEFAULT NULL COMMENT 'æ¶ˆæ¯ç±»å‹ï¼ˆtimeout_warningï¼‰',
  `message_content` text COMMENT 'æ¶ˆæ¯å†…å®¹',
  `send_time` datetime DEFAULT NULL COMMENT 'å‘é€æ—¶é—´',
  `send_status` tinyint(1) DEFAULT '0' COMMENT 'å‘é€çŠ¶æ€ï¼š0-å¾…å‘é€ï¼Œ1-å·²å‘é€ï¼Œ2-å‘é€å¤±è´¥',
  `error_message` text COMMENT 'é”™è¯¯ä¿¡æ¯',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  PRIMARY KEY (`id`),
  KEY `idx_reservation_id` (`reservation_id`),
  KEY `idx_plate_number` (`plate_number`),
  KEY `idx_send_time` (`send_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æ¶ˆæ¯æé†’è®°å½•è¡¨';
```

### 3.3 ä¿®æ”¹ç°æœ‰é¢„çº¦è¡¨
éœ€è¦åœ¨ `appointment` è¡¨ä¸­æ·»åŠ å­—æ®µï¼š
```sql
ALTER TABLE `appointment` 
ADD COLUMN `openid` varchar(100) DEFAULT NULL COMMENT 'ç”¨æˆ·å¾®ä¿¡OpenID',
ADD COLUMN `expected_leave_time` datetime DEFAULT NULL COMMENT 'é¢„è®¡ç¦»åœºæ—¶é—´',
ADD COLUMN `timeout_notified` tinyint(1) DEFAULT '0' COMMENT 'æ˜¯å¦å·²å‘é€è¶…æ—¶æé†’ï¼š0-æœªå‘é€ï¼Œ1-å·²å‘é€';
```

## 4. æ ¸å¿ƒåŠŸèƒ½å®ç°

### 4.1 å®ä½“ç±»è®¾è®¡

#### 4.1.1 åœè½¦è¶…æ—¶é…ç½®å®ä½“
```java
@Data
@ApiModel(value="ParkingTimeoutConfig", description="åœè½¦è¶…æ—¶æ—¶é—´é…ç½®")
public class ParkingTimeoutConfig {
    @ApiModelProperty(value = "ä¸»é”®ID")
    @TableId(value = "id", type = IdType.AUTO)
    private Integer id;
    
    @ApiModelProperty(value = "è½¦åœºç¼–ç ")
    private String yardCode;
    
    @ApiModelProperty(value = "è½¦åœºåç§°")
    private String yardName;
    
    @ApiModelProperty(value = "è½¦è¾†ç±»å‹")
    private String vehicleType;
    
    @ApiModelProperty(value = "è¶…æ—¶æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰")
    private Integer timeoutMinutes;
    
    @ApiModelProperty(value = "æ˜¯å¦å¯ç”¨")
    private Boolean isActive;
    
    @ApiModelProperty(value = "åˆ›å»ºæ—¶é—´")
    @TableField(fill = FieldFill.INSERT)
    private Date createTime;
    
    @ApiModelProperty(value = "æ›´æ–°æ—¶é—´")
    @TableField(fill = FieldFill.INSERT_UPDATE)
    private Date updateTime;
}
```

#### 4.1.2 æ¶ˆæ¯æé†’è®°å½•å®ä½“
```java
@Data
@ApiModel(value="MessageNotificationLog", description="æ¶ˆæ¯æé†’è®°å½•")
public class MessageNotificationLog {
    @ApiModelProperty(value = "ä¸»é”®ID")
    @TableId(value = "id", type = IdType.AUTO)
    private Integer id;
    
    @ApiModelProperty(value = "é¢„çº¦è®°å½•ID")
    private Integer reservationId;
    
    @ApiModelProperty(value = "è½¦ç‰Œå·ç ")
    private String plateNumber;
    
    @ApiModelProperty(value = "å¾®ä¿¡OpenID")
    private String openid;
    
    @ApiModelProperty(value = "æ¶ˆæ¯ç±»å‹")
    private String messageType;
    
    @ApiModelProperty(value = "æ¶ˆæ¯å†…å®¹")
    private String messageContent;
    
    @ApiModelProperty(value = "å‘é€æ—¶é—´")
    private Date sendTime;
    
    @ApiModelProperty(value = "å‘é€çŠ¶æ€")
    private Integer sendStatus;
    
    @ApiModelProperty(value = "é”™è¯¯ä¿¡æ¯")
    private String errorMessage;
    
    @ApiModelProperty(value = "åˆ›å»ºæ—¶é—´")
    @TableField(fill = FieldFill.INSERT)
    private Date createTime;
}
```

### 4.2 æœåŠ¡å±‚å®ç°

#### 4.2.1 åœè½¦è¶…æ—¶æé†’æœåŠ¡
```java
@Service
@Slf4j
public class ParkingTimeoutNotificationService {
    
    @Autowired
    private AppointmentService appointmentService;
    
    @Autowired
    private ParkingTimeoutConfigService parkingTimeoutConfigService;
    
    @Autowired
    private MessageNotificationLogService messageNotificationLogService;
    
    @Autowired
    private WechatMessageService wechatMessageService;
    
    /**
     * æ£€æŸ¥å¹¶å‘é€è¶…æ—¶æé†’
     */
    public void checkAndSendTimeoutNotifications() {
        log.info("å¼€å§‹æ£€æŸ¥è½¦è¾†åœè½¦è¶…æ—¶æé†’");
        
        // 1. è·å–æ‰€æœ‰åœ¨åœºçš„è½¦è¾†ï¼ˆå·²è¿›åœºä½†æœªç¦»åœºï¼‰
        List<Appointment> inParkingVehicles = getInParkingVehicles();
        
        // 2. ç­›é€‰å‡ºå³å°†è¶…æ—¶çš„è½¦è¾†ï¼ˆ15åˆ†é’Ÿå†…ï¼‰
        List<Appointment> timeoutWarningVehicles = filterTimeoutWarningVehicles(inParkingVehicles);
        
        // 3. å‘é€æé†’æ¶ˆæ¯
        for (Appointment appointment : timeoutWarningVehicles) {
            try {
                sendTimeoutWarningMessage(appointment);
            } catch (Exception e) {
                log.error("å‘é€è¶…æ—¶æé†’å¤±è´¥ï¼Œè½¦ç‰Œå·ï¼š{}", appointment.getPlateNumber(), e);
            }
        }
        
        log.info("å®Œæˆæ£€æŸ¥è½¦è¾†åœè½¦è¶…æ—¶æé†’ï¼Œå…±å¤„ç†{}è¾†è½¦", timeoutWarningVehicles.size());
    }
    
    /**
     * è·å–æ‰€æœ‰åœ¨åœºçš„è½¦è¾†
     */
    private List<Appointment> getInParkingVehicles() {
        return appointmentService.lambdaQuery()
            .isNotNull(Appointment::getEnterTime)      // å·²è¿›åœº
            .isNull(Appointment::getLeaveTime)         // æœªç¦»åœº
            .eq(Appointment::getStatus, 1)             // çŠ¶æ€ä¸ºè¿›åœº
            .eq(Appointment::getTimeoutNotified, 0)    // æœªå‘é€è¿‡æé†’
            .isNotNull(Appointment::getOpenid)         // æœ‰OpenID
            .list();
    }
    
    /**
     * ç­›é€‰å³å°†è¶…æ—¶çš„è½¦è¾†ï¼ˆ15åˆ†é’Ÿå†…ï¼‰
     */
    private List<Appointment> filterTimeoutWarningVehicles(List<Appointment> appointments) {
        List<Appointment> result = new ArrayList<>();
        Date now = new Date();
        
        for (Appointment appointment : appointments) {
            // è·å–è¯¥è½¦åœºå’Œè½¦è¾†ç±»å‹çš„è¶…æ—¶æ—¶é—´é…ç½®
            ParkingTimeoutConfig config = parkingTimeoutConfigService.getByYardCodeAndVehicleType(
                appointment.getYardCode(), appointment.getVehicleType());
            
            if (config == null || !config.getIsActive()) {
                continue;
            }
            
            // è®¡ç®—é¢„è®¡ç¦»åœºæ—¶é—´
            Date enterTime = appointment.getEnterTime();
            if (enterTime == null) {
                continue;
            }
            
            Calendar calendar = Calendar.getInstance();
            calendar.setTime(enterTime);
            calendar.add(Calendar.MINUTE, config.getTimeoutMinutes());
            Date expectedLeaveTime = calendar.getTime();
            
            // è®¡ç®—è·ç¦»è¶…æ—¶çš„æ—¶é—´
            long timeDiff = expectedLeaveTime.getTime() - now.getTime();
            long minutesDiff = timeDiff / (60 * 1000);
            
            // å¦‚æœåœ¨15åˆ†é’Ÿå†…å³å°†è¶…æ—¶ï¼ŒåŠ å…¥æé†’åˆ—è¡¨
            if (minutesDiff > 0 && minutesDiff <= 15) {
                appointment.setExpectedLeaveTime(expectedLeaveTime);
                result.add(appointment);
            }
        }
        
        return result;
    }
    
    /**
     * å‘é€è¶…æ—¶æé†’æ¶ˆæ¯
     */
    private void sendTimeoutWarningMessage(Appointment appointment) {
        String openid = appointment.getOpenid();
        
        if (StringUtils.isEmpty(openid)) {
            log.warn("è½¦ç‰Œå·{}ç¼ºå°‘OpenIDï¼Œæ— æ³•å‘é€æé†’", appointment.getPlateNumber());
            return;
        }
        
        try {
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å…³æ³¨å…¬ä¼—å·
            boolean isSubscribed = wechatMessageService.checkUserSubscription(openid);
            if (!isSubscribed) {
                log.warn("ç”¨æˆ·{}æœªå…³æ³¨å…¬ä¼—å·ï¼Œæ— æ³•å‘é€æ¨¡æ¿æ¶ˆæ¯", openid);
                return;
            }
            
            // å‘é€å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯
            boolean success = wechatMessageService.sendTimeoutWarningMessage(
                openid, 
                appointment.getPlateNumber(),
                appointment.getYardName(),
                appointment.getExpectedLeaveTime(),
                appointment.getEnterTime()
            );
            
            // è®°å½•å‘é€æ—¥å¿—
            MessageNotificationLog log = new MessageNotificationLog();
            log.setReservationId(appointment.getId());
            log.setPlateNumber(appointment.getPlateNumber());
            log.setOpenid(openid);
            log.setMessageType("timeout_warning");
            log.setMessageContent(buildTimeoutWarningMessage(appointment));
            log.setSendTime(new Date());
            log.setSendStatus(success ? 1 : 2);
            messageNotificationLogService.save(log);
            
            // æ›´æ–°é¢„çº¦æé†’çŠ¶æ€
            if (success) {
                appointment.setTimeoutNotified(1);
                appointmentService.updateById(appointment);
            }
            
        } catch (Exception e) {
            log.error("å‘é€è¶…æ—¶æé†’å¤±è´¥", e);
            
            // è®°å½•å¤±è´¥æ—¥å¿—
            MessageNotificationLog errorLog = new MessageNotificationLog();
            errorLog.setReservationId(appointment.getId());
            errorLog.setPlateNumber(appointment.getPlateNumber());
            errorLog.setOpenid(openid);
            errorLog.setMessageType("timeout_warning");
            errorLog.setSendTime(new Date());
            errorLog.setSendStatus(2);
            errorLog.setErrorMessage(e.getMessage());
            messageNotificationLogService.save(errorLog);
        }
    }
    
    /**
     * æ„é€ è¶…æ—¶æé†’æ¶ˆæ¯å†…å®¹
     */
    private String buildTimeoutWarningMessage(Appointment appointment) {
        SimpleDateFormat sdf = new SimpleDateFormat("MMæœˆddæ—¥ HH:mm");
        return String.format(
            "ğŸš— åœè½¦è¶…æ—¶æé†’\n\n" +
            "è½¦ç‰Œå·ï¼š%s\n" +
            "åœè½¦åœºï¼š%s\n" +
            "é¢„è®¡ç¦»åœºæ—¶é—´ï¼š%s\n\n" +
            "æ‚¨çš„è½¦è¾†å°†åœ¨15åˆ†é’Ÿå†…è¶…æ—¶ï¼Œè¯·åŠæ—¶ç¦»åœºï¼",
            appointment.getPlateNumber(),
            appointment.getYardName(),
            sdf.format(appointment.getExpectedLeaveTime())
        );
    }
}
```

#### 4.2.2 å¾®ä¿¡æ¶ˆæ¯æœåŠ¡
```java
@Service
@Slf4j
public class WechatMessageService {
    
    @Value("${wechat.appid}")
    private String appId;
    
    @Value("${wechat.secret}")
    private String appSecret;
    
    @Value("${wechat.timeout.template.id}")
    private String timeoutTemplateId;
    
    private String accessToken;
    private Date tokenExpireTime;
    
    /**
     * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å…³æ³¨å…¬ä¼—å·
     */
    public boolean checkUserSubscription(String openid) {
        try {
            String token = getAccessToken();
            if (StringUtils.isEmpty(token)) {
                log.error("è·å–AccessTokenå¤±è´¥");
                return false;
            }
            
            String url = "https://api.weixin.qq.com/cgi-bin/user/info?access_token=" + token + "&openid=" + openid;
            String response = HttpClientUtil.doGet(url);
            JSONObject jsonResponse = JSON.parseObject(response);
            
            // subscribe=1è¡¨ç¤ºå·²å…³æ³¨ï¼Œ0è¡¨ç¤ºæœªå…³æ³¨
            return jsonResponse.getIntValue("subscribe") == 1;
        } catch (Exception e) {
            log.error("æ£€æŸ¥ç”¨æˆ·å…³æ³¨çŠ¶æ€å¤±è´¥", e);
            return false;
        }
    }
    
    /**
     * å‘é€è¶…æ—¶æé†’æ¶ˆæ¯
     */
    public boolean sendTimeoutWarningMessage(String openid, String plateNumber, 
                                           String yardName, Date expectedLeaveTime, Date enterTime) {
        try {
            // è·å–AccessToken
            String token = getAccessToken();
            if (StringUtils.isEmpty(token)) {
                log.error("è·å–AccessTokenå¤±è´¥");
                return false;
            }
            
            // æ„é€ æ¶ˆæ¯æ•°æ®
            Map<String, Object> messageData = buildMessageData(plateNumber, yardName, expectedLeaveTime, enterTime);
            
            // æ„é€ è¯·æ±‚ä½“
            Map<String, Object> requestBody = new HashMap<>();
            requestBody.put("touser", openid);
            requestBody.put("template_id", timeoutTemplateId);
            requestBody.put("data", messageData);
            
            // å‘é€æ¶ˆæ¯
            String url = "https://api.weixin.qq.com/cgi-bin/message/template/send?access_token=" + token;
            String response = HttpClientUtil.doPostJson(url, JSON.toJSONString(requestBody));
            
            log.info("å¾®ä¿¡æ¶ˆæ¯å‘é€å“åº”ï¼š{}", response);
            
            // è§£æå“åº”
            JSONObject jsonResponse = JSON.parseObject(response);
            int errcode = jsonResponse.getIntValue("errcode");
            
            return errcode == 0;
            
        } catch (Exception e) {
            log.error("å‘é€å¾®ä¿¡æ¶ˆæ¯å¤±è´¥", e);
            return false;
        }
    }
    
    /**
     * è·å–AccessToken
     */
    private String getAccessToken() {
        // å¦‚æœtokenæœªè¿‡æœŸï¼Œç›´æ¥è¿”å›
        if (accessToken != null && tokenExpireTime != null && 
            new Date().before(tokenExpireTime)) {
            return accessToken;
        }
        
        try {
            Map<String, String> params = new HashMap<>();
            params.put("grant_type", "client_credential");
            params.put("appid", appId);
            params.put("secret", appSecret);
            
            String response = HttpClientUtil.doPost("https://api.weixin.qq.com/cgi-bin/token", params);
            JSONObject jsonResponse = JSON.parseObject(response);
            
            if (jsonResponse.containsKey("access_token")) {
                accessToken = jsonResponse.getString("access_token");
                int expiresIn = jsonResponse.getIntValue("expires_in");
                
                // è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆæå‰5åˆ†é’Ÿè¿‡æœŸï¼‰
                Calendar calendar = Calendar.getInstance();
                calendar.add(Calendar.SECOND, expiresIn - 300);
                tokenExpireTime = calendar.getTime();
                
                return accessToken;
            } else {
                log.error("è·å–AccessTokenå¤±è´¥ï¼š{}", response);
                return null;
            }
            
        } catch (Exception e) {
            log.error("è·å–AccessTokenå¼‚å¸¸", e);
            return null;
        }
    }
    
    /**
     * æ„é€ æ¶ˆæ¯æ•°æ®
     */
    private Map<String, Object> buildMessageData(String plateNumber, String yardName, Date expectedLeaveTime, Date enterTime) {
        Map<String, Object> data = new HashMap<>();
        
        SimpleDateFormat sdf = new SimpleDateFormat("yyyyå¹´MMæœˆddæ—¥ HH:mm");
        
        // è®¡ç®—å‰©ä½™æ—¶é•¿
        long remainingMinutes = (expectedLeaveTime.getTime() - new Date().getTime()) / (60 * 1000);
        String remainingTime = remainingMinutes > 0 ? remainingMinutes + "åˆ†é’Ÿ" : "å·²è¶…æ—¶";
        
        // æ ¹æ®æ‚¨çš„å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯æ ¼å¼æ„é€ æ•°æ®
        data.put("thing2", createDataItem(yardName, "#173177"));           // åœè½¦åœºåç§°
        data.put("car_number5", createDataItem(plateNumber, "#173177"));   // è½¦ç‰Œå·
        data.put("const13", createDataItem(remainingTime, "#FF0000"));     // å‰©ä½™æ—¶é•¿
        data.put("time9", createDataItem(sdf.format(enterTime), "#173177")); // å…¥åœºæ—¶é—´
        data.put("time11", createDataItem(sdf.format(new Date()), "#173177")); // é€šçŸ¥æ—¶é—´
        
        return data;
    }
    
    /**
     * åˆ›å»ºæ•°æ®é¡¹
     */
    private Map<String, String> createDataItem(String value, String color) {
        Map<String, String> item = new HashMap<>();
        item.put("value", value);
        item.put("color", color);
        return item;
    }
}
```

### 4.3 å®šæ—¶ä»»åŠ¡å®ç°

#### 4.3.1 ä¿®æ”¹SubscribeMessageController
```java
@RestController
@RequestMapping(value = "/parking", method = {RequestMethod.GET, RequestMethod.POST})
public class SubscribeMessageController {
    
    @Autowired
    private ParkingTimeoutNotificationService parkingTimeoutNotificationService;
    
    // åŸæœ‰ä»£ç ...
    
    /**
     * åœè½¦è¶…æ—¶æé†’å®šæ—¶ä»»åŠ¡
     * æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
     */
    @Scheduled(fixedRate = 300000) // 5åˆ†é’Ÿ
    public void checkParkingTimeoutNotifications() {
        log.info("æ‰§è¡Œåœè½¦è¶…æ—¶æé†’å®šæ—¶ä»»åŠ¡");
        try {
            parkingTimeoutNotificationService.checkAndSendTimeoutNotifications();
        } catch (Exception e) {
            log.error("åœè½¦è¶…æ—¶æé†’å®šæ—¶ä»»åŠ¡æ‰§è¡Œå¤±è´¥", e);
        }
    }
}
```

## 5. é…ç½®å’Œéƒ¨ç½²

### 5.1 åº”ç”¨é…ç½®
åœ¨ `application.yml` ä¸­æ·»åŠ å¾®ä¿¡ç›¸å…³é…ç½®ï¼š
```yaml
wechat:
  appid: your_wechat_appid
  secret: your_wechat_secret
  timeout:
    template:
      id: 45414  # æ‚¨çš„å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯ID
```

### 5.2 å¾®ä¿¡å…¬ä¼—å·é…ç½®
1. ä½¿ç”¨æ‚¨å·²æœ‰çš„æ¨¡æ¿æ¶ˆæ¯ï¼ˆæ¨¡æ¿IDï¼š45414ï¼‰
2. æ¨¡æ¿å†…å®¹æ ¼å¼ï¼š
```
åœè½¦åœºåç§°ï¼š{{thing2.DATA}}
è½¦ç‰Œå·ï¼š{{car_number5.DATA}}
å‰©ä½™æ—¶é•¿ï¼š{{const13.DATA}}
å…¥åœºæ—¶é—´ï¼š{{time9.DATA}}
é€šçŸ¥æ—¶é—´ï¼š{{time11.DATA}}
```

3. åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®æ¨¡æ¿IDï¼š
```yaml
wechat:
  appid: your_wechat_appid
  secret: your_wechat_secret
  timeout:
    template:
      id: 45414  # æ‚¨çš„å®é™…æ¨¡æ¿ID
```

### 5.3 æ•°æ®åº“åˆå§‹åŒ–
1. åˆ›å»ºç›¸å…³è¡¨ç»“æ„
2. åˆå§‹åŒ–åœè½¦è¶…æ—¶æ—¶é—´é…ç½®æ•°æ®ï¼š
```sql
-- æ’å…¥ä¸åŒè½¦è¾†ç±»å‹çš„è¶…æ—¶æ—¶é—´é…ç½®
INSERT INTO parking_timeout_config (yard_code, yard_name, vehicle_type, timeout_minutes, is_active) VALUES
('YARD001', 'åœè½¦åœºA', 'ä¸´æ—¶è½¦è¾†', 120, 1),
('YARD001', 'åœè½¦åœºA', 'è®¿å®¢è½¦è¾†', 180, 1), 
('YARD001', 'åœè½¦åœºA', 'ä¸šä¸»è½¦è¾†', 720, 1);

-- ä¸ºappointmentè¡¨æ·»åŠ å¿…è¦å­—æ®µï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
ALTER TABLE `appointment` 
ADD COLUMN IF NOT EXISTS `openid` varchar(100) DEFAULT NULL COMMENT 'ç”¨æˆ·å¾®ä¿¡OpenID',
ADD COLUMN IF NOT EXISTS `expected_leave_time` datetime DEFAULT NULL COMMENT 'é¢„è®¡ç¦»åœºæ—¶é—´',
ADD COLUMN IF NOT EXISTS `timeout_notified` tinyint(1) DEFAULT '0' COMMENT 'æ˜¯å¦å·²å‘é€è¶…æ—¶æé†’ï¼š0-æœªå‘é€ï¼Œ1-å·²å‘é€',
ADD COLUMN IF NOT EXISTS `enter_time` datetime DEFAULT NULL COMMENT 'è¿›åœºæ—¶é—´',
ADD COLUMN IF NOT EXISTS `leave_time` datetime DEFAULT NULL COMMENT 'ç¦»åœºæ—¶é—´',
ADD COLUMN IF NOT EXISTS `yard_code` varchar(50) DEFAULT NULL COMMENT 'è½¦åœºç¼–ç ',
ADD COLUMN IF NOT EXISTS `yard_name` varchar(100) DEFAULT NULL COMMENT 'è½¦åœºåç§°',
ADD COLUMN IF NOT EXISTS `vehicle_type` varchar(50) DEFAULT NULL COMMENT 'è½¦è¾†ç±»å‹';
```

## 6. æµ‹è¯•æ–¹æ¡ˆ

### 6.1 å•å…ƒæµ‹è¯•
1. æµ‹è¯•è¶…æ—¶æ—¶é—´è®¡ç®—é€»è¾‘
2. æµ‹è¯•æ¶ˆæ¯å‘é€åŠŸèƒ½
3. æµ‹è¯•å®šæ—¶ä»»åŠ¡æ‰§è¡Œ

### 6.2 é›†æˆæµ‹è¯•
1. æ¨¡æ‹Ÿè½¦è¾†è¿›åœºåœºæ™¯
2. éªŒè¯å®šæ—¶ä»»åŠ¡æ­£å¸¸è¿è¡Œ
3. éªŒè¯æ¶ˆæ¯æ¨é€åˆ°è¾¾

### 6.3 å‹åŠ›æµ‹è¯•
1. å¤§é‡è½¦è¾†åŒæ—¶è¿›åœºçš„åœºæ™¯
2. æ¶ˆæ¯å‘é€å¹¶å‘æ€§èƒ½æµ‹è¯•

## 7. ç›‘æ§å’Œè¿ç»´

### 7.1 æ—¥å¿—ç›‘æ§
- å®šæ—¶ä»»åŠ¡æ‰§è¡Œæ—¥å¿—
- æ¶ˆæ¯å‘é€æˆåŠŸ/å¤±è´¥æ—¥å¿—
- æ€§èƒ½æŒ‡æ ‡æ—¥å¿—

### 7.2 å¼‚å¸¸å¤„ç†
- å¾®ä¿¡æ¥å£è°ƒç”¨å¤±è´¥é‡è¯•æœºåˆ¶
- æ•°æ®åº“å¼‚å¸¸å¤„ç†
- å®šæ—¶ä»»åŠ¡å¼‚å¸¸æ¢å¤

### 7.3 æ€§èƒ½ä¼˜åŒ–
- æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
- æ¶ˆæ¯å‘é€æ‰¹é‡å¤„ç†
- ç¼“å­˜æœºåˆ¶ä¼˜åŒ–

## 8. æœªå…³æ³¨å…¬ä¼—å·ç”¨æˆ·çš„å¤„ç†æ–¹æ¡ˆ

### 8.1 é—®é¢˜åˆ†æ
**æ ¸å¿ƒé—®é¢˜**ï¼šå¾®ä¿¡å…¬ä¼—å·æ¨¡æ¿æ¶ˆæ¯åªèƒ½å‘é€ç»™å·²å…³æ³¨å…¬ä¼—å·çš„ç”¨æˆ·ï¼Œæœªå…³æ³¨ç”¨æˆ·æ— æ³•æ¥æ”¶æ¨é€ã€‚

**æŠ€æœ¯é™åˆ¶**ï¼š
- æ¨¡æ¿æ¶ˆæ¯ï¼šä»…é™å…³æ³¨ç”¨æˆ·
- å®¢æœæ¶ˆæ¯ï¼šä»…é™48å°æ—¶å†…äº’åŠ¨è¿‡çš„ç”¨æˆ·

### 8.2 è§£å†³æ–¹æ¡ˆ

#### 8.2.1 æ£€æŸ¥ç”¨æˆ·å…³æ³¨çŠ¶æ€
ç³»ç»Ÿå·²ç»åœ¨`WechatMessageService`ä¸­å®ç°äº†ç”¨æˆ·å…³æ³¨çŠ¶æ€æ£€æŸ¥åŠŸèƒ½ï¼Œåªæœ‰å·²å…³æ³¨çš„ç”¨æˆ·æ‰ä¼šæ”¶åˆ°æ¨¡æ¿æ¶ˆæ¯ã€‚

#### 8.2.2 ç”¨æˆ·å…³æ³¨å¼•å¯¼ç­–ç•¥

##### é¢„çº¦æ—¶å¼•å¯¼å…³æ³¨
```java
/**
 * åœ¨ç”¨æˆ·é¢„çº¦æ—¶å¼•å¯¼å…³æ³¨å…¬ä¼—å·
 */
public class AppointmentService {
    
    public Result createAppointment(Appointment appointment) {
        // ä¿å­˜é¢„çº¦ä¿¡æ¯
        save(appointment);
        
        Result result = new Result();
        result.setData(appointment);
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å…³æ³¨å…¬ä¼—å·
        if (StringUtils.isNotEmpty(appointment.getOpenid())) {
            boolean isSubscribed = wechatMessageService.checkUserSubscription(appointment.getOpenid());
            if (!isSubscribed) {
                result.setMsg("é¢„çº¦æˆåŠŸï¼ä¸ºäº†åŠæ—¶æ¥æ”¶åœè½¦æé†’ï¼Œå»ºè®®æ‚¨å…³æ³¨æˆ‘ä»¬çš„å…¬ä¼—å·ã€‚");
                result.setCode("NEED_SUBSCRIBE");
                
                // è¿”å›å…¬ä¼—å·äºŒç»´ç æˆ–å…³æ³¨é“¾æ¥
                Map<String, Object> extraData = new HashMap<>();
                extraData.put("qrcode_url", "https://your-domain.com/qrcode");
                extraData.put("subscribe_tip", "æ‰«æäºŒç»´ç å…³æ³¨å…¬ä¼—å·ï¼ŒåŠæ—¶æ¥æ”¶åœè½¦æé†’");
                result.setExtra(extraData);
            }
        }
        
        return result;
    }
}
```

##### å°ç¨‹åºç«¯å¼•å¯¼
```javascript
// å°ç¨‹åºç«¯å¼•å¯¼ç”¨æˆ·å…³æ³¨å…¬ä¼—å·
onAppointmentSuccess(res) {
    if (res.code === 'NEED_SUBSCRIBE') {
        uni.showModal({
            title: 'æ¸©é¦¨æç¤º',
            content: 'ä¸ºäº†åŠæ—¶æ¥æ”¶åœè½¦è¶…æ—¶æé†’ï¼Œå»ºè®®æ‚¨å…³æ³¨æˆ‘ä»¬çš„å…¬ä¼—å·',
            confirmText: 'å»å…³æ³¨',
            cancelText: 'ç¨å',
            success: (modalRes) => {
                if (modalRes.confirm) {
                    // æ˜¾ç¤ºå…¬ä¼—å·äºŒç»´ç 
                    this.showQRCode(res.extra.qrcode_url);
                }
            }
        });
    }
}
```

### 8.3 ä¸šåŠ¡æµç¨‹
1. **ç”¨æˆ·é¢„çº¦æ—¶**ï¼šæ£€æŸ¥æ˜¯å¦å…³æ³¨å…¬ä¼—å·ï¼Œæœªå…³æ³¨åˆ™å¼•å¯¼å…³æ³¨
2. **å®šæ—¶ä»»åŠ¡æ£€æŸ¥æ—¶**ï¼šåªå¤„ç†å·²å…³æ³¨ç”¨æˆ·çš„è¶…æ—¶æé†’
3. **æœªå…³æ³¨ç”¨æˆ·**ï¼šæ— æ³•æ¥æ”¶æ¨é€ï¼Œä½†å¯ä»¥åœ¨å°ç¨‹åºä¸­æŸ¥çœ‹é¢„çº¦çŠ¶æ€

## 9. æ‰©å±•åŠŸèƒ½

### 9.1 å¤šçº§æé†’
- è¶…æ—¶å‰30åˆ†é’Ÿæé†’
- è¶…æ—¶å‰15åˆ†é’Ÿæé†’
- è¶…æ—¶å‰5åˆ†é’Ÿæé†’
- è¶…æ—¶åç«‹å³æé†’

### 9.2 ä¸ªæ€§åŒ–é…ç½®
- ç”¨æˆ·è‡ªå®šä¹‰æé†’æ—¶é—´
- ä¸åŒè½¦è¾†ç±»å‹ä¸åŒæé†’ç­–ç•¥
- æé†’æ–¹å¼é€‰æ‹©ï¼ˆçŸ­ä¿¡ã€å¾®ä¿¡ã€é‚®ä»¶ï¼‰

### 9.3 æ•°æ®åˆ†æ
- è¶…æ—¶ç‡ç»Ÿè®¡
- æé†’æ•ˆæœåˆ†æ
- ç”¨æˆ·è¡Œä¸ºåˆ†æ

## 10. æ€»ç»“

è¯¥æ–¹æ¡ˆåŸºäºç°æœ‰çš„ç³»ç»Ÿæ¶æ„ï¼Œä¸“æ³¨äºé€šè¿‡å…¬ä¼—å·æ¨¡æ¿æ¶ˆæ¯å®ç°åœè½¦è¶…æ—¶æé†’åŠŸèƒ½ï¼š

### 10.1 æ ¸å¿ƒåŠŸèƒ½
1. **æ•°æ®æ¨¡å‹**ï¼šæ‰©å±•appointmentè¡¨ï¼Œæ–°å¢è¶…æ—¶é…ç½®è¡¨å’Œæ¶ˆæ¯æ—¥å¿—è¡¨
2. **ä¸šåŠ¡é€»è¾‘**ï¼šå®šæ—¶æ£€æŸ¥åœ¨åœºè½¦è¾†ï¼Œè®¡ç®—è¶…æ—¶æ—¶é—´ï¼Œå‘é€æé†’æ¶ˆæ¯
3. **æ¶ˆæ¯æ¨é€**ï¼šé›†æˆå¾®ä¿¡å…¬ä¼—å·APIï¼Œå‘é€æ¨¡æ¿æ¶ˆæ¯
4. **å®šæ—¶ä»»åŠ¡**ï¼šæ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡æ£€æŸ¥ï¼Œç¡®ä¿åŠæ—¶æé†’
5. **å…³æ³¨æ£€æŸ¥**ï¼šåªå‘å·²å…³æ³¨å…¬ä¼—å·çš„ç”¨æˆ·å‘é€æ¨¡æ¿æ¶ˆæ¯

### 10.2 å®æ–½æ­¥éª¤

#### ç¬¬ä¸€æ­¥ï¼šæ•°æ®åº“æ”¹é€ 
```sql
-- 1. åˆ›å»ºè¶…æ—¶é…ç½®è¡¨
-- 2. åˆ›å»ºæ¶ˆæ¯æ—¥å¿—è¡¨
-- 3. ä¸ºappointmentè¡¨æ·»åŠ å¿…è¦å­—æ®µ
```

#### ç¬¬äºŒæ­¥ï¼šä»£ç å®ç°
```java
// 1. å®ç°ParkingTimeoutNotificationService
// 2. å®ç°WechatMessageServiceï¼ˆå…³æ³¨æ£€æŸ¥ + æ¨¡æ¿æ¶ˆæ¯ï¼‰
// 3. æ·»åŠ å®šæ—¶ä»»åŠ¡
```

#### ç¬¬ä¸‰æ­¥ï¼šå¾®ä¿¡é…ç½®
```
// 1. åˆ›å»ºå…¬ä¼—å·æ¨¡æ¿æ¶ˆæ¯
// 2. é…ç½®AppIDå’ŒSecret
// 3. è·å–æ¨¡æ¿ID
```

#### ç¬¬å››æ­¥ï¼šå¼•å¯¼ç”¨æˆ·å…³æ³¨
```javascript
// åœ¨å°ç¨‹åºé¢„çº¦æˆåŠŸæ—¶æç¤ºç”¨æˆ·å…³æ³¨å…¬ä¼—å·
```

### 10.3 ç‰¹ç‚¹ä¼˜åŠ¿

1. **ç®€å•å¯é **ï¼šåªä½¿ç”¨å…¬ä¼—å·æ¨¡æ¿æ¶ˆæ¯ï¼Œé¿å…å¤æ‚çš„å¤šæ¸ é“ç­–ç•¥
2. **ç²¾å‡†æ¨é€**ï¼šæ£€æŸ¥ç”¨æˆ·å…³æ³¨çŠ¶æ€ï¼Œç¡®ä¿æ¶ˆæ¯èƒ½å¤Ÿé€è¾¾
3. **ç”¨æˆ·å¼•å¯¼**ï¼šåœ¨é¢„çº¦æ—¶å¼•å¯¼ç”¨æˆ·å…³æ³¨ï¼Œæé«˜è¦†ç›–ç‡
4. **æ—¥å¿—å®Œæ•´**ï¼šè®°å½•æ‰€æœ‰æ¨é€æ—¥å¿—ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥

### 10.4 æ³¨æ„äº‹é¡¹

1. **ç”¨æˆ·ä½“éªŒ**ï¼šæœªå…³æ³¨ç”¨æˆ·æ— æ³•æ¥æ”¶æ¨é€ï¼Œéœ€è¦åšå¥½å¼•å¯¼å·¥ä½œ
2. **OpenIDè·å–**ï¼šç¡®ä¿é¢„çº¦æ—¶èƒ½å¤Ÿæ­£ç¡®è·å–ç”¨æˆ·çš„OpenID
3. **æ¨¡æ¿æ¶ˆæ¯æ ¼å¼**ï¼šä¸¥æ ¼æŒ‰ç…§å¾®ä¿¡è¦æ±‚çš„æ ¼å¼é…ç½®æ¨¡æ¿
4. **è®¿é—®ä»¤ç‰Œç®¡ç†**ï¼šåšå¥½AccessTokençš„ç¼“å­˜å’Œè‡ªåŠ¨åˆ·æ–°

### 10.5 åç»­ä¼˜åŒ–

1. **ç»Ÿè®¡åˆ†æ**ï¼šæ·»åŠ æ¨é€æˆåŠŸç‡ã€ç”¨æˆ·å…³æ³¨ç‡ç­‰ç»Ÿè®¡
2. **å¤šçº§æé†’**ï¼šå¯ä»¥å¢åŠ 30åˆ†é’Ÿã€5åˆ†é’Ÿç­‰å¤šä¸ªæ—¶é—´ç‚¹çš„æé†’
3. **ä¸ªæ€§åŒ–è®¾ç½®**ï¼šå…è®¸ç”¨æˆ·è‡ªå®šä¹‰æé†’æ—¶é—´
4. **A/Bæµ‹è¯•**ï¼šæµ‹è¯•ä¸åŒçš„æ¶ˆæ¯å†…å®¹å’Œå¼•å¯¼æ–¹å¼çš„æ•ˆæœ

è¿™ä¸ªç®€åŒ–æ–¹æ¡ˆä¸“æ³¨äºæ ¸å¿ƒéœ€æ±‚ï¼Œé€šè¿‡å…¬ä¼—å·æ¨¡æ¿æ¶ˆæ¯å®ç°å¯é çš„è¶…æ—¶æé†’åŠŸèƒ½ï¼Œæ˜“äºå®ç°å’Œç»´æŠ¤ã€‚ 