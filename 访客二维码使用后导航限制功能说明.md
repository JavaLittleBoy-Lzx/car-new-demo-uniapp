# 访客二维码使用后导航限制功能说明

## 功能概述

实现了访客二维码使用后的导航限制功能，确保：
1. 访客二维码使用后，点击"访客预约"导航栏时不能再进行预约
2. 但仍然可以查询已有的预约记录
3. 提供友好的用户提示和引导

## 实现原理

### 1. 二维码使用状态检查

在TabBar组件的`switchTab`方法中添加了访客角色的特殊处理：

```javascript
// 🔒 访客角色特殊处理：检查二维码使用状态
if (this.userRole === 'visitor' && item.pagePath === 'pages/reservation/form') {
    console.log('🔍 [TabBar] 访客点击预约导航，检查二维码使用状态');
    
    // 检查是否有已使用的二维码
    const hasUsedQrCode = await this.checkVisitorQrCodeUsage();
    if (hasUsedQrCode) {
        // 显示提示并阻止进入预约页面
        // 引导用户到查询页面
        return; // 阻止继续执行
    }
}
```

### 2. 二维码使用状态检查逻辑

`checkVisitorQrCodeUsage`方法通过以下方式检查：

1. **本地存储检查**：
   - 检查`scannedQrId`记录
   - 检查对应的`qr_used_${qrId}`标记

2. **后端API检查**：
   - 调用`/parking/appointment/listByPhone`接口
   - 检查是否有已完成的预约记录
   - 判断条件：`auditstatus === 'approved'` 或有`entryTime`

### 3. 用户提示和引导

当检测到二维码已使用时：

```javascript
uni.showModal({
    title: '无法进入预约',
    content: '您的访客二维码已经使用过了，每个二维码只能使用一次。\n\n您可以：\n• 查询已有的预约记录\n• 联系管家重新生成二维码',
    showCancel: true,
    cancelText: '查询记录',
    confirmText: '知道了',
    success: (res) => {
        if (!res.confirm) {
            // 用户选择查询记录，跳转到查询页面
            this.navigateToQueryPage();
        }
    }
});
```

## 技术实现细节

### 1. TabBar配置更新

访客角色使用标准的预约查询页面，与其他角色保持一致：

```javascript
visitor: [{
    pagePath: "pages/reservation/form",
    text: "访客预约",
    // ...
}, {
    pagePath: "pages/reservation/searchResult/searchResult",  // 使用标准的预约查询页面
    text: "预约查询",
    // ...
}]
```

### 2. 查询页面跳转统一

所有角色（包括访客）都统一跳转到标准的预约查询页面：

- `navigateToQueryPage`：统一使用`pages/reservation/searchResult/searchResult`
- 简化了页面路径处理逻辑
- 确保所有用户都有一致的查询体验

### 3. 导航跳转优化

```javascript
navigateToQueryPage() {
    // 统一跳转到预约查询页面 pages/reservation/searchResult/searchResult
    // 不管是什么角色，都使用这个标准的查询页面
    uni.switchTab({
        url: '/pagesA/reservation/searchResult/searchResult',
        success: () => {
            console.log('✅ [TabBar] 成功跳转到预约查询页面');
            // 更新TabBar状态到查询页面
            const queryTabIndex = this.visibleTabs.findIndex(tab =>
                tab.pagePath === 'pages/reservation/searchResult/searchResult'
            );
            if (queryTabIndex !== -1) {
                this.currentIndex = queryTabIndex;
                uni.$emit('updateTabBarIndex', queryTabIndex);
            }
        },
        fail: (err) => {
            // 降级处理：使用navigateTo
            uni.navigateTo({
                url: '/pagesA/reservation/searchResult/searchResult'
            });
        }
    });
}
```

## 工作流程

### 1. 正常访客预约流程
1. 访客扫描管家生成的二维码
2. 完成手机授权和预约信息填写
3. 提交预约成功后，二维码被标记为已使用

### 2. 二维码使用后的导航限制
1. 访客点击底部"访客预约"Tab
2. 系统检查二维码使用状态
3. 如果已使用，显示提示对话框
4. 用户可选择查询记录或了解情况

### 3. 查询功能保持可用
1. 访客仍可点击"预约查询"Tab
2. 或通过提示对话框快速跳转到标准查询页面 `pages/reservation/searchResult/searchResult`
3. 查看已有的预约记录和状态

## 安全特性

1. **双重检查**：本地存储 + 后端API检查
2. **用户友好**：清晰的提示信息和操作引导
3. **功能保留**：限制预约但保留查询功能
4. **容错处理**：网络异常时依然能基于本地存储工作

## 测试建议

### 1. 正常流程测试
- 新访客扫描二维码 → 完成预约 → 再次点击预约Tab → 应被阻止

### 2. 查询功能测试
- 已使用二维码的访客 → 点击查询Tab → 应正常显示预约记录

### 3. 提示引导测试
- 已使用二维码的访客 → 点击预约Tab → 选择"查询记录" → 应跳转到查询页面

### 4. 网络异常测试
- 断网情况下 → 依然能基于本地存储正确判断二维码使用状态

## 注意事项

1. 确保标准查询页面`pages/reservation/searchResult/searchResult`正常工作
2. 本地存储的二维码使用标记需要与后端状态保持同步
3. 网络异常时的降级处理确保功能可用
4. 用户体验优化：提示信息清晰，操作引导明确
5. 所有角色统一使用同一个查询页面，简化维护
