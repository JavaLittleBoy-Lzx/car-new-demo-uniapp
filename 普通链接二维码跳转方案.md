# æ™®é€šé“¾æ¥äºŒç»´ç è·³è½¬å°ç¨‹åºå®ç°æ–¹æ¡ˆ

> åŸºäºå¾®ä¿¡å®˜æ–¹æ–‡æ¡£ï¼šhttps://developers.weixin.qq.com/miniprogram/introduction/qrcode.html

## æ–¹æ¡ˆæ¦‚è¿°

é‡‡ç”¨**æ™®é€šé“¾æ¥äºŒç»´ç  + åå°é…ç½®è·³è½¬è§„åˆ™**çš„æ–¹å¼å®ç°æ‰«ç ç›´æ¥è·³è½¬å°ç¨‹åºã€‚

## æŠ€æœ¯ä¼˜åŠ¿

### ğŸ¯ ç›¸æ¯”å®˜æ–¹å°ç¨‹åºç APIçš„ä¼˜åŠ¿
- âœ… **æ— é¡µé¢è·¯å¾„é™åˆ¶**ï¼šä¸ä¼šå‡ºç° `errcode=41030, invalid page` é”™è¯¯
- âœ… **é…ç½®çµæ´»**ï¼šæ”¯æŒå­è·¯å¾„åŒ¹é…ï¼Œä¸€æ¬¡é…ç½®å¤šç§åœºæ™¯
- âœ… **å…¼å®¹æ€§å¥½**ï¼šæ”¯æŒç°æœ‰æ™®é€šäºŒç»´ç ï¼Œæ— éœ€é‡æ–°ç”Ÿæˆ
- âœ… **ç¨³å®šæ€§é«˜**ï¼šä¸ä¾èµ–å¾®ä¿¡å®˜æ–¹å°ç¨‹åºç APIçš„å¤æ‚é…ç½®

### ğŸ“± ç”¨æˆ·ä½“éªŒ
- **æ‰«ç æ•ˆæœ**ï¼šè®¿å®¢æ‰«ç  â†’ ç›´æ¥è·³è½¬å°ç¨‹åº â†’ è‡ªåŠ¨å¡«å…¥ä¿¡æ¯
- **å…¼å®¹æ€§**ï¼šæ”¯æŒå¾®ä¿¡6.5.6åŠä»¥ä¸Šç‰ˆæœ¬
- **å‚æ•°ä¼ é€’**ï¼šäºŒç»´ç å†…å®¹é€šè¿‡ `q` å‚æ•°ä¼ é€’ç»™å°ç¨‹åº

## å®ç°æ–¹æ¡ˆ

### é˜¶æ®µ1ï¼šå°ç¨‹åºåå°é…ç½®

#### 1.1 å¼€å¯åŠŸèƒ½
ç™»å½•å°ç¨‹åºåå° â†’ å¼€å‘ç®¡ç† â†’ å¼€å‘è®¾ç½® â†’ "æ‰«æ™®é€šé“¾æ¥äºŒç»´ç æ‰“å¼€å°ç¨‹åº"

#### 1.2 é…ç½®äºŒç»´ç è§„åˆ™
å»ºè®®é…ç½®è§„åˆ™ï¼š
```
https://your-domain.com/visitor-invite/
```

#### 1.3 è®¾ç½®è·³è½¬é¡µé¢
é…ç½®è·³è½¬åˆ°ï¼š`pages/auth/visitor-apply`

#### 1.4 æ ¡éªŒæ–‡ä»¶
- ä¸‹è½½æ ¡éªŒæ–‡ä»¶
- ä¸Šä¼ åˆ°æœåŠ¡å™¨æŒ‡å®šä½ç½®
- é€šè¿‡æ‰€å±æƒæ ¡éªŒ

### é˜¶æ®µ2ï¼šåç«¯å®ç°

#### 2.1 ä¿®æ”¹ButlerController
```java
@ApiOperation("ç”Ÿæˆè®¿å®¢é‚€è¯·é“¾æ¥äºŒç»´ç ")
@GetMapping("/generateVisitorInviteQrCode")
public ResponseEntity<Result> generateVisitorInviteQrCode(@RequestParam String phone,
                                                         @RequestParam(required = false) String community,
                                                         @RequestParam(required = false) String building,
                                                         @RequestParam(required = false) String units,
                                                         @RequestParam(required = false) String floor,
                                                         @RequestParam(required = false) String room) {
    
    // é€šè¿‡æ‰‹æœºå·æŸ¥è¯¢ç®¡å®¶ä¿¡æ¯
    Butler butler = butlerService.getButlerByPhone(phone);
    
    if (butler == null) {
        Result result = new Result();
        result.setCode("1");
        result.setMsg("æœªæ‰¾åˆ°å¯¹åº”çš„ç®¡å®¶ä¿¡æ¯");
        return ResponseEntity.ok(result);
    }
    
    // æ„å»ºè®¿å®¢é‚€è¯·é“¾æ¥
    String inviteLink = buildVisitorInviteLink(butler, community, building, units, floor, room);
    
    // ç”Ÿæˆæ™®é€šäºŒç»´ç ï¼ˆåŒ…å«é‚€è¯·é“¾æ¥ï¼‰
    String qrCodeImage = generateQrCodeImage(inviteLink);
    
    // æ„å»ºè¿”å›æ•°æ®
    Map<String, Object> result = new HashMap<>();
    result.put("type", "visitor_invite_link");
    result.put("inviteLink", inviteLink);
    result.put("qrCodeImage", qrCodeImage);
    result.put("officialCode", true);  // æ ‡è®°ä¸ºå¯ç›´æ¥è·³è½¬çš„äºŒç»´ç 
    result.put("butlerName", butler.getUsername());
    result.put("butlerPhone", butler.getPhone());
    result.put("timestamp", System.currentTimeMillis());
    
    Result response = new Result();
    response.setCode("0");
    response.setMsg("è®¿å®¢é‚€è¯·äºŒç»´ç ç”ŸæˆæˆåŠŸ");
    response.setData(result);
    return ResponseEntity.ok(response);
}

private String buildVisitorInviteLink(Butler butler, String community, 
                                     String building, String units, String floor, String room) {
    
    StringBuilder link = new StringBuilder("https://your-domain.com/visitor-invite/");
    
    // æ·»åŠ ç®¡å®¶ä¿¡æ¯å‚æ•°
    link.append("?butler_phone=").append(butler.getPhone());
    link.append("&butler_name=").append(URLEncoder.encode(butler.getUsername(), "UTF-8"));
    
    // æ·»åŠ åœ°å€ä¿¡æ¯å‚æ•°
    if (community != null) link.append("&community=").append(URLEncoder.encode(community, "UTF-8"));
    if (building != null) link.append("&building=").append(building);
    if (units != null) link.append("&units=").append(units);
    if (floor != null) link.append("&floor=").append(floor);
    if (room != null) link.append("&room=").append(room);
    
    // æ·»åŠ æ—¶é—´æˆ³
    link.append("&timestamp=").append(System.currentTimeMillis());
    
    return link.toString();
}
```

### é˜¶æ®µ3ï¼šå°ç¨‹åºå‰ç«¯æ¥æ”¶å‚æ•°

#### 3.1 ä¿®æ”¹visitor-applyé¡µé¢
```javascript
// pages/auth/visitor-apply.vue
export default {
    data() {
        return {
            butlerInfo: {},
            addressInfo: {},
            fromQrCode: false
        }
    },
    
    onLoad(query) {
        // æ£€æŸ¥æ˜¯å¦æ¥è‡ªäºŒç»´ç æ‰«æ
        if (query.q) {
            this.handleQrCodeScan(query);
        } else {
            // å¤„ç†æ™®é€šé¡µé¢å‚æ•°
            this.handleDirectAccess(query);
        }
    },
    
    methods: {
        // å¤„ç†äºŒç»´ç æ‰«æ
        handleQrCodeScan(query) {
            try {
                // è·å–äºŒç»´ç åŸå§‹é“¾æ¥å†…å®¹
                const qrUrl = decodeURIComponent(query.q);
                const scanTime = parseInt(query.scancode_time);
                
                console.log('ğŸ” æ‰«ç è®¿é—®ï¼ŒåŸå§‹é“¾æ¥:', qrUrl);
                console.log('ğŸ“… æ‰«ç æ—¶é—´:', new Date(scanTime * 1000));
                
                // è§£æURLå‚æ•°
                const urlObj = new URL(qrUrl);
                const params = new URLSearchParams(urlObj.search);
                
                // æå–ç®¡å®¶ä¿¡æ¯
                this.butlerInfo = {
                    phone: params.get('butler_phone'),
                    name: params.get('butler_name')
                };
                
                // æå–åœ°å€ä¿¡æ¯
                this.addressInfo = {
                    community: params.get('community'),
                    building: params.get('building'),
                    units: params.get('units'),
                    floor: params.get('floor'),
                    room: params.get('room')
                };
                
                this.fromQrCode = true;
                
                // è‡ªåŠ¨å¡«å…¥è¡¨å•
                this.autoFillForm();
                
                // æ˜¾ç¤ºæ‰«ç æˆåŠŸæç¤º
                uni.showToast({
                    title: 'âœ… æ‰«ç æˆåŠŸï¼Œä¿¡æ¯å·²è‡ªåŠ¨å¡«å…¥',
                    icon: 'success',
                    duration: 2000
                });
                
            } catch (error) {
                console.error('è§£æäºŒç»´ç å‚æ•°å¤±è´¥:', error);
                uni.showToast({
                    title: 'äºŒç»´ç å‚æ•°è§£æå¤±è´¥',
                    icon: 'none'
                });
            }
        },
        
        // è‡ªåŠ¨å¡«å…¥è¡¨å•
        autoFillForm() {
            // å¡«å…¥ç®¡å®¶è”ç³»æ–¹å¼
            this.form.contactName = this.butlerInfo.name;
            this.form.contactPhone = this.butlerInfo.phone;
            
            // å¡«å…¥è®¿é—®åœ°å€
            if (this.addressInfo.community) {
                this.form.visitAddress = this.buildFullAddress();
            }
            
            // æ ‡è®°ä¸ºæ‰«ç è®¿é—®
            this.form.source = 'qr_code_scan';
        },
        
        buildFullAddress() {
            let address = '';
            if (this.addressInfo.community) address += this.addressInfo.community;
            if (this.addressInfo.building) address += this.addressInfo.building + 'æ ‹';
            if (this.addressInfo.units) address += this.addressInfo.units + 'å•å…ƒ';
            if (this.addressInfo.floor) address += this.addressInfo.floor + 'å±‚';
            if (this.addressInfo.room) address += this.addressInfo.room + 'å®¤';
            return address;
        }
    }
}
```

## éƒ¨ç½²æ­¥éª¤

### 1. åŸŸåå‡†å¤‡
ç¡®ä¿æ‚¨æœ‰ä¸€ä¸ªé€šè¿‡ICPå¤‡æ¡ˆçš„åŸŸåï¼Œå¦‚ï¼š`https://your-domain.com`

### 2. æœåŠ¡å™¨é…ç½®
åœ¨æ‚¨çš„æœåŠ¡å™¨ä¸Šåˆ›å»ºè®¿å®¢é‚€è¯·é¡µé¢è·¯å¾„ï¼š
```
https://your-domain.com/visitor-invite/
```

### 3. æ ¡éªŒæ–‡ä»¶
æŒ‰ç…§å°ç¨‹åºåå°æç¤ºï¼Œä¸Šä¼ æ ¡éªŒæ–‡ä»¶åˆ°æŒ‡å®šä½ç½®

### 4. æµ‹è¯•éªŒè¯
1. ç”ŸæˆåŒ…å«è®¿å®¢é‚€è¯·é“¾æ¥çš„äºŒç»´ç 
2. ä½¿ç”¨å¾®ä¿¡æ‰«ç æµ‹è¯•
3. éªŒè¯æ˜¯å¦ç›´æ¥è·³è½¬åˆ°å°ç¨‹åºå¹¶è‡ªåŠ¨å¡«å…¥ä¿¡æ¯

## ä¼˜åŒ–å»ºè®®

### ğŸ¯ ç«‹å³å¯ç”¨æ–¹æ¡ˆ
å¦‚æœæš‚æ—¶æ— æ³•å®ŒæˆåŸŸåé…ç½®ï¼Œå¯ä»¥ä½¿ç”¨**æ··åˆé™çº§æ–¹æ¡ˆ**ï¼š

1. **ä¼˜å…ˆ**ï¼šå°è¯•ç”Ÿæˆå®˜æ–¹å°ç¨‹åºç ï¼ˆä½¿ç”¨ä¿®å¤åçš„é¡µé¢è·¯å¾„ï¼‰
2. **é™çº§**ï¼šç”Ÿæˆæ™®é€šäºŒç»´ç  + å¤åˆ¶åŠŸèƒ½
3. **é•¿æœŸ**ï¼šé…ç½®æ™®é€šé“¾æ¥äºŒç»´ç è·³è½¬è§„åˆ™

### ğŸ“ˆ é•¿æœŸä¼˜åŒ–
1. å®ŒæˆåŸŸåICPå¤‡æ¡ˆå’ŒæœåŠ¡å™¨é…ç½®
2. åœ¨å°ç¨‹åºåå°é…ç½®è·³è½¬è§„åˆ™
3. å®ç°å®Œæ•´çš„æ™®é€šé“¾æ¥äºŒç»´ç æ–¹æ¡ˆ
4. æä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ

---

**è¿™ä¸ªæ–¹æ¡ˆå®Œç¾è§£å†³äº†é¡µé¢è·¯å¾„é™åˆ¶é—®é¢˜ï¼Œæ˜¯æ›´ç¨³å®šå’Œçµæ´»çš„è§£å†³æ–¹æ¡ˆï¼** ğŸ‰ 