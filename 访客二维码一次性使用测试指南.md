# 访客二维码一次性使用测试指南

## 测试环境准备

### 1. 确保后端服务运行
```bash
# 启动后端服务
cd src/main/java
mvn spring-boot:run
# 或者
java -jar target/parking-demo.jar
```

### 2. 确保前端配置正确
检查 `config/api.js` 中的接口配置：
```javascript
qrcode: {
  validateOnly: '/parking/qrcode/validateOnly', // 新增接口
  validate: '/parking/qrcode/validate',
  checkUsed: '/parking/qrcode/checkUsed',
  // ...
}
```

## 测试场景

### 场景1：正常访客预约流程

**步骤**：
1. 管家生成访客二维码
2. 访客扫描二维码
3. 系统验证二维码有效性（不标记为已使用）
4. 访客进入预约表单
5. 填写预约信息并提交
6. 预约成功后，系统标记二维码为已使用

**预期结果**：
- 扫描时能正常进入表单
- 预约提交成功
- 二维码被标记为已使用

### 场景2：重复扫描已使用二维码

**步骤**：
1. 使用已完成预约的二维码
2. 再次扫描该二维码

**预期结果**：
- 显示锁定界面
- 提示"二维码已使用，请联系管家重新生成"
- 无法进入预约表单

### 场景3：访客直接访问表单

**步骤**：
1. 访客用户直接访问预约表单URL
2. 不通过二维码扫描

**预期结果**：
- 显示访问被拒绝界面
- 提示"访客用户必须通过扫描专用二维码才能访问"

### 场景4：管家用户访问

**步骤**：
1. 管家用户直接访问预约表单
2. 不需要二维码

**预期结果**：
- 正常进入表单
- 不受访问控制限制

### 场景5：网络异常情况

**步骤**：
1. 断开网络连接
2. 扫描已使用的二维码

**预期结果**：
- 本地存储检查生效
- 仍然显示锁定界面

## 测试数据准备

### 1. 创建测试二维码
```sql
INSERT INTO qr_code_usage (
    qr_id, butler_phone, butler_name, community, building,
    created_time, is_used, qr_type, expire_time
) VALUES (
    'TEST_QR_001', '13800138000', '测试管家', '测试小区', '1号楼',
    NOW(), 0, 'visitor_invitation', DATE_ADD(NOW(), INTERVAL 24 HOUR)
);
```

### 2. 创建已使用的测试二维码
```sql
INSERT INTO qr_code_usage (
    qr_id, butler_phone, butler_name, community, building,
    created_time, is_used, used_time, visitor_openid, qr_type, expire_time
) VALUES (
    'TEST_QR_002', '13800138000', '测试管家', '测试小区', '1号楼',
    NOW(), 1, NOW(), 'test_openid_123', 'visitor_invitation', DATE_ADD(NOW(), INTERVAL 24 HOUR)
);
```

## 测试URL格式

### 访客二维码扫描URL
```
/pagesA/reservation/form?qrId=TEST_QR_001
```

### 直接访问表单URL（应被拒绝）
```
/pagesA/reservation/form
```

## 验证要点

### 1. 日志检查
观察控制台日志，确认：
- `🔍 开始验证访客二维码（不标记为已使用）`
- `✅ 访客二维码验证成功（未标记为已使用）`
- `🔒 预约完成，开始标记二维码为已使用`
- `✅ 二维码已成功标记为已使用（后端+本地）`

### 2. 数据库状态检查
```sql
-- 检查二维码使用状态
SELECT qr_id, is_used, used_time, visitor_openid 
FROM qr_code_usage 
WHERE qr_id = 'TEST_QR_001';
```

### 3. 本地存储检查
在浏览器开发者工具中检查：
```javascript
// 检查本地存储
uni.getStorageSync('qr_used_TEST_QR_001')
uni.getStorageSync('qr_used_time_TEST_QR_001')
```

## 常见问题排查

### 1. 二维码验证失败
- 检查qr_code_usage表中是否存在对应记录
- 确认二维码是否已过期
- 检查网络连接

### 2. 访问控制不生效
- 确认用户角色判断逻辑
- 检查URL参数传递
- 验证前端路由配置

### 3. 标记为已使用失败
- 检查后端validate接口是否正常
- 确认用户openid是否正确
- 查看后端日志错误信息

## 性能测试

### 1. 并发扫描测试
- 多个用户同时扫描同一个二维码
- 验证只有一个能成功使用

### 2. 大量二维码测试
- 生成大量测试二维码
- 验证查询性能

## 安全测试

### 1. 参数篡改测试
- 尝试修改URL中的qrId参数
- 验证系统是否正确拒绝无效二维码

### 2. 重放攻击测试
- 尝试重复使用已过期的二维码
- 验证时间戳和有效期检查
