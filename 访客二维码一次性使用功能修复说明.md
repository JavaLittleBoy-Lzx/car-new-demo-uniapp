# è®¿å®¢äºŒç»´ç ä¸€æ¬¡æ€§ä½¿ç”¨åŠŸèƒ½ä¿®å¤è¯´æ˜

## é—®é¢˜æè¿°

ç”¨æˆ·æŠ¥å‘Šäº†ä¸¤ä¸ªä¸»è¦é—®é¢˜ï¼š
1. **åç«¯æ¥å£404é”™è¯¯**ï¼š`GET /parking/qrcode/checkUsed` æ¥å£ä¸å­˜åœ¨
2. **phone-auth.vueç¼ºå°‘äºŒç»´ç æ£€æŸ¥**ï¼šåœ¨è·å–URLå‚æ•°æ—¶éœ€è¦å…ˆæ£€æŸ¥äºŒç»´ç æ˜¯å¦å·²è¢«ä½¿ç”¨

## è§£å†³æ–¹æ¡ˆ

### 1. åç«¯æ¥å£ä¿®å¤

#### æ·»åŠ ç¼ºå¤±çš„checkUsedæ¥å£

**æ–‡ä»¶**ï¼š`src/main/java/com/parkingmanage/controller/QrCodeController.java`

**ä¿®æ”¹å†…å®¹**ï¼š
- æ·»åŠ äº†`import com.baomidou.mybatisplus.extension.api.R;`å¯¼å…¥
- åˆ›å»ºäº†ç±»å‹åˆ«å`private static class r extends Result<Object> {}`æ¥è§£å†³ç±»å‹å…¼å®¹é—®é¢˜
- æ·»åŠ äº†`checkQrCodeUsed`æ–¹æ³•ï¼š

```java
@ApiOperation("æ£€æŸ¥äºŒç»´ç ä½¿ç”¨çŠ¶æ€")
@GetMapping("/checkUsed")
public ResponseEntity<r> checkQrCodeUsed(
        @ApiParam(value = "äºŒç»´ç ID", required = true) @RequestParam String qrId,
        @ApiParam(value = "è®¿å®¢openid", required = true) @RequestParam String openid) {
    
    r result = new r();
    
    try {
        logger.info("ğŸ” æ£€æŸ¥äºŒç»´ç ä½¿ç”¨çŠ¶æ€: qrId={}, openid={}", qrId, openid);
        
        // éªŒè¯å‚æ•°
        if (qrId == null || qrId.trim().isEmpty()) {
            result.setCode("1");
            result.setMsg("äºŒç»´ç IDä¸èƒ½ä¸ºç©º");
            return ResponseEntity.ok(result);
        }
        
        if (openid == null || openid.trim().isEmpty()) {
            result.setCode("1");
            result.setMsg("ç”¨æˆ·openidä¸èƒ½ä¸ºç©º");
            return ResponseEntity.ok(result);
        }
        
        // æŸ¥è¯¢äºŒç»´ç è®°å½•
        QrCodeUsage qrUsage = qrCodeUsageService.findByQrId(qrId);
        
        Map<String, Object> data = new HashMap<>();
        if (qrUsage != null && qrUsage.getIsUsed() != null && qrUsage.getIsUsed() == 1) {
            data.put("used", true);
            data.put("usedTime", qrUsage.getUsedTime());
            data.put("usedBy", qrUsage.getVisitorOpenid());
            logger.info("âœ… äºŒç»´ç å·²ä½¿ç”¨: qrId={}, usedTime={}", qrId, qrUsage.getUsedTime());
        } else {
            data.put("used", false);
            logger.info("âœ… äºŒç»´ç æœªä½¿ç”¨: qrId={}", qrId);
        }
        
        result.setCode("0");
        result.setMsg("æŸ¥è¯¢æˆåŠŸ");
        result.setData(data);
        
    } catch (Exception e) {
        logger.error("âŒ æ£€æŸ¥äºŒç»´ç ä½¿ç”¨çŠ¶æ€æ—¶å‘ç”Ÿå¼‚å¸¸: qrId={}", qrId, e);
        result.setCode("1");
        result.setMsg("æŸ¥è¯¢å¤±è´¥: " + e.getMessage());
    }
    
    return ResponseEntity.ok(result);
}
```

#### ä¿®å¤å…¶ä»–æ–¹æ³•çš„è¿”å›ç±»å‹

- å°†æ‰€æœ‰æ–¹æ³•ä¸­çš„`Result result = new Result();`æ”¹ä¸º`r result = new r();`
- ç¡®ä¿ç±»å‹ä¸€è‡´æ€§ï¼Œé¿å…æ³›å‹è­¦å‘Š

### 2. å‰ç«¯phone-auth.vueä¿®å¤

#### æ·»åŠ äºŒç»´ç ä½¿ç”¨æ£€æŸ¥é€»è¾‘

**æ–‡ä»¶**ï¼š`pages/auth/phone-auth.vue`

**ä¿®æ”¹å†…å®¹**ï¼š

1. **æ·»åŠ importè¯­å¥**ï¼š
```javascript
import request from '@/utils/request.js'
```

2. **åœ¨onLoadæ–¹æ³•ä¸­æ·»åŠ æ£€æŸ¥**ï¼š
```javascript
// ğŸ”’ æ£€æŸ¥è®¿å®¢äºŒç»´ç æ˜¯å¦å·²è¢«ä½¿ç”¨
if (this.scannedParams.qrId) {
    this.checkVisitorQrCodeUsage(this.scannedParams.qrId);
}
```

3. **æ·»åŠ æ£€æŸ¥æ–¹æ³•**ï¼š
```javascript
// ğŸ”’ æ£€æŸ¥è®¿å®¢äºŒç»´ç ä½¿ç”¨çŠ¶æ€
async checkVisitorQrCodeUsage(qrId) {
    try {
        console.log('ğŸ” æ£€æŸ¥è®¿å®¢äºŒç»´ç ä½¿ç”¨çŠ¶æ€:', qrId);

        // è·å–ç”¨æˆ·ä¿¡æ¯
        const userInfo = uni.getStorageSync('userInfo');
        const openid = userInfo?.userInfo?.openid || userInfo?.openid || 'visitor_temp';

        // è°ƒç”¨åç«¯æ¥å£æ£€æŸ¥äºŒç»´ç ä½¿ç”¨çŠ¶æ€
        const response = await request({
            url: '/parking/qrcode/checkUsed',
            method: 'GET',
            data: {
                qrId: qrId,
                openid: openid
            }
        });

        console.log('ğŸ” äºŒç»´ç ä½¿ç”¨çŠ¶æ€æ£€æŸ¥å“åº”:', response);

        if (response.code === '0' && response.data) {
            if (response.data.used) {
                // äºŒç»´ç å·²è¢«ä½¿ç”¨ï¼Œæ˜¾ç¤ºé”å®šç•Œé¢
                console.warn('ğŸ”’ è®¿å®¢äºŒç»´ç å·²è¢«ä½¿ç”¨ï¼Œæ‹’ç»è®¿é—®');
                this.showQrCodeUsedError(qrId, response.data);
                return false;
            } else {
                // äºŒç»´ç æœªä½¿ç”¨ï¼Œå…è®¸ç»§ç»­
                console.log('âœ… è®¿å®¢äºŒç»´ç æœªä½¿ç”¨ï¼Œå…è®¸ç»§ç»­');
                return true;
            }
        } else {
            console.warn('âŒ æ£€æŸ¥äºŒç»´ç ä½¿ç”¨çŠ¶æ€å¤±è´¥:', response.msg);
            // æ£€æŸ¥å¤±è´¥æ—¶ï¼Œä¸ºäº†å®‰å…¨èµ·è§ï¼Œä¹Ÿæ˜¾ç¤ºé”™è¯¯
            this.showQrCodeCheckError(response.msg || 'æ£€æŸ¥äºŒç»´ç çŠ¶æ€å¤±è´¥');
            return false;
        }

    } catch (error) {
        console.error('âŒ æ£€æŸ¥è®¿å®¢äºŒç»´ç ä½¿ç”¨çŠ¶æ€æ—¶å‘ç”Ÿå¼‚å¸¸:', error);
        // ç½‘ç»œé”™è¯¯æ—¶ï¼Œä¸ºäº†å®‰å…¨èµ·è§ï¼Œä¹Ÿæ˜¾ç¤ºé”™è¯¯
        this.showQrCodeCheckError('ç½‘ç»œå¼‚å¸¸ï¼Œæ— æ³•éªŒè¯äºŒç»´ç çŠ¶æ€');
        return false;
    }
}
```

4. **æ·»åŠ é”™è¯¯å¤„ç†æ–¹æ³•**ï¼š
```javascript
// ğŸ”’ æ˜¾ç¤ºäºŒç»´ç å·²ä½¿ç”¨é”™è¯¯
showQrCodeUsedError(qrId, usageData) {
    const usedTime = usageData.usedTime ? new Date(usageData.usedTime).toLocaleString() : 'æœªçŸ¥æ—¶é—´';
    
    uni.showModal({
        title: 'äºŒç»´ç å·²ä½¿ç”¨',
        content: `æ­¤è®¿å®¢äºŒç»´ç å·²è¢«ä½¿ç”¨ï¼Œæ— æ³•é‡å¤ä½¿ç”¨ã€‚\n\nä½¿ç”¨æ—¶é—´ï¼š${usedTime}\näºŒç»´ç IDï¼š${qrId}\n\næ¯ä¸ªè®¿å®¢äºŒç»´ç åªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼Œè¯·è”ç³»ç®¡å®¶é‡æ–°ç”ŸæˆäºŒç»´ç ã€‚`,
        showCancel: false,
        confirmText: 'çŸ¥é“äº†',
        success: () => {
            // è·³è½¬å›é¦–é¡µæˆ–å…³é—­é¡µé¢
            uni.navigateBack({
                fail: () => {
                    uni.reLaunch({
                        url: '/pages/index/index'
                    });
                }
            });
        }
    });
}

// ğŸ”’ æ˜¾ç¤ºäºŒç»´ç æ£€æŸ¥é”™è¯¯
showQrCodeCheckError(message) {
    uni.showModal({
        title: 'äºŒç»´ç éªŒè¯å¤±è´¥',
        content: `æ— æ³•éªŒè¯äºŒç»´ç çŠ¶æ€ï¼š${message}\n\nä¸ºäº†å®‰å…¨èµ·è§ï¼Œè¯·é‡æ–°æ‰«æäºŒç»´ç æˆ–è”ç³»ç®¡å®¶ã€‚`,
        showCancel: false,
        confirmText: 'çŸ¥é“äº†',
        success: () => {
            // è·³è½¬å›é¦–é¡µæˆ–å…³é—­é¡µé¢
            uni.navigateBack({
                fail: () => {
                    uni.reLaunch({
                        url: '/pages/index/index'
                    });
                }
            });
        }
    });
}
```

## å·¥ä½œæµç¨‹

### 1. è®¿å®¢æ‰«æäºŒç»´ç è¿›å…¥phone-auth.vue
1. é¡µé¢åŠ è½½æ—¶è§£æURLå‚æ•°ï¼Œæå–qrId
2. å¦‚æœå­˜åœ¨qrIdï¼Œç«‹å³è°ƒç”¨`checkVisitorQrCodeUsage`æ–¹æ³•
3. åç«¯æŸ¥è¯¢qr_code_usageè¡¨æ£€æŸ¥is_usedå­—æ®µ
4. å¦‚æœå·²ä½¿ç”¨ï¼Œæ˜¾ç¤ºé”™è¯¯æç¤ºå¹¶é˜»æ­¢ç»§ç»­
5. å¦‚æœæœªä½¿ç”¨ï¼Œå…è®¸ç»§ç»­æˆæƒæµç¨‹

### 2. åç»­é¢„çº¦æµç¨‹
1. ç”¨æˆ·å®Œæˆæ‰‹æœºæˆæƒåè·³è½¬åˆ°form.vue
2. form.vueä¸­çš„è®¿é—®æ§åˆ¶é€»è¾‘ä¼šå†æ¬¡éªŒè¯äºŒç»´ç 
3. é¢„çº¦æäº¤æˆåŠŸåï¼Œæ ‡è®°äºŒç»´ç ä¸ºå·²ä½¿ç”¨

## å®‰å…¨ç‰¹æ€§

1. **åŒé‡æ£€æŸ¥**ï¼šphone-auth.vueå’Œform.vueéƒ½ä¼šæ£€æŸ¥äºŒç»´ç çŠ¶æ€
2. **æ—©æœŸæ‹¦æˆª**ï¼šåœ¨æˆæƒé˜¶æ®µå°±æ‹¦æˆªå·²ä½¿ç”¨çš„äºŒç»´ç 
3. **ç”¨æˆ·å‹å¥½**ï¼šæä¾›æ¸…æ™°çš„é”™è¯¯æç¤ºå’Œä½¿ç”¨æ—¶é—´ä¿¡æ¯
4. **å®¹é”™å¤„ç†**ï¼šç½‘ç»œå¼‚å¸¸æ—¶ä¹Ÿä¼šé˜»æ­¢è®¿é—®ï¼Œç¡®ä¿å®‰å…¨

## æµ‹è¯•å»ºè®®

1. **æ­£å¸¸æµç¨‹**ï¼šæ‰«ææ–°äºŒç»´ç  â†’ é€šè¿‡phone-auth.vue â†’ è¿›å…¥form.vue â†’ å®Œæˆé¢„çº¦
2. **é‡å¤ä½¿ç”¨**ï¼šæ‰«æå·²ä½¿ç”¨çš„äºŒç»´ç  â†’ åœ¨phone-auth.vueè¢«æ‹¦æˆª
3. **ç½‘ç»œå¼‚å¸¸**ï¼šæ–­ç½‘æƒ…å†µä¸‹æ‰«æäºŒç»´ç  â†’ æ˜¾ç¤ºç½‘ç»œé”™è¯¯æç¤º
4. **å‚æ•°å¼‚å¸¸**ï¼šä½¿ç”¨æ— æ•ˆçš„qrId â†’ æ˜¾ç¤ºéªŒè¯å¤±è´¥æç¤º

## æ³¨æ„äº‹é¡¹

1. ç¡®ä¿åç«¯æœåŠ¡æ­£å¸¸è¿è¡Œ
2. ç¡®ä¿qr_code_usageè¡¨ç»“æ„æ­£ç¡®
3. æµ‹è¯•æ—¶æ³¨æ„æ¸…ç†å·²ä½¿ç”¨çš„æµ‹è¯•æ•°æ®
4. è§‚å¯Ÿæ§åˆ¶å°æ—¥å¿—ç¡®è®¤åŠŸèƒ½æ­£å¸¸å·¥ä½œ
