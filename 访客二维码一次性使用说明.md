# 访客二维码一次性使用说明

## 功能概述

**只有访客邀约二维码需要限制使用次数**：每个二维码只能使用一次，用过后永久不能再用（除非换新二维码）。

**管家代人预约和业主预约不受任何限制**：可以随时随地预约，不限次数。

**修复文件**：
- `components/custom-tabbar.vue`
- `pagesA/reservation/form.vue`

---

## 正确理解

### ✅ 访客邀约二维码

**限制规则**：
- 每个二维码只能使用一次
- 用过后**永久不能再用**
- 除非管家重新生成新的二维码

**实现方式**：
- 本地存储：`qr_used_{qrId}`
- 后端记录：二维码使用状态
- 双重验证确保安全

### ✅ 管家代人预约

**限制规则**：
- **无限制**
- 随时可以预约
- 不限次数

### ✅ 业主预约

**限制规则**：
- **无限制**
- 随时可以预约
- 不限次数

---

## 之前的错误理解 ❌

### 错误1：30分钟限制

**错误理解**：
- 所有用户预约后30分钟内不能再次预约

**问题**：
- 管家和业主也被限制了
- 影响正常使用
- 不符合业务需求

### 错误2：弹窗提醒

**错误理解**：
- 在查询页面显示"30分钟内不建议重复提交"

**问题**：
- 对管家和业主来说是多余的
- 干扰正常操作
- 降低用户体验

---

## 正确实现

### 1. custom-tabbar.vue

**只检查访客二维码使用状态**：

```javascript
async switchTab(item, index) {
    const currentRole = this.getCurrentRole();

    // 🔒 只对访客角色进行特殊检查
    if (currentRole === 'visitor') {
        // 检查访客点击预约页面的情况
        if (item.pagePath === 'pages/reservation/form') {
            // 检查二维码是否已被使用
            const hasUsedQrCode = await this.checkVisitorQrCodeUsage();
            if (hasUsedQrCode) {
                // 显示"二维码已使用"提示
                uni.showModal({
                    title: '无法进入预约',
                    content: '您的访客二维码已经使用过了，每个二维码只能使用一次。\n\n您可以：\n• 查询已有的预约记录\n• 联系管家重新生成二维码',
                    // ...
                });
                return; // 阻止访客进入
            }
        }
    }

    // ✅ 管家和业主直接跳转，无限制
    this.navigateToTab(item, index);
}
```

**关键点**：
- ✅ 只检查访客角色
- ✅ 只检查二维码使用状态
- ✅ 管家和业主不检查，直接跳转

### 2. form.vue

**只检查访客二维码使用状态**：

```javascript
async checkGuestReservationStatus() {
    try {
        console.log('🔍 [预约状态检查] 开始检查预约状态，用户角色:', this.currentUserRole);

        // 🔧 只对访客角色检查二维码状态（一次性使用）
        if (this.currentUserRole === 'visitor' && this.scannedQrId) {
            // 检查二维码是否已被使用
            const qrUsed = uni.getStorageSync(`qr_used_${this.scannedQrId}`);
            
            if (qrUsed) {
                // 显示二维码已使用的锁定界面
                this.showQrCodeUsedLock();
                return;
            }

            // 检查是否有待处理的预约记录
            await this.checkPendingReservations();
        }

        // ✅ 管家和业主不检查，直接允许使用

    } catch (error) {
        console.error('❌ [预约状态检查] 检查预约状态失败:', error);
    }
}
```

**关键点**：
- ✅ 只检查访客角色
- ✅ 只检查二维码状态
- ✅ 管家和业主直接通过

---

## 功能对比

| 角色 | 预约限制 | 二维码限制 | 时间限制 |
|------|---------|-----------|---------|
| 访客 | ✅ 二维码一次性使用 | ✅ 用过永久不能再用 | ❌ 无 |
| 管家 | ❌ 无限制 | ❌ 不使用二维码 | ❌ 无 |
| 业主 | ❌ 无限制 | ❌ 不使用二维码 | ❌ 无 |

---

## 访客二维码使用流程

### 1. 首次使用

```
访客扫描管家生成的二维码
        ↓
进入预约表单页面
        ↓
填写预约信息
        ↓
提交预约成功
        ↓
标记二维码为"已使用"
  • 本地存储：qr_used_{qrId} = true
  • 后端记录：二维码状态更新
```

### 2. 再次尝试使用

```
访客再次扫描相同二维码
        ↓
custom-tabbar检查：二维码已使用
        ↓
显示弹窗："二维码已使用"
        ↓
阻止进入预约页面
        ↓
引导联系管家重新生成
```

---

## 管家和业主使用流程

### 管家代人预约

```
管家点击"预约表单"
        ↓
✅ 直接进入预约表单
        ↓
填写预约信息
        ↓
提交预约成功
        ↓
可以立即再次预约（无限制）
```

### 业主预约

```
业主点击"预约表单"
        ↓
✅ 直接进入预约表单
        ↓
填写预约信息
        ↓
提交预约成功
        ↓
可以立即再次预约（无限制）
```

---

## 技术实现

### 1. 二维码使用标记

**本地存储**：
```javascript
uni.setStorageSync(`qr_used_${qrId}`, true);
uni.setStorageSync(`qr_used_time_${qrId}`, Date.now());
```

**后端记录**：
```javascript
// 调用后端API标记二维码已使用
await markQrCodeAsUsed(qrId, openid);
```

### 2. 角色判断

```javascript
const currentRole = this.getCurrentRole();

// 只对访客进行检查
if (currentRole === 'visitor') {
    // 检查二维码
}

// 管家和业主不检查
// 直接允许操作
```

### 3. 双重验证

**custom-tabbar.vue**（入口拦截）：
- 点击"预约表单"按钮时检查
- 阻止访客进入已使用的二维码页面

**form.vue**（页面级拦截）：
- 页面加载时检查
- 防止通过其他方式进入

---

## 已移除的功能

### ❌ 30分钟限制

**已移除**：
- 不再限制所有用户30分钟内的预约
- 不再显示"您在X分钟前已提交预约"弹窗
- 不再检查`lastAppointmentData.submitTime`

### ❌ showReservationCompletedLock

**已移除**：
- 不再使用此方法
- 不再显示"预约已完成"锁定界面

### ❌ checkActiveReservations

**已移除**：
- 不再检查活跃预约记录
- 不再显示"您有待处理的预约记录"弹窗

---

## 测试建议

### 测试场景1：访客首次使用二维码

**步骤**：
1. 访客扫描管家生成的二维码
2. 填写预约信息并提交
3. 预约成功

**预期结果**：
- ✅ 成功提交预约
- ✅ 二维码被标记为已使用

### 测试场景2：访客再次使用相同二维码

**步骤**：
1. 访客再次扫描已使用的二维码
2. 尝试进入预约表单

**预期结果**：
- ✅ 显示"二维码已使用"弹窗
- ✅ 无法进入预约表单
- ✅ 引导联系管家重新生成

### 测试场景3：管家连续预约

**步骤**：
1. 管家提交一次代人预约
2. 立即再次点击"预约表单"
3. 再次提交预约

**预期结果**：
- ✅ 可以立即再次预约
- ✅ 没有任何限制
- ✅ 没有任何弹窗提示

### 测试场景4：业主连续预约

**步骤**：
1. 业主提交一次预约
2. 立即再次点击"预约表单"
3. 再次提交预约

**预期结果**：
- ✅ 可以立即再次预约
- ✅ 没有任何限制
- ✅ 没有任何弹窗提示

---

## 安全机制

### 1. 本地存储标记

**优点**：
- 响应快速
- 离线可用
- 减少网络请求

**缺点**：
- 可以被清除
- 需要后端配合验证

### 2. 后端记录

**优点**：
- 数据可靠
- 永久保存
- 无法篡改

**缺点**：
- 需要网络请求
- 响应较慢

### 3. 双重验证

**结合两者优势**：
- ✅ 本地快速检查
- ✅ 后端可靠验证
- ✅ 确保安全性

---

## 注意事项

### 1. 只有访客受限制

- ✅ 访客：二维码一次性使用
- ✅ 管家：完全无限制
- ✅ 业主：完全无限制

### 2. 二维码永久失效

- ✅ 用过的二维码永久不能再用
- ✅ 不是30分钟，是永久
- ✅ 需要管家重新生成新二维码

### 3. 不影响查询功能

- ✅ 访客可以查询已有预约
- ✅ 管家可以查询所有预约
- ✅ 业主可以查询自己的预约

---

## 修复清单

| 项目 | 修改内容 | 文件 | 状态 |
|------|---------|------|------|
| 1 | 移除30分钟限制检查 | custom-tabbar.vue | ✅ 已移除 |
| 2 | 移除30分钟限制检查 | form.vue | ✅ 已移除 |
| 3 | 移除checkActiveReservations调用 | form.vue | ✅ 已移除 |
| 4 | 保留访客二维码检查 | custom-tabbar.vue | ✅ 保留 |
| 5 | 保留访客二维码检查 | form.vue | ✅ 保留 |

---

## 修复日期
2025年12月3日

## 修复人员
Cascade AI Assistant
