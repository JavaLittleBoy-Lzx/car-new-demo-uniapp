# 底部导航栏预约提醒优化说明

## 优化概述

点击底部导航栏的"预约表单"按钮时，直接在**当前页面**显示弹窗提醒，不跳转到form.vue页面。

**优化文件**：`components/custom-tabbar.vue`

---

## 问题描述

### 原有流程 ❌

1. 用户在查询页面（searchResult.vue）
2. 点击底部导航栏的"预约表单"按钮
3. **先跳转到form.vue页面**
4. form.vue的`onShow`触发检查
5. 显示弹窗："您有待处理的预约记录..."
6. **用户需要点击"继续预约"才能看到真正的弹窗**
7. 再显示："您在X分钟前已提交预约..."

**问题**：
- 需要经过两层弹窗
- 页面跳转影响用户体验
- 用户想查询记录时还要先看到form.vue页面

### 用户期望 ✅

1. 用户在查询页面
2. 点击底部导航栏的"预约表单"按钮
3. **直接在当前页面显示弹窗**
4. 显示："您在X分钟前已提交预约..."
5. 用户可以选择"查看预约"或"知道了"
6. **不跳转到form.vue页面**

---

## 优化方案

### 核心思路

在 `custom-tabbar.vue` 的 `switchTab` 方法中，**点击按钮时就检查**，而不是等跳转后检查。

### 检查顺序

```
点击"预约表单"按钮
     ↓
[1] 访客角色检查（已有）
     ↓
[2] 二维码使用检查（已有）
     ↓
[3] 🆕 30分钟内提交检查（新增）
     ↓
允许跳转到form.vue
```

---

## 代码修改

### 修改位置

**文件**：`components/custom-tabbar.vue`  
**方法**：`switchTab`  
**行号**：第 409-445 行

### 新增代码

```javascript
// 🔧 检查所有用户点击预约表单的情况（30分钟内提交过预约）
if (item.pagePath === 'pages/reservation/form') {
    console.log('🔍 [TabBar] 用户点击预约表单，检查是否刚刚提交过预约');

    // 检查是否刚刚提交过预约
    const lastAppointmentData = uni.getStorageSync('lastAppointmentData');
    const lastSubmitTime = lastAppointmentData?.submitTime;
    
    if (lastSubmitTime) {
        const timeSinceSubmit = Date.now() - new Date(lastSubmitTime).getTime();
        const thirtyMinutes = 30 * 60 * 1000; // 30分钟
        
        // 如果30分钟内提交过预约，显示弹窗提醒（不跳转）
        if (timeSinceSubmit < thirtyMinutes) {
            const visitDate = lastAppointmentData?.visitDate || '未知时间';
            const minutesAgo = Math.floor(timeSinceSubmit / 1000 / 60);
            
            console.log('🔍 [TabBar] 检测到最近提交的预约，显示弹窗提醒');
            
            // 🔧 直接在当前页面显示弹窗，不跳转
            uni.showModal({
                title: '温馨提示',
                content: `您在 ${minutesAgo} 分钟前已提交预约\n\n预约日期：${visitDate}\n\n30分钟内不建议重复提交预约，如需修改请联系管家。`,
                showCancel: true,
                cancelText: '查看预约',
                confirmText: '知道了',
                success: (res) => {
                    if (!res.confirm) {
                        // 用户点击"查看预约"
                        this.navigateToQueryPage();
                    }
                }
            });
            return; // 🔧 阻止跳转到预约表单页面
        }
    }
}
```

---

## 优化效果

### 修改前 ❌

| 步骤 | 操作 | 页面 |
|------|------|------|
| 1 | 点击"预约表单" | searchResult.vue |
| 2 | 跳转... | → form.vue |
| 3 | 显示弹窗1 | form.vue |
| 4 | 点击"继续预约" | form.vue |
| 5 | 显示弹窗2（目标弹窗） | form.vue |

**问题**：
- ❌ 需要两次弹窗操作
- ❌ 页面跳转影响体验
- ❌ 看到了不需要的页面

### 修改后 ✅

| 步骤 | 操作 | 页面 |
|------|------|------|
| 1 | 点击"预约表单" | searchResult.vue |
| 2 | 显示弹窗（目标弹窗） | **searchResult.vue** |
| 3 | 选择操作 | searchResult.vue |

**效果**：
- ✅ 一次弹窗操作
- ✅ 不跳转页面
- ✅ 直接显示目标弹窗

---

## 弹窗内容

### UI显示

```
┌─────────────────────────────┐
│        温馨提示              │
├─────────────────────────────┤
│  您在 5 分钟前已提交预约     │
│                             │
│  预约日期：2025年12月04日    │
│                             │
│  30分钟内不建议重复提交预约， │
│  如需修改请联系管家。        │
├─────────────────────────────┤
│  [查看预约]     [知道了]     │
└─────────────────────────────┘
```

### 弹窗信息

1. **提交时间**：显示多少分钟前提交的预约
2. **预约日期**：显示预约的访问日期
3. **友好提示**：建议不重复提交，可联系管家修改
4. **操作按钮**：
   - **查看预约**：跳转到查询页面
   - **知道了**：关闭弹窗，留在当前页面

---

## 适用场景

### 场景1：业主预约后查询

**步骤**：
1. 业主提交预约
2. 切换到查询页面查看记录
3. 点击底部"预约表单"想再次预约

**效果**：
- ✅ 直接在查询页面显示弹窗
- ✅ 不跳转到form.vue
- ✅ 可以选择"查看预约"继续查询

### 场景2：访客预约后查询

**步骤**：
1. 访客提交预约
2. 切换到查询页面查看记录
3. 点击底部"预约表单"想再次预约

**效果**：
- ✅ 直接在查询页面显示弹窗
- ✅ 提示30分钟内不建议重复提交
- ✅ 可以继续查询记录

### 场景3：管家代人预约后

**步骤**：
1. 管家代人提交预约
2. 切换到其他页面
3. 点击底部"预约表单"想再次预约

**效果**：
- ✅ 直接在当前页面显示弹窗
- ✅ 提示刚刚提交过预约
- ✅ 避免误操作

---

## 检查逻辑

### 检查条件

1. **时间判断**：30分钟内提交过预约
2. **数据来源**：`lastAppointmentData.submitTime`
3. **检查时机**：点击"预约表单"按钮时
4. **适用角色**：所有角色（业主、访客、管家）

### 逻辑流程

```javascript
// 1. 获取最后提交时间
const lastAppointmentData = uni.getStorageSync('lastAppointmentData');
const lastSubmitTime = lastAppointmentData?.submitTime;

// 2. 计算时间差
const timeSinceSubmit = Date.now() - new Date(lastSubmitTime).getTime();
const thirtyMinutes = 30 * 60 * 1000;

// 3. 判断是否在30分钟内
if (timeSinceSubmit < thirtyMinutes) {
    // 显示弹窗，阻止跳转
    return;
}

// 4. 允许跳转
this.navigateToTab(item, index);
```

---

## 与form.vue的关系

### form.vue中的检查（保留）

**位置**：`pagesA/reservation/form.vue` 的 `checkGuestReservationStatus` 方法

**作用**：
- 用户**已经进入form.vue页面**时的检查
- 比如从其他页面跳转、页面刷新等情况

**是否保留**：✅ 保留

**原因**：
- 用户可能通过其他方式进入form.vue（不是点击底部导航栏）
- 提供双重保护，更加安全
- 不影响其他功能

### custom-tabbar.vue中的检查（新增）

**位置**：`components/custom-tabbar.vue` 的 `switchTab` 方法

**作用**：
- 用户**点击底部导航栏**时的检查
- 在跳转前拦截，避免不必要的跳转

**优势**：
- ✅ 直接在当前页面显示弹窗
- ✅ 不跳转页面，体验更好
- ✅ 一次弹窗，不需要二次操作

---

## 协同工作

```
用户点击底部"预约表单"
        ↓
custom-tabbar检查 ✅ (新增)
        ↓
    30分钟内？
   ↙        ↘
是 ←         否
显示弹窗      跳转form.vue
不跳转            ↓
            form.vue检查 ✅ (保留)
                ↓
            显示弹窗提醒
            允许查询记录
```

---

## 技术细节

### 1. 数据来源

**lastAppointmentData结构**：
```javascript
{
    visitDate: "2025年12月04日",
    plateNumber: "黑AD22222",
    submitTime: "2025-12-04T10:30:00.000Z",
    // ...
}
```

### 2. 时间计算

```javascript
const timeSinceSubmit = Date.now() - new Date(lastSubmitTime).getTime();
const minutesAgo = Math.floor(timeSinceSubmit / 1000 / 60);
```

**说明**：
- `Date.now()`：当前时间戳（毫秒）
- `new Date(lastSubmitTime).getTime()`：提交时间戳（毫秒）
- `timeSinceSubmit`：时间差（毫秒）
- `minutesAgo`：转换为分钟数

### 3. 阻止跳转

```javascript
return; // 🔧 阻止跳转到预约表单页面
```

**说明**：
- 在`switchTab`方法中`return`
- 后续的跳转代码不会执行
- 页面保持在当前位置

---

## 测试建议

### 测试场景1：业主预约后点击

**步骤**：
1. 业主完成预约提交
2. 切换到查询页面
3. 点击底部"预约表单"按钮

**预期结果**：
- ✅ 在查询页面显示弹窗
- ✅ 显示"您在X分钟前已提交预约"
- ✅ 不跳转到form.vue页面
- ✅ 可以点击"查看预约"继续查询

### 测试场景2：30分钟后点击

**步骤**：
1. 业主完成预约提交
2. 等待30分钟以上
3. 点击底部"预约表单"按钮

**预期结果**：
- ✅ 不显示弹窗
- ✅ 直接跳转到form.vue页面
- ✅ 可以正常提交新的预约

### 测试场景3：访客二维码已使用

**步骤**：
1. 访客使用二维码完成预约
2. 再次点击底部"预约表单"按钮

**预期结果**：
- ✅ 在当前页面显示"无法进入预约"弹窗
- ✅ 提示二维码已使用
- ✅ 可以选择"查询记录"

---

## 优化清单

| 项目 | 修改前 | 修改后 |
|------|--------|--------|
| 显示位置 | form.vue页面 | **当前页面** |
| 页面跳转 | 是 | **否** |
| 弹窗次数 | 2次 | **1次** |
| 用户操作 | 需要点击"继续预约" | **直接显示** |
| 是否阻止跳转 | 否 | **是** |

---

## 注意事项

### 1. 双重保护机制

custom-tabbar和form.vue都有检查，提供双重保护：
- ✅ custom-tabbar：拦截底部导航栏点击
- ✅ form.vue：拦截其他方式进入页面

### 2. 不影响其他功能

- ✅ 访客二维码检查：保持不变
- ✅ 预约记录查询：保持不变
- ✅ 其他导航：保持不变

### 3. 时间窗口可调整

如需修改30分钟的限制时间：
```javascript
const thirtyMinutes = 15 * 60 * 1000; // 改为15分钟
```

---

## 相关文档

- [预约表单访问提醒优化说明.md](./预约表单访问提醒优化说明.md)
- [预约表单访问限制和时间传递修复说明.md](./预约表单访问限制和时间传递修复说明.md)

---

## 优化日期
2025年12月3日

## 优化人员
Cascade AI Assistant
