# æ‰«ç è·³è½¬é—®é¢˜è§£å†³æ–¹æ¡ˆ

## ğŸ¯ é—®é¢˜è¯Šæ–­

å½“å‰é¡¹ç›®å­˜åœ¨çš„æ ¸å¿ƒé—®é¢˜ï¼š
1. **ç”Ÿæˆçš„æ˜¯æ™®é€šæ–‡æœ¬äºŒç»´ç ï¼Œä¸æ˜¯å¾®ä¿¡å®˜æ–¹å°ç¨‹åºç **
2. **æ‰«ç åæ˜¾ç¤ºæ–‡æœ¬å†…å®¹ï¼Œæ— æ³•ç›´æ¥è·³è½¬å°ç¨‹åº**
3. **åç«¯APIè¿”å›æ•°æ®æ ¼å¼ä¸ç¬¦åˆå‰ç«¯æœŸæœ›**

## ğŸ”§ è§£å†³æ–¹æ¡ˆï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰

### æ–¹æ¡ˆä¸€ï¼šå®Œå–„å¾®ä¿¡å®˜æ–¹å°ç¨‹åºç APIï¼ˆæ¨èâ­â­â­â­â­ï¼‰

#### 1. åç«¯APIæ”¹è¿›

**å½“å‰é—®é¢˜**ï¼š`/parking/butler/generateMiniProgramCode` æ¥å£æœªè¿”å›çœŸæ­£çš„å¾®ä¿¡å°ç¨‹åºç 

**è§£å†³æ–¹æ¡ˆ**ï¼šå®Œå–„åç«¯å®ç°

```java
// 1. æ·»åŠ å¾®ä¿¡é…ç½®
@Value("${wechat.miniprogram.appid}")
private String appId;

@Value("${wechat.miniprogram.secret}")
private String appSecret;

// 2. ä¿®æ”¹æ¥å£è¿”å›æ ¼å¼
@GetMapping("/generateMiniProgramCode")
public ResponseEntity<?> generateMiniProgramCode(@RequestParam String phone, ...) {
    try {
        // è·å–å¾®ä¿¡access_token
        String accessToken = getWechatAccessToken();
        
        // è°ƒç”¨å¾®ä¿¡APIç”Ÿæˆå°ç¨‹åºç 
        byte[] qrCodeBytes = generateWechatMiniProgramCode(accessToken, phone, ...);
        
        // è½¬æ¢ä¸ºBase64
        String base64Image = "data:image/png;base64," + Base64.getEncoder().encodeToString(qrCodeBytes);
        
        // è¿”å›æ ‡å‡†æ ¼å¼
        Map<String, Object> result = new HashMap<>();
        result.put("type", "wechat_mini_program");
        result.put("qrCodeImage", base64Image);
        result.put("officialCode", true);  // ğŸ¯ å…³é”®æ ‡è¯†
        result.put("butlerPhone", phone);
        result.put("butlerName", getButlerName(phone));
        
        return ResponseEntity.ok(Map.of("code", "0", "data", result));
        
    } catch (Exception e) {
        // å¤±è´¥æ—¶è¿”å›é™çº§æ ‡è¯†
        Map<String, Object> fallback = new HashMap<>();
        fallback.put("type", "text_fallback");
        fallback.put("officialCode", false);
        fallback.put("errorMessage", e.getMessage());
        
        return ResponseEntity.ok(Map.of("code", "0", "data", fallback));
    }
}
```

#### 2. å‰ç«¯ä¼˜åŒ–è¯†åˆ«æœºåˆ¶

ä¿®æ”¹ `qrcode-generator.vue` ä¸­çš„åˆ¤æ–­é€»è¾‘ï¼š

```javascript
// åœ¨ generateMiniProgramCode() æ–¹æ³•ä¸­
if (response.code === '0' && response.data) {
    if (response.data.officialCode === true && response.data.qrCodeImage) {
        // âœ… çœŸæ­£çš„å¾®ä¿¡å®˜æ–¹å°ç¨‹åºç 
        console.log('âœ… è·å–åˆ°å¾®ä¿¡å®˜æ–¹å°ç¨‹åºç ');
        this.qrCodeData = response.data;
        this.displayBase64Image(response.data.qrCodeImage);
        
        // æ˜¾ç¤ºæˆåŠŸæç¤º
        uni.showModal({
            title: 'ğŸ¯ å¾®ä¿¡å®˜æ–¹å°ç¨‹åºç ç”ŸæˆæˆåŠŸ',
            content: `âœ… è®¿å®¢æ‰«ç åå°†ç›´æ¥è·³è½¬åˆ°å°ç¨‹åºï¼\n\nç®¡å®¶ï¼š${response.data.butlerName}\nç”µè¯ï¼š${response.data.butlerPhone}`,
            showCancel: false
        });
        
    } else {
        // âŒ åç«¯APIå¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°ç”Ÿæˆ
        console.warn('âš ï¸ åç«¯æœªè¿”å›å®˜æ–¹å°ç¨‹åºç ï¼Œä½¿ç”¨æœ¬åœ°ç”Ÿæˆ');
        await this.generateLocalFallback();
    }
}
```

### æ–¹æ¡ˆäºŒï¼šä¼˜åŒ–æœ¬åœ°ç”Ÿæˆä½“éªŒï¼ˆä¸´æ—¶æ–¹æ¡ˆâ­â­â­ï¼‰

å¦‚æœçŸ­æœŸå†…æ— æ³•å®ç°å¾®ä¿¡å®˜æ–¹APIï¼Œå¯ä»¥ä¼˜åŒ–å½“å‰çš„æœ¬åœ°ç”Ÿæˆï¼š

#### 1. ç”Ÿæˆå°ç¨‹åºåˆ†äº«é“¾æ¥æ ¼å¼çš„äºŒç»´ç 

```javascript
// ä¿®æ”¹ buildQrCodeUrl() æ–¹æ³•
buildQrCodeUrl() {
    // ğŸ¯ ç”Ÿæˆå°ç¨‹åºé¡µé¢è·¯å¾„æ ¼å¼ï¼Œè€Œä¸æ˜¯çº¯æ–‡æœ¬
    const pageParams = {
        butlerName: this.qrCodeData?.butlerName || 'ç®¡å®¶',
        butlerPhone: this.qrCodeData?.butlerPhone || '',
        community: this.selectedAddress.community || '',
        building: this.selectedAddress.building || '',
        units: this.selectedAddress.units || '',
        floor: this.selectedAddress.floor || '',
        room: this.selectedAddress.room || '',
        type: 'butler_invitation'
    };
    
    // ç”Ÿæˆå°ç¨‹åºé¡µé¢è·¯å¾„æ ¼å¼
    const miniProgramPath = `pages/auth/visitor-apply?${Object.keys(pageParams)
        .map(key => `${key}=${encodeURIComponent(pageParams[key])}`)
        .join('&')}`;
    
    // ğŸ¯ åŒ…è£…æˆç”¨æˆ·å‹å¥½çš„æ ¼å¼
    const qrCodeContent = `ã€è®¿å®¢é¢„çº¦é‚€è¯·ã€‘
ç®¡å®¶ï¼š${pageParams.butlerName}
ç”µè¯ï¼š${pageParams.butlerPhone}
åœ°å€ï¼š${this.fullAddress}

ğŸ“± ä½¿ç”¨æ–¹æ³•ï¼š
1. é•¿æŒ‰å¤åˆ¶ä¸‹æ–¹é“¾æ¥
2. åœ¨å¾®ä¿¡ä¸­æ‰“å¼€"åœè½¦åœºç®¡ç†"å°ç¨‹åº
3. å°†é“¾æ¥ç²˜è´´åˆ°æµè§ˆå™¨æˆ–åˆ†äº«ç»™è®¿å®¢

å°ç¨‹åºé“¾æ¥ï¼š${miniProgramPath}

âš ï¸ æç¤ºï¼šæ­¤ä¸ºæ–‡æœ¬äºŒç»´ç ï¼Œéœ€è¦æ‰‹åŠ¨æ“ä½œ`;

    return qrCodeContent;
}
```

#### 2. æ·»åŠ å‹å¥½çš„ä½¿ç”¨æŒ‡å¯¼

```javascript
// åœ¨äºŒç»´ç ç”ŸæˆæˆåŠŸåæ˜¾ç¤ºè¯¦ç»†æŒ‡å¯¼
showTextQrCodeGuide() {
    uni.showModal({
        title: 'ğŸ“± æ–‡æœ¬äºŒç»´ç ä½¿ç”¨æŒ‡å—',
        content: `å½“å‰ç”Ÿæˆçš„æ˜¯æ–‡æœ¬äºŒç»´ç ï¼Œè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š

ğŸ” è®¿å®¢æ‰«ç åçš„æ“ä½œï¼š
1. æ‰«ç æŸ¥çœ‹äºŒç»´ç å†…å®¹
2. å¤åˆ¶å…¶ä¸­çš„ç®¡å®¶ä¿¡æ¯
3. æ‰‹åŠ¨æ‰“å¼€"åœè½¦åœºç®¡ç†"å°ç¨‹åº
4. è¿›å…¥è®¿å®¢ç”³è¯·é¡µé¢
5. å¡«å…¥å¤åˆ¶çš„ç®¡å®¶ä¿¡æ¯

ğŸ’¡ æ”¹è¿›å»ºè®®ï¼š
é…ç½®å¾®ä¿¡å®˜æ–¹å°ç¨‹åºç APIåï¼Œ
è®¿å®¢å¯ç›´æ¥æ‰«ç è·³è½¬ï¼`,
        showCancel: true,
        cancelText: 'çŸ¥é“äº†',
        confirmText: 'æŸ¥çœ‹é…ç½®æŒ‡å—',
        success: (res) => {
            if (res.confirm) {
                this.showConfigGuide();
            }
        }
    });
}
```

### æ–¹æ¡ˆä¸‰ï¼šå°ç¨‹åºç  + åˆ†äº«é“¾æ¥åŒä¿é™©ï¼ˆæ¨èâ­â­â­â­ï¼‰

#### 1. æ·»åŠ åˆ†äº«é“¾æ¥åŠŸèƒ½

```javascript
// æ–°å¢æ–¹æ³•ï¼šç”Ÿæˆåˆ†äº«é“¾æ¥
generateShareLink() {
    const shareParams = {
        butlerName: this.butlerInfo?.username || 'ç®¡å®¶',
        butlerPhone: this.butlerInfo?.phone || '',
        community: this.selectedAddress.community || '',
        fullAddress: this.fullAddress,
        type: 'butler_invitation'
    };
    
    const shareUrl = `pages/auth/visitor-apply?${Object.keys(shareParams)
        .map(key => `${key}=${encodeURIComponent(shareParams[key])}`)
        .join('&')}`;
    
    // å¤åˆ¶åˆ°å‰ªè´´æ¿
    uni.setClipboardData({
        data: shareUrl,
        success: () => {
            uni.showModal({
                title: 'ğŸ”— è®¿å®¢ç”³è¯·é“¾æ¥å·²å¤åˆ¶',
                content: `é“¾æ¥ï¼š${shareUrl}

ğŸ“± ä½¿ç”¨æ–¹æ³•ï¼š
1. å°†æ­¤é“¾æ¥å‘é€ç»™è®¿å®¢
2. è®¿å®¢åœ¨å¾®ä¿¡ä¸­æ‰“å¼€æ‚¨çš„å°ç¨‹åº
3. é€šè¿‡é“¾æ¥ç›´æ¥è¿›å…¥ç”³è¯·é¡µé¢
4. ç®¡å®¶ä¿¡æ¯å°†è‡ªåŠ¨å¡«å…¥

âœ… æ— éœ€é…ç½®ï¼Œå³å¯å®ç°è‡ªåŠ¨è·³è½¬ï¼`,
                showCancel: false
            });
        }
    });
}
```

#### 2. åœ¨ç•Œé¢ä¸Šæ·»åŠ åˆ†äº«æŒ‰é’®

åœ¨ `qrcode-generator.vue` çš„æŒ‰é’®åŒºåŸŸæ·»åŠ ï¼š

```vue
<view class="action-buttons">
    <u-button type="success" @click="saveQrCode" text="ä¿å­˜äºŒç»´ç " 
        customStyle="margin-right: 8px; flex: 1;" />
    <u-button type="warning" @click="copyQrCodeText" text="å¤åˆ¶ä¿¡æ¯" 
        customStyle="margin-right: 8px; flex: 1;" />
    <!-- ğŸ¯ æ–°å¢åˆ†äº«é“¾æ¥æŒ‰é’® -->
    <u-button type="primary" @click="generateShareLink" text="ç”Ÿæˆåˆ†äº«é“¾æ¥" 
        customStyle="margin-right: 8px; flex: 1;" />
    <u-button type="info" @click="shareQrCode" text="åˆ†äº«äºŒç»´ç " 
        customStyle="flex: 1;" />
</view>

<!-- ğŸ¯ æ·»åŠ åŠŸèƒ½è¯´æ˜ -->
<view class="function-tips" style="margin-top: 20rpx; padding: 20rpx; background: #f0f9ff; border-radius: 10rpx;">
    <text class="tips-title" style="font-weight: bold; color: #1890ff;">ğŸ’¡ æ¨èä½¿ç”¨æ–¹å¼</text>
    <text class="tips-item" style="display: block; margin-top: 10rpx; color: #666;">
        ğŸ”— ç‚¹å‡»"ç”Ÿæˆåˆ†äº«é“¾æ¥" - è®¿å®¢ç‚¹å‡»é“¾æ¥å¯ç›´æ¥è·³è½¬åˆ°ç”³è¯·é¡µé¢ï¼ˆæ¨èï¼‰
    </text>
    <text class="tips-item" style="display: block; margin-top: 5rpx; color: #666;">
        ğŸ“± åˆ†äº«äºŒç»´ç  - è®¿å®¢æ‰«ç æŸ¥çœ‹ä¿¡æ¯åæ‰‹åŠ¨æ“ä½œ
    </text>
</view>
```

### æ–¹æ¡ˆå››ï¼šä¼˜åŒ–è®¿å®¢ç”³è¯·é¡µé¢çš„å‚æ•°å¤„ç†ï¼ˆè¡¥å……â­â­â­â­ï¼‰

ç¡®ä¿ `visitor-apply.vue` èƒ½æ­£ç¡®å¤„ç†å„ç§å‚æ•°æ¥æºï¼š

```javascript
// åœ¨ handleQrCodeParams æ–¹æ³•ä¸­æ·»åŠ æ›´å¼ºçš„å…¼å®¹æ€§
async handleQrCodeParams(options) {
    try {
        console.log('ğŸ“± å¤„ç†é¡µé¢å‚æ•°:', options);
        
        // ğŸ¯ å¤„ç†å¤šç§å‚æ•°æ¥æº
        let butlerName = options.butlerName || options.bn || '';
        let butlerPhone = options.butlerPhone || options.bp || '';
        let community = options.community || options.c || '';
        
        // å¤„ç†å¾®ä¿¡å°ç¨‹åºç sceneå‚æ•°
        if (options.scene) {
            const sceneParams = this.parseSceneParams(options.scene);
            butlerPhone = butlerPhone || sceneParams.bp || '';
            community = community || sceneParams.c || '';
        }
        
        if (butlerPhone || butlerName) {
            // é¢„å¡«ç®¡å®¶ä¿¡æ¯
            this.form.ownerPhone = butlerPhone;
            
            // é¢„è®¾åœ°å€ä¿¡æ¯
            if (community) {
                this.pendingAddressPreset = {
                    community: community,
                    building: options.building || options.b || '',
                    units: options.units || options.u || '',
                    floor: options.floor || options.f || '',
                    room: options.room || options.r || ''
                };
            }
            
            // æ˜¾ç¤ºå‹å¥½æç¤º
            uni.showModal({
                title: 'ğŸ¯ ä¿¡æ¯å·²è‡ªåŠ¨å¡«å…¥',
                content: `é€šè¿‡${options.scene ? 'æ‰«ç ' : 'é“¾æ¥'}è¿›å…¥è®¿å®¢ç”³è¯·ï¼

${butlerName ? `ç®¡å®¶ï¼š${butlerName}` : ''}
${butlerPhone ? `ç”µè¯ï¼š${butlerPhone}` : ''}
${community ? `å°åŒºï¼š${community}` : ''}

è¯·å®Œå–„å…¶ä»–ä¿¡æ¯åæäº¤ç”³è¯·ã€‚`,
                showCancel: false
            });
            
            // è‡ªåŠ¨éªŒè¯ä¸šä¸»æ‰‹æœºå·
            if (butlerPhone && butlerPhone.length === 11) {
                setTimeout(() => {
                    this.validateOwnerPhone();
                }, 1000);
            }
        }
        
    } catch (error) {
        console.error('å¤„ç†å‚æ•°å¤±è´¥:', error);
    }
}

// ğŸ¯ æ–°å¢sceneå‚æ•°è§£ææ–¹æ³•
parseSceneParams(scene) {
    const params = {};
    try {
        // å¤„ç†æ ¼å¼ï¼šbp=12345678&c=å°åŒº&b=1&u=1&f=1&r=101
        const pairs = scene.split('&');
        pairs.forEach(pair => {
            const [key, value] = pair.split('=');
            if (key && value) {
                params[key] = decodeURIComponent(value);
            }
        });
    } catch (error) {
        console.error('è§£æsceneå‚æ•°å¤±è´¥:', error);
    }
    return params;
}
```

## ğŸš€ å®æ–½å»ºè®®

### ä¼˜å…ˆçº§é¡ºåºï¼š

1. **ç«‹å³å®æ–½**ï¼šæ–¹æ¡ˆä¸‰ï¼ˆåˆ†äº«é“¾æ¥åŠŸèƒ½ï¼‰ - æ— éœ€åç«¯æ”¹åŠ¨ï¼Œç«‹å³å¯ç”¨
2. **çŸ­æœŸç›®æ ‡**ï¼šæ–¹æ¡ˆäºŒï¼ˆä¼˜åŒ–æœ¬åœ°ç”Ÿæˆä½“éªŒï¼‰ - æ”¹å–„å½“å‰ç”¨æˆ·ä½“éªŒ
3. **ä¸­æœŸç›®æ ‡**ï¼šæ–¹æ¡ˆä¸€ï¼ˆå¾®ä¿¡å®˜æ–¹APIï¼‰ - å®ç°çœŸæ­£çš„æ‰«ç è·³è½¬
4. **æŒç»­ä¼˜åŒ–**ï¼šæ–¹æ¡ˆå››ï¼ˆå‚æ•°å¤„ç†ä¼˜åŒ–ï¼‰ - æå‡å…¼å®¹æ€§

### æµ‹è¯•éªŒè¯ï¼š

1. **åˆ†äº«é“¾æ¥æµ‹è¯•**ï¼šç¡®ä¿é“¾æ¥èƒ½æ­£ç¡®è·³è½¬å’Œé¢„å¡«ä¿¡æ¯
2. **äºŒç»´ç æ‰«ææµ‹è¯•**ï¼šéªŒè¯å„ç§æ ¼å¼çš„äºŒç»´ç æ‰«ææ•ˆæœ
3. **å‚æ•°å…¼å®¹æµ‹è¯•**ï¼šæµ‹è¯•å„ç§å‚æ•°æ¥æºçš„å¤„ç†
4. **ç”¨æˆ·ä½“éªŒæµ‹è¯•**ï¼šæ”¶é›†å®é™…ç”¨æˆ·åé¦ˆ

## ğŸ“Š æ•ˆæœé¢„æœŸ

å®æ–½åçš„æ”¹è¿›æ•ˆæœï¼š

| æ–¹æ¡ˆ | å®æ–½éš¾åº¦ | ç”¨æˆ·ä½“éªŒæå‡ | æŠ€æœ¯å®Œå–„åº¦ |
|------|----------|--------------|------------|
| åˆ†äº«é“¾æ¥ | â­ | â­â­â­â­â­ | â­â­â­â­ |
| ä¼˜åŒ–æœ¬åœ°ç”Ÿæˆ | â­â­ | â­â­â­ | â­â­â­ |
| å¾®ä¿¡å®˜æ–¹API | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ |
| å‚æ•°å¤„ç†ä¼˜åŒ– | â­â­ | â­â­â­â­ | â­â­â­â­â­ |

è¿™æ ·çš„æ”¹è¿›æ–¹æ¡ˆèƒ½å¤Ÿåœ¨çŸ­æœŸå†…æ˜¾è‘—æå‡ç”¨æˆ·ä½“éªŒï¼ŒåŒæ—¶ä¸ºé•¿æœŸçš„æŠ€æœ¯å®Œå–„å¥ å®šåŸºç¡€ã€‚ 