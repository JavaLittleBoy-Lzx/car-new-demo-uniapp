# é¢„çº¦è¡¨å•è®¿é—®é™åˆ¶å’Œæ—¶é—´ä¼ é€’ä¿®å¤è¯´æ˜

## ä¿®å¤æ¦‚è¿°

æœ¬æ¬¡ä¿®å¤è§£å†³äº†ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼š
1. **é¢„çº¦å®Œæˆåé€šè¿‡åº•éƒ¨å¯¼èˆªæ ä»å¯è®¿é—®é¢„çº¦è¡¨å•**
2. **result.vueé¡µé¢ä¸­æ²¡æœ‰æ˜¾ç¤ºå®Œæ•´çš„è®¿é—®æ—¶é—´æ®µ**

ä¿®å¤æ–‡ä»¶ï¼š`pagesA/reservation/form.vue`

---

## é—®é¢˜1ï¼šé¢„çº¦å®Œæˆåçš„è®¿é—®é™åˆ¶

### é—®é¢˜æè¿°
ç”¨æˆ·å®Œæˆé¢„çº¦åï¼Œé€šè¿‡åº•éƒ¨å¯¼èˆªæ ç‚¹å‡»"é¢„çº¦è¡¨å•"ä»ç„¶å¯ä»¥è®¿é—®ï¼Œæ²¡æœ‰ä»»ä½•é™åˆ¶ï¼Œå¯èƒ½å¯¼è‡´é‡å¤é¢„çº¦ã€‚

### ä¿®å¤æ–¹æ¡ˆ

#### 1. å¢å¼º `checkGuestReservationStatus()` æ–¹æ³•

**ä½ç½®**ï¼šç¬¬ 2209 è¡Œ

**ä¿®æ”¹å†…å®¹**ï¼š
- å°†æ–¹æ³•ä»åªæ£€æŸ¥è®¿å®¢è§’è‰²æ‰©å±•åˆ°æ£€æŸ¥æ‰€æœ‰ç”¨æˆ·è§’è‰²
- æ·»åŠ æœ¬åœ°å­˜å‚¨æäº¤æ—¶é—´æ£€æŸ¥
- 30åˆ†é’Ÿå†…æäº¤è¿‡é¢„çº¦çš„ç”¨æˆ·å°†è¢«é™åˆ¶è®¿é—®

**å…³é”®ä»£ç **ï¼š
```javascript
async checkGuestReservationStatus() {
    try {
        console.log('ğŸ” [é¢„çº¦çŠ¶æ€æ£€æŸ¥] å¼€å§‹æ£€æŸ¥é¢„çº¦çŠ¶æ€ï¼Œç”¨æˆ·è§’è‰²:', this.currentUserRole);

        // ğŸ”§ æ£€æŸ¥æ˜¯å¦åˆšåˆšæäº¤è¿‡é¢„çº¦ï¼ˆé€šè¿‡æœ¬åœ°å­˜å‚¨æ ‡è®°ï¼‰
        const lastAppointmentData = uni.getStorageSync('lastAppointmentData');
        const lastSubmitTime = lastAppointmentData?.submitTime;
        
        if (lastSubmitTime) {
            const timeSinceSubmit = Date.now() - new Date(lastSubmitTime).getTime();
            const thirtyMinutes = 30 * 60 * 1000; // 30åˆ†é’Ÿ
            
            // å¦‚æœ30åˆ†é’Ÿå†…æäº¤è¿‡é¢„çº¦ï¼Œé™åˆ¶å†æ¬¡è®¿é—®
            if (timeSinceSubmit < thirtyMinutes) {
                console.log('ğŸ” [é¢„çº¦çŠ¶æ€æ£€æŸ¥] æ£€æµ‹åˆ°æœ€è¿‘æäº¤çš„é¢„çº¦:', {
                    submitTime: lastSubmitTime,
                    timeSinceSubmit: Math.floor(timeSinceSubmit / 1000 / 60) + 'åˆ†é’Ÿå‰'
                });
                
                // æ˜¾ç¤ºé¢„çº¦å·²å®Œæˆçš„é”å®šç•Œé¢
                this.showReservationCompletedLock();
                return;
            }
        }
        
        // ... å…¶ä»–æ£€æŸ¥é€»è¾‘
    } catch (error) {
        console.error('âŒ [é¢„çº¦çŠ¶æ€æ£€æŸ¥] æ£€æŸ¥é¢„çº¦çŠ¶æ€å¤±è´¥:', error);
    }
}
```

#### 2. æ·»åŠ  `showReservationCompletedLock()` æ–¹æ³•

**ä½ç½®**ï¼šç¬¬ 2139 è¡Œ

**åŠŸèƒ½**ï¼šæ˜¾ç¤ºé¢„çº¦å·²å®Œæˆçš„é”å®šå±å¹•

**ä»£ç **ï¼š
```javascript
showReservationCompletedLock() {
    const lastAppointmentData = uni.getStorageSync('lastAppointmentData');
    const visitDate = lastAppointmentData?.visitDate || 'æœªçŸ¥æ—¶é—´';
    
    this.lockScreenConfig = {
        icon: 'âœ…',
        title: 'é¢„çº¦å·²å®Œæˆ',
        message: 'æ‚¨å·²æˆåŠŸæäº¤é¢„çº¦ï¼Œè¯·å‹¿é‡å¤é¢„çº¦',
        tips: [
            `é¢„çº¦æ—¶é—´ï¼š${visitDate}`,
            '30åˆ†é’Ÿå†…ä¸å…è®¸é‡å¤æäº¤é¢„çº¦',
            'æ‚¨å¯ä»¥åœ¨"æˆ‘çš„é¢„çº¦"ä¸­æŸ¥çœ‹è¯¦æƒ…',
            'å¦‚éœ€ä¿®æ”¹è¯·è”ç³»ç®¡å®¶'
        ],
        showContactButton: true,
        contactButtonText: 'æŸ¥çœ‹æˆ‘çš„é¢„çº¦',
        showDebugButton: false,
        footerText: 'å¦‚æœ‰ç–‘é—®è¯·è”ç³»å°åŒºç®¡å®¶',
        isQrUsed: false
    };
    this.showLockScreen = true;
    
    console.log('ğŸ”’ [è®¿é—®æ§åˆ¶] æ˜¾ç¤ºé¢„çº¦å·²å®Œæˆé”å®šå±å¹•');
}
```

#### 3. æ·»åŠ  `checkActiveReservations()` æ–¹æ³•

**ä½ç½®**ï¼šç¬¬ 2356 è¡Œ

**åŠŸèƒ½**ï¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰å¾…å¤„ç†çš„æ´»è·ƒé¢„çº¦

**ä»£ç **ï¼š
```javascript
async checkActiveReservations() {
    try {
        const userInfo = uni.getStorageSync('userInfo') || {};
        let phoneToCheck = '';
        
        // æ ¹æ®è§’è‰²è·å–è¦æ£€æŸ¥çš„æ‰‹æœºå·
        if (this.currentUserRole === 'visitor') {
            phoneToCheck = this.model1.code || userInfo.phone;
        } else if (this.currentUserRole === 'owner') {
            phoneToCheck = userInfo.phone || userInfo.userInfo?.phone;
        } else if (this.currentUserRole === 'manager') {
            phoneToCheck = userInfo.phone || userInfo.userInfo?.phone;
        }
        
        if (!phoneToCheck) {
            console.log('ğŸ” [æ´»è·ƒé¢„çº¦æ£€æŸ¥] æœªè·å–åˆ°æ‰‹æœºå·ï¼Œè·³è¿‡æ£€æŸ¥');
            return;
        }
        
        console.log('ğŸ” [æ´»è·ƒé¢„çº¦æ£€æŸ¥] æ£€æŸ¥æ‰‹æœºå·:', phoneToCheck);
        
        // è·å–æœ€è¿‘çš„é¢„çº¦è®°å½•
        const recentRecords = await this.getRecentReservationsByPhone(phoneToCheck);
        
        if (recentRecords && recentRecords.length > 0) {
            // æ£€æŸ¥æ˜¯å¦æœ‰å¾…å®¡æ‰¹æˆ–å¾…å…¥åœºçš„é¢„çº¦
            const activeRecord = recentRecords.find(record => {
                const status = this.getRecordStatus(record);
                return ['å¾…å®¡æ‰¹', 'å¾…å…¥åœº', 'å®¡æ‰¹ä¸­'].includes(status);
            });
            
            if (activeRecord) {
                console.log('ğŸ” [æ´»è·ƒé¢„çº¦æ£€æŸ¥] å‘ç°å¾…å¤„ç†çš„é¢„çº¦è®°å½•:', activeRecord);
                
                // æ˜¾ç¤ºæç¤ºï¼Œä½†ä¸å¼ºåˆ¶é”å®šï¼ˆç”¨æˆ·å¯èƒ½éœ€è¦ä¿®æ”¹é¢„çº¦ï¼‰
                uni.showModal({
                    title: 'æç¤º',
                    content: 'æ‚¨æœ‰å¾…å¤„ç†çš„é¢„çº¦è®°å½•ï¼Œç¡®å®šè¦åˆ›å»ºæ–°çš„é¢„çº¦å—ï¼Ÿ',
                    confirmText: 'ç»§ç»­é¢„çº¦',
                    cancelText: 'æŸ¥çœ‹é¢„çº¦',
                    success: (res) => {
                        if (!res.confirm) {
                            // ç”¨æˆ·é€‰æ‹©æŸ¥çœ‹é¢„çº¦
                            uni.navigateTo({
                                url: '/pagesA/reservation/searchResult/searchResult'
                            });
                        }
                    }
                });
            }
        }
        
    } catch (error) {
        console.error('âŒ [æ´»è·ƒé¢„çº¦æ£€æŸ¥] æ£€æŸ¥å¤±è´¥:', error);
    }
}
```

---

## é—®é¢˜2ï¼šresult.vueä¸­ç¼ºå°‘è®¿é—®æ—¶é—´

### é—®é¢˜æè¿°
result.vueé¡µé¢æ˜¾ç¤ºçš„è®¿é—®æ—¶é—´ä¸å®Œæ•´ï¼Œåªæœ‰æ—¥æœŸæ²¡æœ‰æ—¶é—´æ®µä¿¡æ¯ã€‚åŸå› æ˜¯`visitdate`å­—æ®µä¼ é€’æ—¶åªåŒ…å«æ—¥æœŸï¼ˆå¦‚"2025-12-03"ï¼‰ï¼Œæ²¡æœ‰åŒ…å«æ—¶é—´æ®µã€‚

### ä¿®å¤æ–¹æ¡ˆ

#### 1. ä¿®å¤ `buildAppointmentData()` æ–¹æ³•ä¸­çš„visitDateTimeæ„å»º

**ä½ç½®**ï¼šç¬¬ 4691 è¡Œ

**ä¿®æ”¹å‰**ï¼š
```javascript
let visitDateTime = '';
if (selectedDate) {
    const currentYear = new Date().getFullYear();
    visitDateTime = `${currentYear}-${selectedDate.day}`;
}
```

**ä¿®æ”¹å**ï¼š
```javascript
// ğŸ”§ æ„å»ºå®Œæ•´çš„è®¿é—®æ—¥æœŸæ—¶é—´ï¼ˆåŒ…å«æ—¶é—´æ®µï¼‰
let visitDateTime = '';
if (selectedDate) {
    const currentYear = new Date().getFullYear();
    const dateStr = `${currentYear}-${selectedDate.day}`;
    
    // è·å–é€‰ä¸­çš„æ—¶é—´æ®µ
    const selectedTimeSlot = this.timeSlots[this.activeTimeSlot];
    if (selectedTimeSlot) {
        // æ„å»ºå®Œæ•´çš„æ—¶é—´æ®µæ ¼å¼ï¼š2025-12-03 08:00:00 - 2025-12-03 10:00:00
        const startTime = selectedTimeSlot.value || '08:00:00';
        const endTime = selectedTimeSlot.endValue || '10:00:00';
        visitDateTime = `${dateStr} ${startTime} - ${dateStr} ${endTime}`;
    } else {
        // å¦‚æœæ²¡æœ‰é€‰æ‹©æ—¶é—´æ®µï¼Œåªä½¿ç”¨æ—¥æœŸ
        visitDateTime = dateStr;
    }
}
```

#### 2. ä¿®å¤é‚€è¯·é¢„çº¦ä¸­çš„visitDateæ„å»º

**ä½ç½®**ï¼šç¬¬ 8527 è¡Œ

**ä¿®æ”¹å‰**ï¼š
```javascript
// å®‰å…¨è·å–é¢„çº¦æ—¥æœŸï¼Œå¦‚æœæ²¡æœ‰é€‰æ‹©åˆ™ä½¿ç”¨ä»Šå¤©
let visitDate = selectedDate?.fullDate;
if (!visitDate) {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    visitDate = `${year}-${month}-${day}`;
}
```

**ä¿®æ”¹å**ï¼š
```javascript
// ğŸ”§ å®‰å…¨è·å–é¢„çº¦æ—¥æœŸï¼Œå¦‚æœæ²¡æœ‰é€‰æ‹©åˆ™ä½¿ç”¨ä»Šå¤©
let visitDate = selectedDate?.fullDate;
if (!visitDate) {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    visitDate = `${year}-${month}-${day}`;
}

// ğŸ”§ æ„å»ºå®Œæ•´çš„è®¿é—®æ—¥æœŸæ—¶é—´ï¼ˆåŒ…å«æ—¶é—´æ®µï¼‰
if (selectedTimeSlot && selectedTimeSlot.value && selectedTimeSlot.endValue) {
    const startTime = selectedTimeSlot.value;
    const endTime = selectedTimeSlot.endValue;
    visitDate = `${visitDate} ${startTime} - ${visitDate} ${endTime}`;
}
```

---

## ä¿®å¤æ•ˆæœ

### é—®é¢˜1ä¿®å¤æ•ˆæœ

âœ… **30åˆ†é’Ÿè®¿é—®é™åˆ¶**
- ç”¨æˆ·æäº¤é¢„çº¦å30åˆ†é’Ÿå†…æ— æ³•å†æ¬¡è®¿é—®é¢„çº¦è¡¨å•
- æ˜¾ç¤ºå‹å¥½çš„é”å®šç•Œé¢ï¼Œæç¤ºç”¨æˆ·é¢„çº¦å·²å®Œæˆ
- æä¾›"æŸ¥çœ‹æˆ‘çš„é¢„çº¦"æŒ‰é’®ï¼Œæ–¹ä¾¿ç”¨æˆ·æŸ¥çœ‹é¢„çº¦è¯¦æƒ…

âœ… **æ´»è·ƒé¢„çº¦æ£€æŸ¥**
- æ£€æµ‹ç”¨æˆ·æ˜¯å¦æœ‰å¾…å®¡æ‰¹æˆ–å¾…å…¥åœºçš„é¢„çº¦
- å¦‚æœ‰å¾…å¤„ç†é¢„çº¦ï¼Œå¼¹çª—æç¤ºç”¨æˆ·
- ç”¨æˆ·å¯é€‰æ‹©ç»§ç»­é¢„çº¦æˆ–æŸ¥çœ‹å·²æœ‰é¢„çº¦

âœ… **è®¿å®¢äºŒç»´ç é™åˆ¶ï¼ˆä¿æŒåŸæœ‰åŠŸèƒ½ï¼‰**
- è®¿å®¢ä½¿ç”¨è¿‡çš„äºŒç»´ç ä»ç„¶è¢«æ ‡è®°å’Œé™åˆ¶
- è®¿å®¢è§’è‰²çš„ç‰¹æ®Šæ£€æŸ¥é€»è¾‘å¾—åˆ°ä¿ç•™

### é—®é¢˜2ä¿®å¤æ•ˆæœ

âœ… **å®Œæ•´æ—¶é—´æ®µæ˜¾ç¤º**
- visitdateå­—æ®µç°åœ¨åŒ…å«å®Œæ•´çš„æ—¶é—´æ®µä¿¡æ¯
- æ ¼å¼ï¼š`2025-12-03 08:00:00 - 2025-12-03 10:00:00`
- result.vueé¡µé¢å¯ä»¥æ­£ç¡®è§£æå’Œæ˜¾ç¤ºæ—¶é—´æ®µ

âœ… **å‘åå…¼å®¹**
- å¦‚æœæ²¡æœ‰é€‰æ‹©æ—¶é—´æ®µï¼Œä»ç„¶åªä½¿ç”¨æ—¥æœŸ
- ä¸ä¼šå½±å“å…¶ä»–ä½¿ç”¨visitdateå­—æ®µçš„åŠŸèƒ½

---

## æµ‹è¯•å»ºè®®

### æµ‹è¯•åœºæ™¯1ï¼šé¢„çº¦åè®¿é—®é™åˆ¶
1. å®Œæˆä¸€æ¬¡é¢„çº¦æäº¤
2. ç«‹å³é€šè¿‡åº•éƒ¨å¯¼èˆªæ ç‚¹å‡»"é¢„çº¦è¡¨å•"
3. **é¢„æœŸç»“æœ**ï¼šæ˜¾ç¤º"é¢„çº¦å·²å®Œæˆ"é”å®šå±å¹•ï¼Œæ— æ³•è®¿é—®è¡¨å•
4. ç­‰å¾…30åˆ†é’Ÿåå†æ¬¡å°è¯•è®¿é—®
5. **é¢„æœŸç»“æœ**ï¼šå¯ä»¥æ­£å¸¸è®¿é—®é¢„çº¦è¡¨å•

### æµ‹è¯•åœºæ™¯2ï¼šè®¿é—®æ—¶é—´æ˜¾ç¤º
1. é€‰æ‹©æ—¥æœŸå’Œæ—¶é—´æ®µï¼ˆå¦‚"08:00-10:00"ï¼‰
2. å®Œæˆé¢„çº¦æäº¤
3. æŸ¥çœ‹result.vueé¢„çº¦ç»“æœé¡µé¢
4. **é¢„æœŸç»“æœ**ï¼šæ˜¾ç¤ºå®Œæ•´æ—¶é—´æ®µ"2025å¹´12æœˆ03æ—¥ 08:00-10:00"

### æµ‹è¯•åœºæ™¯3ï¼šæ´»è·ƒé¢„çº¦æ£€æŸ¥
1. æäº¤ä¸€ä¸ªé¢„çº¦ï¼ˆçŠ¶æ€ä¸ºå¾…å®¡æ‰¹ï¼‰
2. ç­‰å¾…30åˆ†é’Ÿåï¼ˆè¶…è¿‡è®¿é—®é™åˆ¶æ—¶é—´ï¼‰
3. å†æ¬¡è®¿é—®é¢„çº¦è¡¨å•
4. **é¢„æœŸç»“æœ**ï¼šå¼¹çª—æç¤º"æ‚¨æœ‰å¾…å¤„ç†çš„é¢„çº¦è®°å½•"
5. å¯é€‰æ‹©ç»§ç»­é¢„çº¦æˆ–æŸ¥çœ‹å·²æœ‰é¢„çº¦

---

## æŠ€æœ¯è¦ç‚¹

### 1. æ—¶é—´æˆ³ç®¡ç†
- ä½¿ç”¨`lastAppointmentData.submitTime`è®°å½•æäº¤æ—¶é—´
- ISOæ ¼å¼ï¼š`new Date().toISOString()`
- æ—¶é—´å·®è®¡ç®—ï¼š`Date.now() - new Date(lastSubmitTime).getTime()`

### 2. è®¿é—®æ§åˆ¶å±‚çº§
1. **å¼ºåˆ¶é”å®š**ï¼ˆ30åˆ†é’Ÿå†…ï¼‰ï¼šæ˜¾ç¤ºé”å®šå±å¹•ï¼Œå®Œå…¨ç¦æ­¢è®¿é—®
2. **å‹å¥½æç¤º**ï¼ˆæœ‰æ´»è·ƒé¢„çº¦ï¼‰ï¼šå¼¹çª—æç¤ºï¼Œå…è®¸ç”¨æˆ·é€‰æ‹©
3. **äºŒç»´ç é™åˆ¶**ï¼ˆè®¿å®¢è§’è‰²ï¼‰ï¼šæ°¸ä¹…æ ‡è®°å·²ä½¿ç”¨çš„äºŒç»´ç 

### 3. æ—¶é—´æ ¼å¼
- **å®Œæ•´æ ¼å¼**ï¼š`YYYY-MM-DD HH:mm:ss - YYYY-MM-DD HH:mm:ss`
- **æ˜¾ç¤ºæ ¼å¼**ï¼š`YYYYå¹´MMæœˆDDæ—¥ HH:mm-HH:mm`
- **å…¼å®¹å¤„ç†**ï¼šresult.vueçš„formatDateTimeæ–¹æ³•å·²æ”¯æŒè§£æåŒºé—´æ ¼å¼

---

## æ–‡ä»¶ä¿®æ”¹æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | è¡Œæ•° |
|------|---------|------|
| `pagesA/reservation/form.vue` | å¢å¼ºcheckGuestReservationStatusæ–¹æ³• | 2209-2261 |
| `pagesA/reservation/form.vue` | æ·»åŠ showReservationCompletedLockæ–¹æ³• | 2139-2163 |
| `pagesA/reservation/form.vue` | æ·»åŠ checkActiveReservationsæ–¹æ³• | 2356-2412 |
| `pagesA/reservation/form.vue` | ä¿®å¤buildAppointmentDataä¸­çš„visitDateTime | 4691-4708 |
| `pagesA/reservation/form.vue` | ä¿®å¤é‚€è¯·é¢„çº¦ä¸­çš„visitDate | 8527-8542 |

---

## æ³¨æ„äº‹é¡¹

1. **è®¿é—®é™åˆ¶æ—¶é—´**ï¼šå½“å‰è®¾ç½®ä¸º30åˆ†é’Ÿï¼Œå¦‚éœ€è°ƒæ•´å¯ä¿®æ”¹`thirtyMinutes`å˜é‡
2. **æœ¬åœ°å­˜å‚¨ä¾èµ–**ï¼šä¾èµ–`lastAppointmentData`æœ¬åœ°å­˜å‚¨ï¼Œæ¸…é™¤ç¼“å­˜ä¼šé‡ç½®é™åˆ¶
3. **ç½‘ç»œè¯·æ±‚**ï¼šæ´»è·ƒé¢„çº¦æ£€æŸ¥éœ€è¦ç½‘ç»œè¯·æ±‚ï¼Œç½‘ç»œæ•…éšœæ—¶ä¸å½±å“ä¸»æµç¨‹
4. **result.vueå…¼å®¹æ€§**ï¼šresult.vueçš„formatDateTimeæ–¹æ³•å·²å…¼å®¹æ–°æ—§ä¸¤ç§æ ¼å¼

---

## ä¿®å¤æ—¥æœŸ
2025å¹´12æœˆ3æ—¥

## ä¿®å¤äººå‘˜
Cascade AI Assistant
