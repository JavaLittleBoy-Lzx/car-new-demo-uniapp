# æ‰«ç è·³è½¬é—®é¢˜ç«‹å³è§£å†³æ–¹æ¡ˆ

## ğŸ¯ é—®é¢˜è¯Šæ–­ç»“æœ

**æ‚¨çš„é¡¹ç›®ç”Ÿæˆçš„æ˜¯æ™®é€šäºŒç»´ç ï¼Œä¸æ˜¯å¾®ä¿¡å®˜æ–¹å°ç¨‹åºç ï¼**

### å½“å‰çŠ¶å†µï¼š
- âœ… å‰ç«¯åŠŸèƒ½å®Œå–„ï¼šåˆ¤æ–­é€»è¾‘ã€åˆ†äº«åŠŸèƒ½ã€æ‰«ç å¤„ç†éƒ½å·²å®ç°
- âŒ åç«¯APIé—®é¢˜ï¼š`/parking/butler/generateMiniProgramCode` æœªè¿”å›çœŸæ­£çš„å°ç¨‹åºç 
- âŒ ç”Ÿæˆå†…å®¹ï¼šæ™®é€šæ–‡æœ¬äºŒç»´ç ï¼Œæ‰«ç æ˜¾ç¤ºæ–‡å­—è€Œä¸æ˜¯è·³è½¬

## ğŸš€ ç«‹å³å¯ç”¨è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨ç°æœ‰åˆ†äº«åŠŸèƒ½ï¼ˆæ¨èâ­â­â­â­â­ï¼‰

æ‚¨çš„é¡¹ç›®å·²ç»æœ‰å®Œç¾çš„åˆ†äº«åŠŸèƒ½ï¼

#### 1. åœ¨äºŒç»´ç ç”Ÿæˆå™¨ä¸­ç‚¹å‡»"é…ç½®å°ç¨‹åºç "
å½“ç”ŸæˆäºŒç»´ç åï¼Œä¼šæç¤º"å½“å‰ä¸ºæ™®é€šäºŒç»´ç "ï¼Œç‚¹å‡»"é…ç½®å°ç¨‹åºç "

#### 2. é€‰æ‹©"åˆ†äº«é“¾æ¥"
åœ¨å¼¹å‡ºçš„é…ç½®çª—å£ä¸­ï¼Œé€‰æ‹©"åˆ†äº«é“¾æ¥"é€‰é¡¹

#### 3. ç›´æ¥åˆ†äº«å°ç¨‹åºé¡µé¢
ç³»ç»Ÿä¼šç”Ÿæˆè¿™æ ·çš„é“¾æ¥ï¼š
```
pages/auth/visitor-apply?butlerName=ç®¡å®¶å§“å&butlerPhone=13812345678&community=å°åŒºå&type=butler_invitation
```

#### 4. è®¿å®¢ä½¿ç”¨ä½“éªŒ
- ç®¡å®¶å‘é€é“¾æ¥ç»™è®¿å®¢
- è®¿å®¢ç‚¹å‡»é“¾æ¥ç›´æ¥æ‰“å¼€å°ç¨‹åº
- è‡ªåŠ¨è·³è½¬åˆ°è®¿å®¢ç”³è¯·é¡µé¢
- ç®¡å®¶ä¿¡æ¯è‡ªåŠ¨å¡«å…¥
- è®¿å®¢ç›´æ¥æäº¤ç”³è¯·

### æ–¹æ¡ˆäºŒï¼šåˆ‡æ¢åˆ°æ–‡æœ¬äºŒç»´ç æ¨¡å¼

#### 1. é€‰æ‹©"æ–‡æœ¬äºŒç»´ç "ç±»å‹
åœ¨äºŒç»´ç ç±»å‹é€‰æ‹©ä¸­ï¼Œé€‰æ‹©"æ–‡æœ¬äºŒç»´ç "è€Œä¸æ˜¯"å°ç¨‹åºç "

#### 2. ç”Ÿæˆè®¿å®¢å‹å¥½äºŒç»´ç 
ç³»ç»Ÿä¼šç”ŸæˆåŒ…å«è¯¦ç»†è¯´æ˜çš„ä¸­æ–‡äºŒç»´ç ï¼Œè®¿å®¢æ‰«ç åå¯ä»¥ï¼š
- çœ‹åˆ°å®Œæ•´çš„ç”³è¯·æŒ‡å—
- å¤åˆ¶ç®¡å®¶è”ç³»æ–¹å¼
- è·å¾—è¯¦ç»†æ“ä½œè¯´æ˜

## ğŸ”§ é•¿æœŸè§£å†³æ–¹æ¡ˆï¼šé…ç½®å¾®ä¿¡å®˜æ–¹å°ç¨‹åºç 

### åç«¯éœ€è¦å®ç°çš„åŠŸèƒ½ï¼š

#### 1. å¾®ä¿¡access_tokenè·å–
```java
@GetMapping("/getAccessToken")
public String getWechatAccessToken() {
    String url = "https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=" + appId + "&secret=" + appSecret;
    // è°ƒç”¨å¾®ä¿¡APIè·å–access_token
}
```

#### 2. ä¿®æ”¹å°ç¨‹åºç ç”Ÿæˆæ¥å£
```java
@GetMapping("/generateMiniProgramCode")
public ResponseEntity<?> generateMiniProgramCode(@RequestParam String phone, ...) {
    try {
        // è·å–access_token
        String accessToken = getWechatAccessToken();
        
        // è°ƒç”¨å¾®ä¿¡å®˜æ–¹APIç”Ÿæˆå°ç¨‹åºç 
        String wechatApiUrl = "https://api.weixin.qq.com/wxa/getwxacodeunlimit?access_token=" + accessToken;
        
        JSONObject requestBody = new JSONObject();
        requestBody.put("scene", "bp=" + phone + "&t=bi");
        requestBody.put("page", "pages/auth/visitor-apply");
        requestBody.put("width", 430);
        
        // è°ƒç”¨å¾®ä¿¡API
        byte[] qrCodeBytes = callWechatApi(wechatApiUrl, requestBody);
        
        // è½¬æ¢ä¸ºBase64
        String base64Image = "data:image/png;base64," + Base64.getEncoder().encodeToString(qrCodeBytes);
        
        // ğŸ¯ å…³é”®ï¼šè¿”å›æ­£ç¡®çš„æ ¼å¼
        Map<String, Object> result = new HashMap<>();
        result.put("type", "wechat_mini_program");
        result.put("qrCodeImage", base64Image);  // ğŸ¯ å…³é”®å­—æ®µ
        result.put("officialCode", true);        // ğŸ¯ å…³é”®å­—æ®µ
        result.put("butlerName", butlerName);
        result.put("butlerPhone", phone);
        
        return ResponseEntity.ok(ApiResponse.success(result));
        
    } catch (Exception e) {
        // é™çº§è¿”å›
        Map<String, Object> fallback = new HashMap<>();
        fallback.put("type", "wechat_mini_program");
        fallback.put("officialCode", false);     // ğŸ¯ æ ‡è®°ä¸ºéå®˜æ–¹ç 
        fallback.put("pagePath", "pages/auth/visitor-apply?bp=" + phone + "&t=bi");
        return ResponseEntity.ok(ApiResponse.success(fallback));
    }
}
```

### å¾®ä¿¡å¼€å‘è€…åå°é…ç½®ï¼š

1. ç™»å½•å¾®ä¿¡å…¬ä¼—å¹³å°ï¼šhttps://mp.weixin.qq.com
2. è¿›å…¥å°ç¨‹åºç®¡ç†åå°
3. å¼€å‘ â†’ å¼€å‘ç®¡ç† â†’ å¼€å‘è®¾ç½®
4. è®°å½•AppIDå’ŒAppSecret
5. é…ç½®æœåŠ¡å™¨åŸŸåç™½åå•

## ğŸ“± æ¨èä½¿ç”¨é¡ºåº

### ç«‹å³ä½¿ç”¨ï¼ˆä»Šå¤©å°±èƒ½ç”¨ï¼‰ï¼š
1. **æ–¹æ¡ˆä¸€ï¼šåˆ†äº«é“¾æ¥** - æ•ˆæœæœ€å¥½ï¼Œç”¨æˆ·ä½“éªŒä½³
2. **æ–¹æ¡ˆäºŒï¼šæ–‡æœ¬äºŒç»´ç ** - åŒ…å«å®Œæ•´æŒ‡å—

### é•¿æœŸä¼˜åŒ–ï¼ˆéœ€è¦å¼€å‘æ—¶é—´ï¼‰ï¼š
3. **é…ç½®å¾®ä¿¡å®˜æ–¹API** - å®ç°çœŸæ­£çš„æ‰«ç è·³è½¬

## ğŸ¯ æ€»ç»“

æ‚¨çš„é¡¹ç›®åŠŸèƒ½éå¸¸å®Œå–„ï¼Œ**å”¯ä¸€çš„é—®é¢˜æ˜¯åç«¯APIæ²¡æœ‰è¿”å›çœŸæ­£çš„å°ç¨‹åºç **ã€‚

**å»ºè®®**ï¼š
- **ç«‹å³ä½¿ç”¨**ï¼šåˆ†äº«é“¾æ¥åŠŸèƒ½ï¼ˆå·²ç»å¾ˆå®Œç¾äº†ï¼‰
- **é•¿æœŸè§„åˆ’**ï¼šé…ç½®å¾®ä¿¡å®˜æ–¹å°ç¨‹åºç API

æ‚¨çš„å¼€å‘å›¢é˜Ÿåšå¾—å¾ˆæ£’ï¼ğŸ‘ 