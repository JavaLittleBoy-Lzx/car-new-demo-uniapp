# 花生壳内网穿透配置指南

## 🌐 当前配置状态

- **内网穿透地址**: `https://csharphrb.picp.vip`
- **本地服务端口**: `8543`
- **当前版本**: 花生壳免费版

## ⚠️ 花生壳免费版限制

### 主要问题
1. **中间页面**: 每次访问都显示"贝锐花生壳"页面，需要用户手动点击"继续访问"
2. **API调用失败**: 小程序API调用返回HTML而不是JSON数据
3. **用户体验差**: 体验版小程序无法正常使用

### 错误表现
```javascript
// API返回的不是JSON，而是HTML页面
{
  "data": "<!doctype html><html>...贝锐花生壳...</html>"
}
```

## 🔧 解决方案

### 方案一：自动处理10秒等待（已实现，推荐）✅

#### 核心功能
- ✅ 自动检测花生壳中间页面
- ✅ 智能等待12秒后自动重试
- ✅ 友好的用户提示和进度显示
- ✅ 无需升级付费版本

#### 工作原理
1. **检测中间页**: 识别花生壳免费版的HTML页面
2. **智能等待**: 等待12秒（比花生壳10秒稍长）
3. **自动重试**: 重新发起API请求
4. **用户提示**: 显示"正在自动等待跳转"的友好提示

#### 代码实现
```javascript
// 检测花生壳中间页面并自动处理
if (typeof res.data === 'string' && res.data.includes('贝锐花生壳')) {
  console.log('🕒 花生壳10秒等待中，将在12秒后自动重试');
  
  // 等待12秒后重试
  setTimeout(() => {
    makeRequest();
  }, 12000);
}
```

#### 用户体验
- 🕒 显示等待提示："花生壳等待中，请稍候..."
- ⏳ 更新加载文本："正在自动等待跳转(约需10-15秒)"
- 🔄 后台自动重试，无需用户操作

### 方案二：升级花生壳专业版（可选）

#### 优势
- ✅ 完全去除中间页面
- ✅ 更快的访问速度
- ✅ 支持自定义域名
- ✅ 更稳定的连接

#### 费用参考
- 专业版：约 ¥6/月
- 商业版：约 ¥15/月

### 方案三：使用其他免费内网穿透服务

#### 1. ngrok（免费额度）
```bash
ngrok http 8543
```

#### 2. frp（开源免费）
```bash
# 需要自己搭建服务器
```

#### 3. localtunnel
```bash
npm install -g localtunnel
lt --port 8543
```

## 📱 测试步骤

### 自动处理测试（当前版本）
1. **编译并运行小程序**
2. **点击手机号授权按钮**
3. **观察自动处理过程**：
   - 显示"花生壳等待中，请稍候..."
   - 加载文本更新为"正在自动等待跳转(约需10-15秒)"
   - 12秒后自动重试API调用
   - 成功后继续正常授权流程

### 预期用户体验
- ✅ **第一次请求**: 遇到花生壳中间页
- 🕒 **自动等待**: 显示友好提示，等待12秒
- 🔄 **自动重试**: 后台重新发起请求
- ✅ **成功访问**: 获得正常的JSON响应
- 🎉 **完成授权**: 继续后续流程

### 故障处理测试
如果自动重试仍失败，会显示：
- "花生壳自动跳转失败"提示
- 提供重新尝试和联系支持选项

## 🎯 推荐方案

### 当前方案（立即可用）✅
**自动处理花生壳10秒等待** - 完美解决免费版限制
- ✅ 无需额外费用
- ✅ 用户体验良好
- ✅ 自动化程度高
- ✅ 稳定可靠

### 可选升级方案
**花生壳专业版** - 如果需要更快速度
- ⚡ 即时访问，无等待
- 🌐 支持自定义域名
- 📈 更高的稳定性

### 长期方案（生产环境）
**正式域名 + 云服务部署**
- 🚀 专业级部署
- 🔒 HTTPS安全连接
- 📊 完整的监控和日志

## 🔍 故障排查

### 检查花生壳状态
1. 登录花生壳客户端
2. 确认映射规则正确
3. 测试内网服务是否正常

### 检查后端服务
```bash
# 检查端口监听
netstat -ano | findstr :8543

# 测试本地API
curl http://localhost:8543/parking/wechat/checkPermission
```

### 检查小程序配置
1. 确认 `config/api.js` 中环境为 `tunnel`
2. 确认 baseURL 为花生壳地址
3. 重新编译和部署小程序

## 📞 技术支持

如果遇到问题，请联系：

1. **花生壳官方支持**
   - 官网：https://hsk.oray.com/
   - 客服电话：400-6060-301

2. **项目技术支持**
   - 查看错误日志
   - 联系开发团队
   - 微信技术群

## 💡 最佳实践

1. **开发环境**：使用localhost进行开发调试
2. **测试环境**：使用花生壳专业版进行体验版测试
3. **生产环境**：使用正式域名和云服务部署

---

*最后更新时间：2024年1月* 