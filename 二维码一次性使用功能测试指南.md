# 二维码一次性使用功能测试指南

## 功能概述

实现了访客二维码一次性使用的限制功能，确保每个二维码只能用于一次预约操作，提高系统安全性。

## 实现的功能

### 1. 二维码使用状态检查
- 页面加载时自动检查二维码是否已被使用
- 本地存储 + 后端验证双重检查机制
- 网络异常时依赖本地存储保证功能可用性

### 2. 预约成功后自动标记
- 预约提交成功后自动标记二维码为已使用
- 本地存储 + 后端同步双重保障
- 即使后端失败也会在本地标记

### 3. 已使用二维码的锁定界面
- 专门的锁定屏幕提示二维码已使用
- 清晰的错误提示和解决方案
- 联系管家重新生成二维码的引导

## 测试步骤

### 测试场景1：正常二维码使用流程

1. **生成二维码**
   - 使用管家账号生成访客预约二维码
   - 确保二维码包含正确的qrId参数

2. **首次扫码预约**
   - 访客扫描二维码进入预约页面
   - 填写预约信息并提交
   - 验证预约成功后页面跳转到结果页

3. **验证标记功能**
   - 检查本地存储是否有 `qr_used_${qrId}` 标记
   - 检查后端是否收到标记请求

### 测试场景2：二维码重复使用检测

1. **再次扫码**
   - 使用同一个二维码再次进入预约页面
   - 应该立即显示锁定屏幕

2. **验证锁定界面**
   - 确认显示 🚫 图标
   - 确认标题为"二维码已使用"
   - 确认提示信息正确显示
   - 确认"联系管家重新生成"按钮可用

3. **验证功能限制**
   - 确认无法进行新的预约操作
   - 确认表单被完全锁定

### 测试场景3：网络异常情况

1. **断网测试**
   - 在网络断开的情况下使用已使用的二维码
   - 验证本地存储检查是否生效
   - 确认仍然显示锁定界面

2. **后端异常测试**
   - 模拟后端标记接口异常
   - 验证本地标记是否正常工作
   - 确认功能不受后端异常影响

## 技术实现细节

### 新增API端点
```javascript
// config/api.js
qrcode: {
  checkUsed: '/parking/qrcode/checkUsed',  // 检查二维码使用状态
  markUsed: '/parking/qrcode/markUsed'     // 标记二维码为已使用
}
```

### 核心方法

1. **checkQrCodeUsed(qrId)** - 检查二维码是否已使用
2. **markQrCodeAsUsed(qrId)** - 标记二维码为已使用
3. **showQrCodeUsedLock()** - 显示已使用锁定界面

### 本地存储键值
- `qr_used_${qrId}`: 标记二维码是否已使用
- `qr_used_time_${qrId}`: 记录使用时间

## 预期结果

### 正常流程
1. 首次使用二维码可以正常预约
2. 预约成功后二维码被标记为已使用
3. 再次使用显示专门的锁定界面

### 异常处理
1. 网络异常时功能仍然正常工作
2. 后端异常时本地标记保证功能可用
3. 用户体验友好，提供明确的解决方案

## 注意事项

1. **管家用户不受限制** - 管家角色可以绕过二维码检查
2. **调试模式** - 开发时可以启用调试模式跳过检查
3. **数据同步** - 本地和后端状态保持同步
4. **用户引导** - 提供清晰的联系管家指引

## 修复的问题

### CSS编译错误修复
- **问题**: 使用了`:has()`和`:contains()`选择器导致SASS编译失败
- **解决方案**: 改用动态CSS类的方式实现样式切换
- **实现**: 通过`isQrUsed`标识和`:class`绑定实现不同状态的样式

### 样式实现方式
```vue
<!-- 模板中的动态类绑定 -->
<view class="lock-screen" :class="{ 'qr-used': lockScreenConfig.isQrUsed }">
  <view class="lock-content" :class="{ 'qr-used': lockScreenConfig.isQrUsed }">
```

```scss
/* CSS中的状态样式 */
.lock-screen.qr-used {
  background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
}
```

## 后续优化建议

1. 添加二维码过期时间检查
2. 实现二维码使用历史记录
3. 添加管家端查看二维码使用状态功能
4. 优化锁定界面的视觉效果

## 测试验证清单

- [ ] 首次扫码可以正常预约
- [ ] 预约成功后二维码被标记
- [ ] 重复扫码显示锁定界面
- [ ] 锁定界面样式正确（红色主题）
- [ ] 联系管家按钮功能正常
- [ ] 网络异常时功能正常
- [ ] 管家用户不受限制
- [ ] 本地存储正确记录状态
- [ ] 后端API调用正常
- [ ] CSS编译无错误
